<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#F5F0EA">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<title>Ìï† Ïùº</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:'Noto Sans KR',sans-serif;-webkit-tap-highlight-color:transparent}
html,body,#root{height:100%;width:100%;overflow:hidden;background:#F5F0EA}
input,select,button{font-family:'Noto Sans KR',sans-serif}
::-webkit-scrollbar{width:3px}
::-webkit-scrollbar-thumb{background:#D5CEC5;border-radius:4px}
input[type="color"]{-webkit-appearance:none;border:none;cursor:pointer}
input[type="color"]::-webkit-color-swatch-wrapper{padding:2px}
input[type="color"]::-webkit-color-swatch{border-radius:6px;border:2px solid #D5CEC5}
@keyframes fadeUp{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
@keyframes scaleIn{from{opacity:0;transform:scale(0.97)}to{opacity:1;transform:scale(1)}}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes shake{0%,100%{transform:translateX(0)}20%,60%{transform:translateX(-4px)}40%,80%{transform:translateX(4px)}}
@keyframes toastIn{from{opacity:0;transform:translate(-50%,10px)}to{opacity:1;transform:translate(-50%,0)}}
@keyframes toastOut{from{opacity:1;transform:translate(-50%,0)}to{opacity:0;transform:translate(-50%,10px)}}
@keyframes popIn{from{opacity:0;transform:scale(0.95) translateY(-4px)}to{opacity:1;transform:scale(1) translateY(0)}}
@keyframes bannerSlide{from{opacity:0;transform:translateY(-100%)}to{opacity:1;transform:translateY(0)}}
@keyframes bannerPulse{0%,100%{box-shadow:0 4px 20px rgba(200,150,62,0.3)}50%{box-shadow:0 4px 30px rgba(200,150,62,0.6)}}
@keyframes bellRing{0%{transform:rotate(0)}10%{transform:rotate(14deg)}20%{transform:rotate(-14deg)}30%{transform:rotate(10deg)}40%{transform:rotate(-10deg)}50%{transform:rotate(6deg)}60%{transform:rotate(-6deg)}70%{transform:rotate(2deg)}80%{transform:rotate(-2deg)}90%{transform:rotate(0)}100%{transform:rotate(0)}}
</style>
</head>
<body>
<div id="root"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script>
const{useState,useEffect,useCallback,useMemo,useRef,createElement:h}=React;
const DK=["Ïùº","Ïõî","Ìôî","Ïàò","Î™©","Í∏à","ÌÜ†"];
const DTAGS=[{id:"work",name:"ÏóÖÎ¨¥",color:"#3B82F6"},{id:"personal",name:"Í∞úÏù∏",color:"#10B981"},{id:"urgent",name:"Í∏¥Í∏â",color:"#EF4444"}];
const SK={t:"td4-t",a:"td4-a",g:"td4-g",r:"td4-r",noti:"td4-ni",sort:"td4-sort",dt:"td4-dt"};
const NOTI_OPTS=[{v:30,l:'30Î∂Ñ Ï†Ñ'},{v:60,l:'1ÏãúÍ∞Ñ Ï†Ñ'},{v:120,l:'2ÏãúÍ∞Ñ Ï†Ñ'}];
function ld(k,f){try{const v=localStorage.getItem(k);return v?JSON.parse(v):f}catch(e){return f}}
function sv(k,v){try{localStorage.setItem(k,JSON.stringify(v))}catch(e){}}
function fmt(s){const d=new Date(s);return{m:d.getMonth()+1,d:d.getDate(),w:DK[d.getDay()],t:String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0')}}
function todayStr(){const n=new Date();return n.getFullYear()+'. '+String(n.getMonth()+1).padStart(2,'0')+'. '+String(n.getDate()).padStart(2,'0')+'. '+DK[n.getDay()]+'ÏöîÏùº'}
function toDS(d){return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0')}
function daysBetween(a,b){return Math.ceil((b-a)/(864e5))+1}
// ‚òÖ Parse date string as LOCAL time (not UTC) to fix timezone issues
function localDate(s){return new Date(s+'T00:00:00')}
function notiLabel(m){const o=NOTI_OPTS.find(x=>x.v===m);return o?o.l:'30Î∂Ñ Ï†Ñ'}

const C={bg:'#F5F0EA',card:'#FFFFFF',card2:'#FAF7F3',border:'#E8E2DA',border2:'#F0EBE4',text:'#2C2520',text2:'#8C7E72',text3:'#B8AEA2',accent:'#C8963E',accentBg:'#C8963E14',green:'#5A9E6F',greenBg:'#5A9E6F18',red:'#C45C5C'};

function SI(p){return h('svg',{width:p.z||17,height:p.z||17,viewBox:'0 0 24 24',fill:'none',stroke:p.c||C.text3,strokeWidth:2,strokeLinecap:'round',strokeLinejoin:'round'},h('circle',{cx:11,cy:11,r:8}),h('line',{x1:21,y1:21,x2:16.65,y2:16.65}))}
function CalI(p){return h('svg',{width:p.z||17,height:p.z||17,viewBox:'0 0 24 24',fill:'none',stroke:p.c||C.text3,strokeWidth:2,strokeLinecap:'round',strokeLinejoin:'round'},h('rect',{x:3,y:4,width:18,height:18,rx:2}),h('line',{x1:16,y1:2,x2:16,y2:6}),h('line',{x1:8,y1:2,x2:8,y2:6}),h('line',{x1:3,y1:10,x2:21,y2:10}))}
function LstI(p){return h('svg',{width:p.z||17,height:p.z||17,viewBox:'0 0 24 24',fill:'none',stroke:p.c||C.text3,strokeWidth:2,strokeLinecap:'round',strokeLinejoin:'round'},h('line',{x1:8,y1:6,x2:21,y2:6}),h('line',{x1:8,y1:12,x2:21,y2:12}),h('line',{x1:8,y1:18,x2:21,y2:18}),h('line',{x1:3,y1:6,x2:3.01,y2:6}),h('line',{x1:3,y1:12,x2:3.01,y2:12}),h('line',{x1:3,y1:18,x2:3.01,y2:18}))}
function CL(p){return h('svg',{width:p.z||16,height:p.z||16,viewBox:'0 0 24 24',fill:'none',stroke:p.c||C.text3,strokeWidth:2.5,strokeLinecap:'round',strokeLinejoin:'round'},h('polyline',{points:'15 18 9 12 15 6'}))}
function CR(p){return h('svg',{width:p.z||16,height:p.z||16,viewBox:'0 0 24 24',fill:'none',stroke:p.c||C.text3,strokeWidth:2.5,strokeLinecap:'round',strokeLinejoin:'round'},h('polyline',{points:'9 18 15 12 9 6'}))}
function BellI(p){return h('svg',{width:p.z||15,height:p.z||15,viewBox:'0 0 24 24',fill:p.fill||'none',stroke:p.c||C.text3,strokeWidth:2,strokeLinecap:'round',strokeLinejoin:'round'},h('path',{d:'M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9'}),h('path',{d:'M13.73 21a2 2 0 0 1-3.46 0'}))}
function BellOff(p){return h('svg',{width:p.z||15,height:p.z||15,viewBox:'0 0 24 24',fill:'none',stroke:p.c||C.text3,strokeWidth:2,strokeLinecap:'round',strokeLinejoin:'round'},h('path',{d:'M13.73 21a2 2 0 0 1-3.46 0'}),h('path',{d:'M18.63 13A17.89 17.89 0 0 1 18 8'}),h('path',{d:'M6.26 6.26A5.86 5.86 0 0 0 6 8c0 7-3 9-3 9h14'}),h('path',{d:'M18 8a6 6 0 0 0-9.33-5'}),h('line',{x1:1,y1:1,x2:23,y2:23}))}
function UndoI(p){return h('svg',{width:p.z||14,height:p.z||14,viewBox:'0 0 24 24',fill:'none',stroke:p.c||C.text3,strokeWidth:2,strokeLinecap:'round',strokeLinejoin:'round'},h('polyline',{points:'1 4 1 10 7 10'}),h('path',{d:'M3.51 15a9 9 0 1 0 2.13-9.36L1 10'}))}
function DlI(p){return h('svg',{width:p.z||14,height:p.z||14,viewBox:'0 0 24 24',fill:'none',stroke:p.c||C.text3,strokeWidth:2,strokeLinecap:'round',strokeLinejoin:'round'},h('path',{d:'M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4'}),h('polyline',{points:'7 10 12 15 17 10'}),h('line',{x1:12,y1:15,x2:12,y2:3}))}
function UlI(p){return h('svg',{width:p.z||14,height:p.z||14,viewBox:'0 0 24 24',fill:'none',stroke:p.c||C.text3,strokeWidth:2,strokeLinecap:'round',strokeLinejoin:'round'},h('path',{d:'M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4'}),h('polyline',{points:'17 8 12 3 7 8'}),h('line',{x1:12,y1:3,x2:12,y2:15}))}
// ‚òÖ NEW: Sort icon
function SortI(p){return h('svg',{width:p.z||17,height:p.z||17,viewBox:'0 0 24 24',fill:'none',stroke:p.c||C.text3,strokeWidth:2,strokeLinecap:'round',strokeLinejoin:'round'},h('line',{x1:4,y1:6,x2:13,y2:6}),h('line',{x1:4,y1:12,x2:10,y2:12}),h('line',{x1:4,y1:18,x2:7,y2:18}),h('polyline',{points:'18 9 21 6 18 3'}),h('line',{x1:21,y1:6,x2:21,y2:21}))}

function App(){
  const[todos,setTodos]=useState(()=>ld(SK.t,[]));
  const[archive,setArchive]=useState(()=>ld(SK.a,[]));
  const[tags,setTags]=useState(()=>ld(SK.g,DTAGS));
  const[records,setRecords]=useState(()=>ld(SK.r,[]));
  const[tab,setTab]=useState('current');
  const[showAdd,setShowAdd]=useState(false);
  const[addMode,setAddMode]=useState('todo');
  const[fadingOut,setFadingOut]=useState(new Set());
  const[nT,sNT]=useState('');const[nD,sND]=useState('');const[nTi,sNTi]=useState('');const[nTg,sNTg]=useState('');
  const[nNotiOn,sNNotiOn]=useState(true);const[nNotiBefore,sNNotiBefore]=useState(30);
  const[nNotiAtD,sNNotiAtD]=useState('');const[nNotiAtT,sNNotiAtT]=useState('');
  const[rT,sRT]=useState('');const[rSD,sRSD]=useState('');const[rED,sRED]=useState('');const[rTg,sRTg]=useState('');
  const[showSearch,setShowSearch]=useState(false);const[sq,sSq]=useState('');
  const[nTgN,sNTgN]=useState('');const[nTgC,sNTgC]=useState('#6366F1');
  const[editTodo,setEditTodo]=useState(null);
  const[eT,sET]=useState('');const[eD,sED]=useState('');const[eTi,sETi]=useState('');const[eTg,sETg]=useState('');
  const[eNotiOn,sENotiOn]=useState(true);const[eNotiBefore,sENotiBefore]=useState(30);
  const[eNotiAtD,sENotiAtD]=useState('');const[eNotiAtT,sENotiAtT]=useState('');
  const[editRec,setEditRec]=useState(null);
  const[erT,sERT]=useState('');const[erSD,sERSD]=useState('');const[erED,sERED]=useState('');const[erTg,sERTg]=useState('');
  const[vm,setVm]=useState('list');
  const[cm,setCm]=useState(()=>{const n=new Date();return{y:n.getFullYear(),m:n.getMonth()}});
  const[notiPerm,setNotiPerm]=useState(typeof Notification!=='undefined'?Notification.permission:'denied');
  const notifiedRef=useRef(ld(SK.noti,[]));
  const[confirm,setConfirm]=useState(null);
  const[toast,setToast]=useState(null);
  const toastTimer=useRef(null);
  const[isWide,setIsWide]=useState(window.innerWidth>=580);
  // ‚òÖ NEW: Sort mode & dropdown
  const[sortMode,setSortMode]=useState(()=>ld(SK.sort,'date'));
  const[showSortMenu,setShowSortMenu]=useState(false);
  const sortRef=useRef(null);
  // ‚òÖ Daily tasks (Ïò§Îäò Ìï† Ïùº)
  const[dailyTasks,setDailyTasks]=useState(()=>ld(SK.dt,[]));
  const[dtInput,setDtInput]=useState('');
  const[showDtSection,setShowDtSection]=useState(true);
  const[showYesterdayPrompt,setShowYesterdayPrompt]=useState(false);
  const[yesterdayItems,setYesterdayItems]=useState([]);

  useEffect(()=>{
    const onResize=()=>{setIsWide(window.innerWidth>=580)};
    window.addEventListener('resize',onResize);
    const onOrient=()=>setTimeout(onResize,300);
    window.addEventListener('orientationchange',onOrient);
    let screenOrient=null;
    if(window.screen?.orientation){
      screenOrient=window.screen.orientation;
      screenOrient.addEventListener('change',onOrient);
    }
    return()=>{
      window.removeEventListener('resize',onResize);
      window.removeEventListener('orientationchange',onOrient);
      if(screenOrient)screenOrient.removeEventListener('change',onOrient);
    };
  },[]);

  // Close sort menu on outside click
  useEffect(()=>{
    if(!showSortMenu)return;
    const handler=e=>{if(sortRef.current&&!sortRef.current.contains(e.target))setShowSortMenu(false)};
    document.addEventListener('pointerdown',handler);
    return()=>document.removeEventListener('pointerdown',handler);
  },[showSortMenu]);

  const changeSortMode=mode=>{setSortMode(mode);sv(SK.sort,mode);setShowSortMenu(false)};

  const showToast=(msg,duration)=>{
    if(toastTimer.current)clearTimeout(toastTimer.current);
    setToast({msg,out:false});
    toastTimer.current=setTimeout(()=>{
      setToast(p=>p?{...p,out:true}:null);
      setTimeout(()=>setToast(null),250);
    },duration||2000);
  };

  const sT=useCallback(t=>{setTodos(t);sv(SK.t,t);setTimeout(()=>{if(typeof syncNotificationsToSW==='function')syncNotificationsToSW()},500)},[]);
  const sA=useCallback(a=>{setArchive(a);sv(SK.a,a)},[]);
  const sTg=useCallback(t=>{setTags(t);sv(SK.g,t)},[]);
  const sR=useCallback(r=>{setRecords(r);sv(SK.r,r)},[]);
  const gT=id=>tags.find(t=>t.id===id);

  const askConfirm=(title,msg,onOk,okLabel,okColor)=>{
    setConfirm({title,msg,onOk:()=>{onOk();setConfirm(null)},onCancel:()=>setConfirm(null),okLabel:okLabel||'ÏÇ≠Ï†ú',okColor:okColor||C.red});
  };

  // ‚ïê‚ïê‚ïê NOTIFICATION SOUND & VIBRATION ‚ïê‚ïê‚ïê
  const[soundOn,setSoundOn]=useState(()=>ld('td4-snd',true));
  const[vibrateOn,setVibrateOn]=useState(()=>ld('td4-vib',true));
  const[notiAlert,setNotiAlert]=useState(null);
  const notiAlertTimer=useRef(null);
  const alarmLoopRef=useRef(null);
  const audioCtxRef=useRef(null);

  const toggleSound=v=>{setSoundOn(v);sv('td4-snd',v)};
  const toggleVibrate=v=>{setVibrateOn(v);sv('td4-vib',v)};

  const getAudioCtx=()=>{
    if(!audioCtxRef.current){
      const AC=window.AudioContext||window.webkitAudioContext;
      if(AC)audioCtxRef.current=new AC();
    }
    return audioCtxRef.current;
  };

  // Play one chime
  const playChimeOnce=()=>{
    try{
      const ctx=getAudioCtx();
      if(!ctx)return;
      if(ctx.state==='suspended')ctx.resume();
      const now=ctx.currentTime;
      const notes=[880,1108.73,1318.51];
      notes.forEach((freq,i)=>{
        const osc=ctx.createOscillator();
        const gain=ctx.createGain();
        osc.type='sine';
        osc.frequency.setValueAtTime(freq,now+i*0.12);
        gain.gain.setValueAtTime(0,now+i*0.12);
        gain.gain.linearRampToValueAtTime(0.25,now+i*0.12+0.03);
        gain.gain.exponentialRampToValueAtTime(0.001,now+i*0.12+0.5);
        osc.connect(gain);gain.connect(ctx.destination);
        osc.start(now+i*0.12);osc.stop(now+i*0.12+0.55);
      });
      setTimeout(()=>{
        const now2=ctx.currentTime;
        notes.forEach((freq,i)=>{
          const osc=ctx.createOscillator();
          const gain=ctx.createGain();
          osc.type='sine';
          osc.frequency.setValueAtTime(freq,now2+i*0.1);
          gain.gain.setValueAtTime(0,now2+i*0.1);
          gain.gain.linearRampToValueAtTime(0.2,now2+i*0.1+0.03);
          gain.gain.exponentialRampToValueAtTime(0.001,now2+i*0.1+0.4);
          osc.connect(gain);gain.connect(ctx.destination);
          osc.start(now2+i*0.1);osc.stop(now2+i*0.1+0.45);
        });
      },600);
    }catch(e){}
  };

  const playNotiSound=()=>{if(soundOn)playChimeOnce()};
  const vibratePhone=()=>{
    if(!vibrateOn)return;
    try{if(navigator.vibrate)navigator.vibrate([300,150,300,150,400])}catch(e){}
  };
  const stopAlarmLoop=()=>{
    if(alarmLoopRef.current){clearInterval(alarmLoopRef.current);alarmLoopRef.current=null}
    try{if(navigator.vibrate)navigator.vibrate(0)}catch(e){}
  };

  // ‚òÖ Start persistent alarm loop (repeats until stopped)
  const startAlarmLoop=()=>{
    stopAlarmLoop();
    // Play once immediately
    if(soundOn)playChimeOnce();
    if(vibrateOn)try{navigator.vibrate&&navigator.vibrate([300,150,300,150,400])}catch(e){}
    // Repeat every 3.5 seconds
    alarmLoopRef.current=setInterval(()=>{
      if(soundOn)playChimeOnce();
      if(vibrateOn)try{navigator.vibrate&&navigator.vibrate([300,150,300,150,400])}catch(e){}
    },3500);
    // Safety: stop after 60 seconds max
    setTimeout(()=>stopAlarmLoop(),60000);
  };

  const showNotiAlert=(title,body,color)=>{
    if(notiAlertTimer.current)clearTimeout(notiAlertTimer.current);
    setNotiAlert({title,body,color,out:false});
    // Start alarm loop (keeps ringing until dismissed)
    startAlarmLoop();
    // Auto-stop after 60 seconds
    notiAlertTimer.current=setTimeout(()=>{
      dismissNotiAlert();
    },60000);
  };

  const dismissNotiAlert=()=>{
    stopAlarmLoop();
    setNotiAlert(p=>p?{...p,out:true}:null);
    setTimeout(()=>setNotiAlert(null),300);
    if(notiAlertTimer.current){clearTimeout(notiAlertTimer.current);notiAlertTimer.current=null}
  };

  // Initialize audio context on first user interaction (required by browsers)
  useEffect(()=>{
    const initAudio=()=>{getAudioCtx();document.removeEventListener('touchstart',initAudio);document.removeEventListener('click',initAudio)};
    document.addEventListener('touchstart',initAudio,{once:true});
    document.addEventListener('click',initAudio,{once:true});
    return()=>{document.removeEventListener('touchstart',initAudio);document.removeEventListener('click',initAudio)};
  },[]);

  // ‚ïê‚ïê‚ïê NOTIFICATIONS ‚ïê‚ïê‚ïê
  const requestNoti=()=>{
    if(typeof Notification==='undefined')return;
    Notification.requestPermission().then(p=>{setNotiPerm(p)});
  };
  useEffect(()=>{
    const iv=setInterval(()=>{
      const now=Date.now();
      todos.forEach(todo=>{
        if(!todo.notiOn)return;
        // ‚òÖ Calculate alertTime: notiAt (custom time) takes priority over notiBefore
        let alertTime,notiKey;
        if(todo.notiAt){
          alertTime=new Date(todo.notiAt).getTime();
          notiKey=todo.id+'_at_'+todo.notiAt;
        }else{
          const dt=new Date(todo.datetime).getTime();
          const beforeMs=(todo.notiBefore||30)*60000;
          alertTime=dt-beforeMs;
          notiKey=todo.id+'_'+todo.notiBefore;
        }
        const diff=alertTime-now;
        if(diff>=-15000&&diff<=15000&&!notifiedRef.current.includes(notiKey)){
          notifiedRef.current=[...notifiedRef.current,notiKey];
          sv(SK.noti,notifiedRef.current);
          const tg=tags.find(t=>t.id===todo.tagId);
          const lbl=todo.notiAt?'ÏïåÎ¶º':notiLabel(todo.notiBefore||30);
          const bodyText=todo.title+(tg?' ['+tg.name+']':'');
          const tgColor=tg?tg.color:C.accent;

          // 1+2) Persistent alarm (sound+vibrate loop via showNotiAlert)
          showNotiAlert(lbl,bodyText,tgColor);
          // 3) System notification via Service Worker
          if(notiPerm==='granted'){
            try{
              if(typeof swRegistration!=='undefined'&&swRegistration&&swRegistration.active){
                swRegistration.showNotification(lbl,{body:bodyText,icon:'./icon-192.png',badge:'./icon-192.png',vibrate:[300,150,300,150,400],tag:notiKey,requireInteraction:true,actions:[{action:'confirm',title:'‚úì ÌôïÏù∏'},{action:'dismiss',title:'Îã´Í∏∞'}]});
              }else{
                new Notification(lbl,{body:bodyText,vibrate:[300,150,300,150,400],tag:notiKey,requireInteraction:true});
              }
            }catch(e){}
          }
          setTimeout(()=>{if(typeof syncNotificationsToSW==='function')syncNotificationsToSW()},1000);
        }
      });
    },5000);
    return()=>clearInterval(iv);
  },[todos,tags,notiPerm,soundOn,vibrateOn]);
  useEffect(()=>{
    const ids=new Set(todos.map(t=>t.id));
    const cleaned=notifiedRef.current.filter(k=>ids.has(k.split('_')[0]));
    if(cleaned.length!==notifiedRef.current.length){notifiedRef.current=cleaned;sv(SK.noti,cleaned)}
  },[todos]);

  // ‚ïê‚ïê‚ïê CORE DATE REFERENCES ‚ïê‚ïê‚ïê
  const td=new Date();
  const todayDS=toDS(td);

  // ‚ïê‚ïê‚ïê CRUD ‚ïê‚ïê‚ïê
  const addTodo=()=>{
    if(!nT.trim())return;
    const dt=nD&&nTi?nD+'T'+nTi:nD?nD+'T00:00':new Date().toISOString();
    const notiAt=(nNotiBefore==='custom'&&nNotiAtD&&nNotiAtT)?nNotiAtD+'T'+nNotiAtT:null;
    sT([...todos,{id:Date.now().toString(),title:nT.trim(),datetime:dt,tagId:nTg||null,notiOn:nNotiOn,notiBefore:nNotiBefore==='custom'?null:nNotiBefore,notiAt:notiAt,createdAt:new Date().toISOString()}].sort((a,b)=>new Date(a.datetime)-new Date(b.datetime)));
    sNT('');sND('');sNTi('');sNTg('');sNNotiOn(true);sNNotiBefore(30);sNNotiAtD('');sNNotiAtT('');setShowAdd(false);
  };
  const completeTodo=id=>{
    setFadingOut(p=>new Set([...p,id]));
    setTimeout(()=>{
      const t=todos.find(x=>x.id===id);
      if(t){sA([{...t,completedAt:new Date().toISOString()},...archive]);sT(todos.filter(x=>x.id!==id))}
      setFadingOut(p=>{const n=new Set(p);n.delete(id);return n});
      showToast('‚úì ÏôÑÎ£å Ï≤òÎ¶¨Îê®');
    },350);
  };
  const restoreTodo=todo=>{
    if(todo.isDailyTask){
      // Restore to daily tasks (today)
      sDT([...dailyTasks,{id:Date.now().toString(),title:todo.title,done:false,date:todayDS}]);
      sA(archive.filter(x=>x.id!==todo.id||(x.completedAt!==todo.completedAt)));
      showToast('‚Ü© Ïò§Îäò Ìï† ÏùºÎ°ú Î≥µÍµ¨Îê®');
    }else{
      const restored={...todo};delete restored.completedAt;
      sT([...todos,restored].sort((a,b)=>new Date(a.datetime)-new Date(b.datetime)));
      sA(archive.filter(x=>x.id!==todo.id||(x.completedAt!==todo.completedAt)));
      showToast('‚Ü© Ìï† ÏùºÎ°ú Î≥µÍµ¨Îê®');
    }
  };
  const openEdit=(todo,e)=>{
    if(e)e.stopPropagation();const d=new Date(todo.datetime);
    setEditTodo(todo);sET(todo.title);sED(toDS(d));
    sETi(String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0'));
    sETg(todo.tagId||'');sENotiOn(todo.notiOn!==false);
    if(todo.notiAt){
      sENotiBefore('custom');
      const nad=new Date(todo.notiAt);
      sENotiAtD(toDS(nad));
      sENotiAtT(String(nad.getHours()).padStart(2,'0')+':'+String(nad.getMinutes()).padStart(2,'0'));
    }else{
      sENotiBefore(todo.notiBefore||30);sENotiAtD('');sENotiAtT('');
    }
  };
  const saveEdit=()=>{
    if(!editTodo||!eT.trim())return;
    const dt=eD&&eTi?eD+'T'+eTi:eD?eD+'T00:00':editTodo.datetime;
    const notiAt=(eNotiBefore==='custom'&&eNotiAtD&&eNotiAtT)?eNotiAtD+'T'+eNotiAtT:null;
    // Clear old notified key so new alarm can fire
    const oldKeys=notifiedRef.current.filter(k=>k.startsWith(editTodo.id+'_'));
    if(oldKeys.length>0){notifiedRef.current=notifiedRef.current.filter(k=>!k.startsWith(editTodo.id+'_'));sv(SK.noti,notifiedRef.current)}
    sT(todos.map(t=>t.id===editTodo.id?{...t,title:eT.trim(),datetime:dt,tagId:eTg||null,notiOn:eNotiOn,notiBefore:eNotiBefore==='custom'?null:eNotiBefore,notiAt:notiAt}:t).sort((a,b)=>new Date(a.datetime)-new Date(b.datetime)));
    setEditTodo(null);showToast('‚úì ÏàòÏ†ï ÏôÑÎ£å');
  };
  const delEdit=()=>{
    if(!editTodo)return;
    askConfirm('Ìï† Ïùº ÏÇ≠Ï†ú','"'+editTodo.title+'"ÏùÑ(Î•º) ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\nÏÇ≠Ï†ú ÌõÑ Î≥µÍµ¨Ìï† Ïàò ÏóÜÏäµÎãàÎã§.',()=>{
      sT(todos.filter(t=>t.id!==editTodo.id));setEditTodo(null);showToast('üóë ÏÇ≠Ï†úÎê®');
    });
  };

  const addRecord=()=>{if(!rT.trim()||!rSD||!rED)return;sR([...records,{id:Date.now().toString(),title:rT.trim(),startDate:rSD,endDate:rED,tagId:rTg||null,createdAt:new Date().toISOString()}].sort((a,b)=>new Date(a.startDate)-new Date(b.startDate)));sRT('');sRSD('');sRED('');sRTg('');setShowAdd(false)};
  const openEditRec=(rec,e)=>{if(e)e.stopPropagation();setEditRec(rec);sERT(rec.title);sERSD(rec.startDate);sERED(rec.endDate);sERTg(rec.tagId||'')};
  const saveEditRec=()=>{if(!editRec||!erT.trim()||!erSD||!erED)return;sR(records.map(r=>r.id===editRec.id?{...r,title:erT.trim(),startDate:erSD,endDate:erED,tagId:erTg||null}:r).sort((a,b)=>new Date(a.startDate)-new Date(b.startDate)));setEditRec(null);showToast('‚úì ÏàòÏ†ï ÏôÑÎ£å')};
  const delEditRec=()=>{
    if(!editRec)return;
    askConfirm('Í∏∞Î°ù ÏÇ≠Ï†ú','"'+editRec.title+'"ÏùÑ(Î•º) ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\nÏÇ≠Ï†ú ÌõÑ Î≥µÍµ¨Ìï† Ïàò ÏóÜÏäµÎãàÎã§.',()=>{
      sR(records.filter(r=>r.id!==editRec.id));setEditRec(null);showToast('üóë ÏÇ≠Ï†úÎê®');
    });
  };

  const addTag=()=>{if(!nTgN.trim())return;sTg([...tags,{id:Date.now().toString(),name:nTgN.trim(),color:nTgC}]);sNTgN('');sNTgC('#6366F1')};
  const delTag=id=>{
    const tg=tags.find(t=>t.id===id);
    askConfirm('ÌÉúÍ∑∏ ÏÇ≠Ï†ú','"'+(tg?tg.name:'')+'" ÌÉúÍ∑∏Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?',()=>{
      sTg(tags.filter(t=>t.id!==id));showToast('üóë ÌÉúÍ∑∏ ÏÇ≠Ï†úÎê®');
    });
  };

  // ‚ïê‚ïê‚ïê DAILY TASKS (Ïò§Îäò Ìï† Ïùº) ‚ïê‚ïê‚ïê
  const sDT=useCallback(dt=>{setDailyTasks(dt);sv(SK.dt,dt)},[]);
  const todayDT=dailyTasks.filter(d=>d.date===todayDS);
  const todayDTTotal=todayDT.length;

  const addDailyTask=()=>{
    if(!dtInput.trim())return;
    sDT([...dailyTasks,{id:Date.now().toString(),title:dtInput.trim(),done:false,date:todayDS}]);
    setDtInput('');
  };
  const completeDailyTask=id=>{
    const item=dailyTasks.find(d=>d.id===id);
    if(!item)return;
    // Add to archive with [Ïò§ÎäòÏùò Ìï†Ïùº] marker
    sA([{id:'dt_'+item.id,title:item.title,datetime:new Date().toISOString(),completedAt:new Date().toISOString(),isDailyTask:true,tagId:null},...archive]);
    // Remove from daily tasks
    sDT(dailyTasks.filter(d=>d.id!==id));
    showToast('‚úì ÏôÑÎ£å ‚Üí Í≥ºÍ±∞ ÌÉ≠ÏúºÎ°ú Ïù¥Îèô');
  };
  const delDailyTask=id=>sDT(dailyTasks.filter(d=>d.id!==id));
  const moveToTomorrow=(items)=>{
    const tmrw=new Date(td);tmrw.setDate(tmrw.getDate()+1);const tmrwDS=toDS(tmrw);
    sDT(dailyTasks.map(d=>items.find(i=>i.id===d.id)?{...d,date:tmrwDS,done:false}:d));
    setShowYesterdayPrompt(false);
    showToast('‚Üí '+items.length+'Í∞úÎ•º ÎÇ¥ÏùºÎ°ú ÏòÆÍ≤ºÏäµÎãàÎã§');
  };
  const moveBackToToday=(items)=>{
    sDT(dailyTasks.map(d=>items.find(i=>i.id===d.id)?{...d,date:todayDS,done:false}:d));
    showToast('‚Üê '+items.length+'Í∞úÎ•º Ïò§ÎäòÎ°ú ÎêòÎèåÎ†∏ÏäµÎãàÎã§');
  };
  const moveAllToToday=()=>{
    sDT(dailyTasks.map(d=>yesterdayItems.find(i=>i.id===d.id)?{...d,date:todayDS,done:false}:d));
    setShowYesterdayPrompt(false);
    showToast('‚Üí '+yesterdayItems.length+'Í∞úÎ•º Ïò§ÎäòÎ°ú ÏòÆÍ≤ºÏäµÎãàÎã§');
  };

  // Detect yesterday's uncompleted items on load
  useEffect(()=>{
    const yest=new Date(td);yest.setDate(yest.getDate()-1);const yDS=toDS(yest);
    const yItems=dailyTasks.filter(d=>d.date===yDS&&!d.done);
    if(yItems.length>0){setYesterdayItems(yItems);setShowYesterdayPrompt(true)}
    // Clean old items (>7 days)
    const wa=new Date(td);wa.setDate(wa.getDate()-7);const wDS=toDS(wa);
    const cleaned=dailyTasks.filter(d=>d.date>=wDS);
    if(cleaned.length!==dailyTasks.length)sDT(cleaned);
  },[]);

  const exportData=()=>{
    const data={todos,archive,tags,records,dailyTasks,exportedAt:new Date().toISOString(),version:'4.2'};
    const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;a.download='todo-backup-'+toDS(new Date())+'.json';
    document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);
    showToast('üì¶ Î∞±ÏóÖ ÌååÏùº Ï†ÄÏû•Îê®');
  };
  const fileInputRef=useRef(null);
  const importData=()=>{fileInputRef.current&&fileInputRef.current.click()};
  const handleImport=e=>{
    const file=e.target.files[0];if(!file)return;
    const reader=new FileReader();
    reader.onload=ev=>{
      try{
        const data=JSON.parse(ev.target.result);
        if(!data.todos&&!data.archive&&!data.records){showToast('‚ö† Ïò¨Î∞îÎ•∏ Î∞±ÏóÖ ÌååÏùºÏù¥ ÏïÑÎãôÎãàÎã§');return}
        askConfirm('Îç∞Ïù¥ÌÑ∞ Î≥µÏõê','Î∞±ÏóÖ ÌååÏùºÏóêÏÑú Îç∞Ïù¥ÌÑ∞Î•º Î≥µÏõêÌïòÏãúÍ≤†ÏäµÎãàÍπå?\nÌòÑÏû¨ Îç∞Ïù¥ÌÑ∞Í∞Ä Î™®Îëê ÍµêÏ≤¥Îê©ÎãàÎã§.',()=>{
          if(data.todos){sT(data.todos)}
          if(data.archive){sA(data.archive)}
          if(data.tags){sTg(data.tags)}
          if(data.records){sR(data.records)}
          if(data.dailyTasks){sDT(data.dailyTasks)}
          showToast('‚úì Îç∞Ïù¥ÌÑ∞ Î≥µÏõê ÏôÑÎ£å!');
        },'Î≥µÏõê',C.accent);
      }catch(err){showToast('‚ö† ÌååÏùºÏùÑ ÏùΩÏùÑ Ïàò ÏóÜÏäµÎãàÎã§')}
    };
    reader.readAsText(file);
    e.target.value='';
  };
  const clearAllData=()=>{
    askConfirm('Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú','Î™®Îì† Ìï† Ïùº, Í∏∞Î°ù, ÏôÑÎ£å ÎÇ¥Ïó≠, ÌÉúÍ∑∏Î•º\nÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\n‚ö† Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.\nÎ®ºÏ†Ä Î∞±ÏóÖÏùÑ Í∂åÏû•Ìï©ÎãàÎã§.',()=>{
      sT([]);sA([]);sR([]);sTg(DTAGS);sDT([]);showToast('üóë Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†úÎê®');
    },'Ï†ÑÏ≤¥ ÏÇ≠Ï†ú');
  };

  // Search
  const sf=i=>{if(!sq.trim())return true;const q=sq.toLowerCase(),tg=gT(i.tagId);return i.title.toLowerCase().includes(q)||(tg&&tg.name.toLowerCase().includes(q))};
  const sTo=todos.filter(sf),sAr=archive.filter(sf),sRc=records.filter(sf);
  const hl=(t,q)=>{if(!q.trim())return t;const i=t.toLowerCase().indexOf(q.toLowerCase());if(i===-1)return t;return h('span',null,t.slice(0,i),h('span',{style:{color:C.accent,fontWeight:700}},t.slice(i,i+q.length)),t.slice(i+q.length))};

  // ‚ïê‚ïê‚ïê TODAY & ACTIVE/PAST RECORDS ‚ïê‚ïê‚ïê
  const todayStart=new Date(td.getFullYear(),td.getMonth(),td.getDate());
  const activeRecords=records.filter(r=>new Date(r.endDate+'T23:59:59')>=todayStart);
  const pastRecords=records.filter(r=>new Date(r.endDate+'T23:59:59')<todayStart);

  // ‚ïê‚ïê‚ïê ‚òÖ UNIFIED SORTED LIST (todos + activeRecords mixed) ‚ïê‚ïê‚ïê
  const unifiedList=useMemo(()=>{
    // Wrap items with a type marker and sortable date
    const items=[];
    todos.forEach(t=>items.push({type:'todo',data:t,sortDate:new Date(t.datetime),title:t.title}));
    activeRecords.forEach(r=>items.push({type:'record',data:r,sortDate:localDate(r.startDate),title:r.title}));

    if(sortMode==='date'){
      items.sort((a,b)=>a.sortDate-b.sortDate);
    }else if(sortMode==='name'){
      items.sort((a,b)=>a.title.localeCompare(b.title,'ko'));
    }else if(sortMode==='type'){
      // Records first, then todos ‚Äî within each group, sort by date
      items.sort((a,b)=>{
        if(a.type!==b.type) return a.type==='record'?-1:1;
        return a.sortDate-b.sortDate;
      });
    }
    return items;
  },[todos,activeRecords,sortMode]);

  const sortLabel=sortMode==='date'?'ÎÇ†ÏßúÏàú':sortMode==='name'?'Ïù¥Î¶ÑÏàú':'Íµ¨Î∂ÑÏàú';

  // ‚ïê‚ïê‚ïê CALENDAR ‚ïê‚ïê‚ïê
  const weeks=useMemo(()=>{
    const first=new Date(cm.y,cm.m,1),ld2=new Date(cm.y,cm.m+1,0).getDate(),sd=first.getDay();
    const rows=[];let row=[];
    for(let i=0;i<sd;i++)row.push(null);
    for(let d=1;d<=ld2;d++){row.push(d);if(row.length===7){rows.push(row);row=[]}}
    if(row.length>0){while(row.length<7)row.push(null);rows.push(row)}
    return rows;
  },[cm]);
  const tfd=useMemo(()=>{
    const mp={};todos.forEach(t=>{const d=new Date(t.datetime);if(d.getFullYear()===cm.y&&d.getMonth()===cm.m){const dy=d.getDate();if(!mp[dy])mp[dy]=[];mp[dy].push(t)}});return mp;
  },[todos,cm]);
  const recForMonth=useMemo(()=>records.filter(r=>{const s=localDate(r.startDate),e=localDate(r.endDate),mS=new Date(cm.y,cm.m,1),mE=new Date(cm.y,cm.m+1,0);return s<=mE&&e>=mS}),[records,cm]);
  const recBars=useMemo(()=>{
    const bars=[];
    recForMonth.forEach(rec=>{
      const tg=gT(rec.tagId);const color=tg?tg.color:'#8B6CC1';
      const rs=localDate(rec.startDate),re=localDate(rec.endDate);
      weeks.forEach((week,wi)=>{
        const weekDays=week.map((d,ci)=>d?new Date(cm.y,cm.m,d):null);
        let sc=-1,ec=-1;
        for(let ci=0;ci<7;ci++){if(!weekDays[ci])continue;const wd=weekDays[ci];if(wd>=rs&&wd<=re){if(sc===-1)sc=ci;ec=ci}}
        if(sc!==-1){
          const isS=week[sc]&&new Date(cm.y,cm.m,week[sc]).getTime()===new Date(rs.getFullYear(),rs.getMonth(),rs.getDate()).getTime();
          const isE=week[ec]&&new Date(cm.y,cm.m,week[ec]).getTime()===new Date(re.getFullYear(),re.getMonth(),re.getDate()).getTime();
          bars.push({rec,wi,startCol:sc,endCol:ec,color,isStart:isS,isEnd:isE,title:rec.title});
        }
      });
    });return bars;
  },[recForMonth,weeks,cm,tags]);

  const isT=d=>d&&cm.y===td.getFullYear()&&cm.m===td.getMonth()&&d===td.getDate();
  const pM=()=>setCm(p=>p.m===0?{y:p.y-1,m:11}:{y:p.y,m:p.m-1});
  const nM=()=>setCm(p=>p.m===11?{y:p.y+1,m:0}:{y:p.y,m:p.m+1});
  const goTd=()=>setCm({y:td.getFullYear(),m:td.getMonth()});

  // ‚ïê‚ïê‚ïê Notification row ‚ïê‚ïê‚ïê
  const notiRow=(on,setOn,before,setBefore,atD,setAtD,atT,setAtT)=>
    h('div',{style:{marginBottom:7,padding:'6px 0'}},
      h('div',{style:{display:'flex',alignItems:'center',gap:6,flexWrap:'wrap'}},
        h('button',{onClick:()=>setOn(!on),style:{display:'flex',alignItems:'center',gap:4,background:on?C.accent+'15':'transparent',border:'1px solid '+(on?C.accent+'40':C.border),borderRadius:20,padding:'4px 10px',cursor:'pointer'}},
          on?BellI({z:13,c:C.accent}):BellOff({z:13,c:C.text3}),
          h('span',{style:{fontSize:11,fontWeight:600,color:on?C.accent:C.text3}},on?'ÏïåÎ¶º ON':'ÏïåÎ¶º OFF')
        ),
        on?h('div',{style:{display:'flex',gap:3,flexWrap:'wrap'}},
          ...[{v:30,l:'30Î∂Ñ Ï†Ñ'},{v:60,l:'1ÏãúÍ∞Ñ Ï†Ñ'}].map(o=>h('button',{key:o.v,onClick:()=>setBefore(o.v),style:{
            padding:'4px 8px',borderRadius:14,border:'1px solid '+(before===o.v?C.accent+'50':C.border),
            background:before===o.v?C.accent+'18':'transparent',color:before===o.v?C.accent:C.text3,
            fontSize:10,fontWeight:before===o.v?700:500,cursor:'pointer'
          }},o.l)),
          h('button',{onClick:()=>setBefore('custom'),style:{
            padding:'4px 8px',borderRadius:14,border:'1px solid '+(before==='custom'?C.accent+'50':C.border),
            background:before==='custom'?C.accent+'18':'transparent',color:before==='custom'?C.accent:C.text3,
            fontSize:10,fontWeight:before==='custom'?700:500,cursor:'pointer'
          }},'ÏßÅÏ†ë ÏûÖÎ†•')
        ):null
      ),
      on&&before==='custom'?h('div',{style:{display:'flex',gap:6,marginTop:6}},
        h('input',{type:'date',value:atD||'',onChange:e=>setAtD(e.target.value),style:{...S.input,flex:1,marginBottom:0,fontSize:12,padding:'6px 8px'}}),
        h('input',{type:'time',value:atT||'',onChange:e=>setAtT(e.target.value),style:{...S.input,flex:1,marginBottom:0,fontSize:12,padding:'6px 8px'}}),
      ):null
    );

  // ‚òÖ Confirm dialog
  const confirmDialog=confirm?h('div',{style:S.overlay,onClick:()=>setConfirm(null)},
    h('div',{style:{...S.modal,borderRadius:16,animation:'scaleIn 0.15s ease',maxWidth:340,margin:'auto'},onClick:e=>e.stopPropagation()},
      h('div',{style:{fontSize:15,fontWeight:700,color:C.text,marginBottom:8}},confirm.title),
      h('div',{style:{fontSize:13,color:C.text2,marginBottom:18,whiteSpace:'pre-line',lineHeight:'1.5'}},confirm.msg),
      h('div',{style:{display:'flex',gap:8}},
        h('button',{onClick:confirm.onCancel,style:{flex:1,padding:'10px',background:C.bg,color:C.text2,border:'1px solid '+C.border,borderRadius:8,fontSize:13,fontWeight:600,cursor:'pointer'}},'Ï∑®ÏÜå'),
        h('button',{onClick:confirm.onOk,style:{flex:1,padding:'10px',background:confirm.okColor||C.red,color:'#FFF',border:'none',borderRadius:8,fontSize:13,fontWeight:600,cursor:'pointer'}},confirm.okLabel||'ÏÇ≠Ï†ú')
      )
    )
  ):null;

  // ‚òÖ Toast
  const toastEl=toast?h('div',{style:{
    position:'fixed',bottom:90,left:'50%',transform:'translate(-50%,0)',
    background:C.text,color:'#FFF',padding:'10px 20px',borderRadius:24,
    fontSize:13,fontWeight:500,zIndex:200,boxShadow:'0 4px 16px rgba(0,0,0,0.18)',
    animation:(toast.out?'toastOut':'toastIn')+' 0.25s ease forwards',
    pointerEvents:'none',whiteSpace:'nowrap'
  }},toast.msg):null;

  // ‚òÖ In-app notification alert banner with confirm button
  const notiAlertEl=notiAlert?h('div',{style:{
    position:'fixed',top:0,left:0,right:0,zIndex:300,padding:'max(env(safe-area-inset-top,10px),36px) 12px 12px',
    background:'linear-gradient(135deg,'+C.accent+' 0%,#D4A84A 100%)',
    color:'#FFF',boxShadow:'0 6px 24px rgba(200,150,62,0.4)',
    animation:notiAlert.out?'fadeUp 0.3s ease reverse forwards':'bannerSlide 0.35s cubic-bezier(0.2,0.8,0.3,1)',
  }},
    h('div',{style:{display:'flex',alignItems:'center',gap:10,marginBottom:10}},
      h('div',{style:{width:36,height:36,borderRadius:'50%',background:'rgba(255,255,255,0.25)',display:'flex',alignItems:'center',justifyContent:'center',flexShrink:0,animation:'bellRing 0.8s ease infinite'}},BellI({z:18,c:'#FFF',fill:'rgba(255,255,255,0.3)'})),
      h('div',{style:{flex:1,minWidth:0}},
        h('div',{style:{fontSize:11,fontWeight:700,opacity:0.9,marginBottom:2}},notiAlert.title),
        h('div',{style:{fontSize:14,fontWeight:600,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}},notiAlert.body)
      )
    ),
    h('button',{onClick:dismissNotiAlert,style:{
      width:'100%',padding:'10px',background:'rgba(255,255,255,0.25)',border:'2px solid rgba(255,255,255,0.5)',
      borderRadius:10,color:'#FFF',fontSize:14,fontWeight:700,cursor:'pointer',
      display:'flex',alignItems:'center',justifyContent:'center',gap:6
    }},'‚úì ÌôïÏù∏')
  ):null;

  // ‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê
  const header=h('div',{style:S.header},
    h('div',{style:{display:'flex',alignItems:'center',gap:8}},
      tab==='current'?h('button',{onClick:()=>setVm(vm==='list'?'calendar':'list'),style:{...S.hBtn,borderColor:vm==='calendar'?C.accent:C.border}},
        vm==='list'?CalI({z:17,c:C.text2}):LstI({z:17,c:C.accent})
      ):h('div',{style:{width:34}}),
      h('div',{style:{flex:1,textAlign:'center'}},h('div',{style:S.hDate},todayStr())),
      // ‚òÖ NEW: Sort button (left of search)
      tab==='current'&&vm==='list'?h('div',{ref:sortRef,style:{position:'relative'}},
        h('button',{onClick:()=>setShowSortMenu(!showSortMenu),style:{...S.hBtn,borderColor:showSortMenu?C.accent:C.border,position:'relative'}},
          SortI({z:17,c:showSortMenu?C.accent:C.text2})
        ),
        // Sort dropdown menu
        showSortMenu?h('div',{style:{position:'absolute',top:40,right:0,background:C.card,border:'1px solid '+C.border,borderRadius:10,boxShadow:'0 4px 16px rgba(0,0,0,0.1)',zIndex:50,minWidth:120,overflow:'hidden',animation:'popIn 0.12s ease'}},
          ...[['date','üìÖ ÎÇ†ÏßúÏàú'],['name','üî§ Ïù¥Î¶ÑÏàú'],['type','üìÇ Íµ¨Î∂ÑÏàú']].map(([k,label])=>
            h('button',{key:k,onClick:()=>changeSortMode(k),style:{
              display:'flex',alignItems:'center',gap:8,width:'100%',padding:'10px 14px',
              background:sortMode===k?C.accent+'10':'transparent',
              border:'none',borderBottom:'1px solid '+C.border2,
              fontSize:12,fontWeight:sortMode===k?700:400,
              color:sortMode===k?C.accent:C.text,cursor:'pointer',textAlign:'left'
            }},
              h('span',null,label),
              sortMode===k?h('span',{style:{marginLeft:'auto',fontSize:10,color:C.accent}},'‚úì'):null
            )
          )
        ):null
      ):null,
      h('button',{onClick:()=>{setShowSearch(!showSearch);sSq('')},style:{...S.hBtn,borderColor:showSearch?C.accent:C.border}},SI({z:17,c:showSearch?C.accent:C.text2}))
    ),
    h('div',{style:{display:'flex',justifyContent:'center',alignItems:'center',gap:8,marginTop:4}},
      h('span',{style:S.hCount},tab==='current'?(todos.length+'Í∞ú Ìï† Ïùº'+(activeRecords.length?' ¬∑ '+activeRecords.length+'Í∞ú Í∏∞Î°ù':'')+(todayDTTotal?' ¬∑ Ïò§Îäò '+todayDTTotal+'Í∞ú':'')+(pastRecords.length?' ¬∑ ÏßÄÎÇú '+pastRecords.length:''))
        :tab==='archive'?(archive.length+'Í∞ú ÏôÑÎ£å'+(pastRecords.length?' ¬∑ '+pastRecords.length+'Í∞ú ÏßÄÎÇú Í∏∞Î°ù':''))
        :'ÏÑ§Ï†ï'),
      tab==='current'&&vm==='list'?h('span',{style:{fontSize:9,color:C.accent,background:C.accent+'12',padding:'1px 6px',borderRadius:8,fontWeight:600}},sortLabel):null,
      tab==='current'&&notiPerm!=='granted'?h('button',{onClick:requestNoti,style:{background:'none',border:'1px solid '+C.border,borderRadius:6,padding:'2px 6px',cursor:'pointer',display:'flex',alignItems:'center',gap:3}},BellI({z:12,c:C.text3}),h('span',{style:{fontSize:9,color:C.text3}},'ÏïåÎ¶º')):null,
      tab==='current'&&notiPerm==='granted'?h('span',{style:{display:'flex',alignItems:'center',gap:2}},BellI({z:11,c:C.green}),h('span',{style:{fontSize:9,color:C.green}},'ON')):null
    )
  );

  // ‚ïê‚ïê‚ïê SEARCH ‚ïê‚ïê‚ïê
  const searchP=showSearch?h('div',{style:S.sPanel},
    h('div',{style:S.sWrap},SI({z:14,c:C.text3}),h('input',{type:'text',placeholder:'Í≤ÄÏÉâ...',value:sq,onChange:e=>sSq(e.target.value),style:S.sInput,autoFocus:true}),sq?h('button',{onClick:()=>sSq(''),style:{background:'none',border:'none',color:C.text3,fontSize:12,cursor:'pointer'}},'‚úï'):null),
    sq.trim()?h('div',{style:{padding:'4px 0'}},
      h('div',{style:{padding:'4px 16px 8px'}},
        h('div',{style:{display:'flex',alignItems:'center',gap:5,marginBottom:4}},h('span',{style:{width:6,height:6,borderRadius:'50%',background:C.accent}}),h('span',{style:{fontSize:10,fontWeight:600,color:C.text3,flex:1}},'Ìï† Ïùº'),h('span',{style:{fontSize:9,color:C.text3,background:C.card,padding:'1px 5px',borderRadius:6}},sTo.length)),
        sTo.length===0?h('div',{style:{fontSize:10,color:C.text3,fontStyle:'italic'}},'ÏóÜÏùå'):sTo.map(t=>{const f=fmt(t.datetime),tg=gT(t.tagId);return h('div',{key:t.id,style:{display:'flex',alignItems:'center',padding:'4px 0',borderBottom:'1px solid '+C.border2,gap:6}},h('span',{style:{fontSize:10,color:C.text3,minWidth:55}},f.m+'/'+f.d+' '+f.t),h('span',{style:{fontSize:12,color:C.text,flex:1}},hl(t.title,sq)),tg?h('span',{style:{...S.tSm,background:tg.color+'15',color:tg.color,borderColor:tg.color+'30'}},tg.name):null)})
      ),
      sRc.length>0?h('div',{style:{padding:'4px 16px 8px'}},
        h('div',{style:{display:'flex',alignItems:'center',gap:5,marginBottom:4}},h('span',{style:{width:6,height:6,borderRadius:'50%',background:'#8B6CC1'}}),h('span',{style:{fontSize:10,fontWeight:600,color:C.text3,flex:1}},'Í∏∞Î°ù'),h('span',{style:{fontSize:9,color:C.text3,background:C.card,padding:'1px 5px',borderRadius:6}},sRc.length)),
        sRc.map(r=>{const sd=localDate(r.startDate),ed=localDate(r.endDate);return h('div',{key:r.id,style:{display:'flex',alignItems:'center',padding:'4px 0',borderBottom:'1px solid '+C.border2,gap:6}},h('span',{style:{fontSize:10,color:C.text3,minWidth:72}},(sd.getMonth()+1)+'/'+sd.getDate()+'~'+(ed.getMonth()+1)+'/'+ed.getDate()),h('span',{style:{fontSize:12,color:C.text,flex:1}},hl(r.title,sq)))})
      ):null,
      h('div',{style:{padding:'4px 16px 8px'}},
        h('div',{style:{display:'flex',alignItems:'center',gap:5,marginBottom:4}},h('span',{style:{width:6,height:6,borderRadius:'50%',background:C.green}}),h('span',{style:{fontSize:10,fontWeight:600,color:C.text3,flex:1}},'ÏôÑÎ£å'),h('span',{style:{fontSize:9,color:C.text3,background:C.card,padding:'1px 5px',borderRadius:6}},sAr.length)),
        sAr.length===0?h('div',{style:{fontSize:10,color:C.text3,fontStyle:'italic'}},'ÏóÜÏùå'):sAr.slice(0,10).map(t=>{const f=fmt(t.datetime);return h('div',{key:t.id+(t.completedAt||''),style:{display:'flex',alignItems:'center',padding:'4px 0',borderBottom:'1px solid '+C.border2,gap:6,opacity:.5}},h('span',{style:{fontSize:10,color:C.text3,minWidth:55}},f.m+'/'+f.d+' '+f.t),h('span',{style:{fontSize:12,color:C.text2,flex:1,textDecoration:'line-through'}},hl(t.title,sq)))})
      )
    ):null
  ):null;

  // ‚ïê‚ïê‚ïê EDIT TODO MODAL ‚ïê‚ïê‚ïê
  const editM=editTodo?h('div',{style:S.overlay,onClick:()=>setEditTodo(null)},
    h('div',{style:S.modal,onClick:e=>e.stopPropagation()},
      h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:14}},h('span',{style:{fontSize:15,fontWeight:600,color:C.text}},'Ìï† Ïùº ÏàòÏ†ï'),h('button',{onClick:()=>setEditTodo(null),style:S.closeBtn},'‚úï')),
      h('input',{type:'text',value:eT,onChange:e=>sET(e.target.value),style:S.input,autoFocus:true,onKeyDown:e=>e.key==='Enter'&&saveEdit()}),
      h('div',{style:{display:'flex',gap:6}},h('input',{type:'date',value:eD,onChange:e=>sED(e.target.value),style:{...S.input,flex:1}}),h('input',{type:'time',value:eTi,onChange:e=>sETi(e.target.value),style:{...S.input,flex:1}})),
      h('select',{value:eTg,onChange:e=>sETg(e.target.value),style:S.input},h('option',{value:''},'ÌÉúÍ∑∏ ÏóÜÏùå'),...tags.map(t=>h('option',{key:t.id,value:t.id},t.name))),
      notiRow(eNotiOn,sENotiOn,eNotiBefore,sENotiBefore,eNotiAtD,sENotiAtD,eNotiAtT,sENotiAtT),
      h('button',{onClick:saveEdit,style:S.submitBtn},'Ï†ÄÏû•'),
      h('button',{onClick:delEdit,style:S.delBtn},'ÏÇ≠Ï†ú')
    )
  ):null;

  // ‚ïê‚ïê‚ïê EDIT RECORD MODAL ‚ïê‚ïê‚ïê
  const editRM=editRec?h('div',{style:S.overlay,onClick:()=>setEditRec(null)},
    h('div',{style:S.modal,onClick:e=>e.stopPropagation()},
      h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:14}},h('span',{style:{fontSize:15,fontWeight:600,color:C.text}},'Í∏∞Î°ù ÏàòÏ†ï'),h('button',{onClick:()=>setEditRec(null),style:S.closeBtn},'‚úï')),
      h('input',{type:'text',value:erT,onChange:e=>sERT(e.target.value),style:S.input,autoFocus:true,onKeyDown:e=>e.key==='Enter'&&saveEditRec()}),
      h('div',{style:{display:'flex',gap:6,alignItems:'center'}},h('input',{type:'date',value:erSD,onChange:e=>sERSD(e.target.value),style:{...S.input,flex:1}}),h('span',{style:{color:C.text3,fontSize:12,marginBottom:7}},'~'),h('input',{type:'date',value:erED,onChange:e=>sERED(e.target.value),style:{...S.input,flex:1}})),
      h('select',{value:erTg,onChange:e=>sERTg(e.target.value),style:S.input},h('option',{value:''},'ÌÉúÍ∑∏ ÏóÜÏùå'),...tags.map(t=>h('option',{key:t.id,value:t.id},t.name))),
      h('button',{onClick:saveEditRec,style:S.submitBtn},'Ï†ÄÏû•'),
      h('button',{onClick:delEditRec,style:S.delBtn},'ÏÇ≠Ï†ú')
    )
  ):null;

  // ‚ïê‚ïê‚ïê CALENDAR VIEW ‚ïê‚ïê‚ïê
  const CW=100/7;
  const calView=h('div',{style:{padding:'0 6px',overflowY:'auto',WebkitOverflowScrolling:'touch',flex:1}},
    h('div',{style:{display:'flex',alignItems:'center',justifyContent:'space-between',padding:'10px 4px 6px',position:'sticky',top:0,background:C.bg,zIndex:3}},
      h('button',{onClick:pM,style:S.cNav},CL({z:15,c:C.text2})),
      h('button',{onClick:goTd,style:{background:'none',border:'none',cursor:'pointer'}},h('span',{style:{fontSize:14,fontWeight:600,color:C.text}},cm.y+'ÎÖÑ '+(cm.m+1)+'Ïõî')),
      h('button',{onClick:nM,style:S.cNav},CR({z:15,c:C.text2}))
    ),
    h('div',{style:{display:'grid',gridTemplateColumns:'repeat(7,1fr)',marginBottom:2,position:'sticky',top:36,background:C.bg,zIndex:3}},
      ...DK.map((d,i)=>h('div',{key:d+i,style:{textAlign:'center',fontSize:9,fontWeight:600,color:i===0?C.red:i===6?'#3B82F6':C.text3,padding:'2px 0'}},d))
    ),
    ...weeks.map((week,wi)=>{
      const weekBars=recBars.filter(b=>b.wi===wi);
      const barSlots=[];
      weekBars.forEach(bar=>{let slot=0;while(barSlots[slot]&&barSlots[slot].some(b=>!(bar.endCol<b.startCol||bar.startCol>b.endCol))){slot++}if(!barSlots[slot])barSlots[slot]=[];barSlots[slot].push(bar)});
      const bc=barSlots.length;
      const barGap=bc>0?bc*11+5:0;
      return h('div',{key:'w'+wi,style:{position:'relative',display:'grid',gridTemplateColumns:'repeat(7,1fr)'}},
        ...week.map((day,ci)=>{
          if(!day)return h('div',{key:'e'+ci,style:{minHeight:22+barGap,padding:2,borderBottom:'1px solid '+C.border2+'60'}});
          const it=isT(day);const dw=new Date(cm.y,cm.m,day).getDay();
          // ‚òÖ Todos for this day sorted by time
          const dayTodos=(tfd[day]||[]).sort((a,b)=>new Date(a.datetime)-new Date(b.datetime));
          return h('div',{key:day,style:{minHeight:22+barGap,padding:'2px 1px',borderRadius:4,background:it?C.accent+'0C':'transparent',border:it?'1px solid '+C.accent+'35':'1px solid transparent',borderBottom:'1px solid '+C.border2+'60'}},
            h('div',{style:{fontSize:10,fontWeight:it?700:400,color:it?C.accent:dw===0?C.red:dw===6?'#3B82F6':C.text2,textAlign:'center',marginBottom:barGap||1}},day),
            // Todos sorted by time (records are shown as bars above, no duplication)
            ...dayTodos.map(t=>{const tg=gT(t.tagId);const f=fmt(t.datetime);return h('div',{key:'ct'+t.id,onClick:e=>openEdit(t,e),style:{fontSize:6,lineHeight:'8px',padding:'1px 2px',marginBottom:1,borderRadius:2,background:tg?tg.color+'15':C.border2,color:tg?tg.color:C.text2,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap',cursor:'pointer',display:'flex',gap:1}},h('span',{style:{color:C.text3,fontSize:6,flexShrink:0}},f.t),h('span',null,t.title))})
          )
        }),
        ...barSlots.flatMap((slot,si)=>slot.map(bar=>{
          const left=bar.startCol*CW,width=(bar.endCol-bar.startCol+1)*CW;
          const bL=bar.isStart?'4px':'0',bR=bar.isEnd?'4px':'0';
          return h('div',{key:'rb'+bar.rec.id+'w'+wi+'s'+si,onClick:e=>openEditRec(bar.rec,e),style:{
            position:'absolute',top:20+si*11,left:left+'%',width:width+'%',height:10,
            background:bar.color+'28',borderLeft:bar.isStart?'3px solid '+bar.color:'none',
            borderRadius:bL+' '+bR+' '+bR+' '+bL,cursor:'pointer',display:'flex',alignItems:'center',paddingLeft:bar.isStart?3:2,overflow:'hidden',zIndex:2
          }},h('span',{style:{fontSize:7,fontWeight:600,color:bar.color,whiteSpace:'nowrap',overflow:'hidden',textOverflow:'ellipsis'}},bar.title))
        }))
      )
    })
  );

  // ‚ïê‚ïê‚ïê LIST ITEMS ‚ïê‚ïê‚ïê
  const recEl=rec=>{
    const tg=gT(rec.tagId);const color=tg?tg.color:'#8B6CC1';
    const sd=localDate(rec.startDate),ed=localDate(rec.endDate),days=daysBetween(sd,ed);
    const now=new Date(),elapsed=Math.ceil((now-sd)/864e5),pct=Math.min(Math.max(elapsed/days*100,0),100);
    return h('div',{key:'r_'+rec.id,onClick:e=>openEditRec(rec,e),style:{display:'flex',alignItems:'center',padding:'8px 14px',borderBottom:'1px solid '+C.border2,cursor:'pointer',gap:8}},
      h('div',{style:{width:3,height:28,borderRadius:2,background:color,flexShrink:0}}),
      h('div',{style:{flex:1,minWidth:0}},
        h('div',{style:{display:'flex',alignItems:'center',gap:6,marginBottom:2}},
          h('span',{style:{fontSize:9,fontWeight:600,color:'#fff',background:color,padding:'1px 5px',borderRadius:4}},'Í∏∞Î°ù'),
          h('span',{style:{fontSize:10,fontWeight:600,color}},(sd.getMonth()+1)+'/'+sd.getDate()+' ~ '+(ed.getMonth()+1)+'/'+ed.getDate()),
          h('span',{style:{fontSize:9,color:C.text3}},days+'Ïùº'),
          tg?h('span',{style:{...S.tSm,background:tg.color+'12',color:tg.color,borderColor:tg.color+'25'}},tg.name):null
        ),
        h('div',{style:{fontSize:13,fontWeight:500,color:C.text,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}},rec.title),
        h('div',{style:{marginTop:3,height:2,borderRadius:1,background:C.border}},h('div',{style:{height:'100%',borderRadius:1,background:color,width:pct+'%',transition:'width 0.3s'}}))
      )
    )
  };

  const todoEl=todo=>{
    const f=fmt(todo.datetime),tg=gT(todo.tagId),fd=fadingOut.has(todo.id);
    const hasNoti=todo.notiOn!==false;
    const notiInfo=hasNoti?(todo.notiAt?fmt(todo.notiAt):null):null;
    return h('div',{key:'t_'+todo.id,style:{display:'flex',alignItems:'center',padding:fd?'0 14px':'7px 14px',borderBottom:'1px solid '+C.border2,overflow:'hidden',opacity:fd?0:1,transform:fd?'translateX(40px)':'none',maxHeight:fd?0:46,transition:'all 0.35s cubic-bezier(0.4,0,0.2,1)'}},
      h('div',{onClick:e=>openEdit(todo,e),style:{flex:1,minWidth:0,display:'flex',alignItems:'center',gap:5,cursor:'pointer',padding:'2px 0'}},
        h('span',{style:{fontSize:10,fontWeight:600,color:C.accent,minWidth:30,flexShrink:0}},f.m+'/'+f.d),
        h('span',{style:{fontSize:9,color:C.text3,flexShrink:0}},'('+f.w+')'),
        h('span',{style:{fontSize:10,color:C.text3,flexShrink:0,marginRight:2}},f.t),
        hasNoti?h('span',{style:{flexShrink:0,display:'flex',alignItems:'center',gap:2,marginRight:1}},
          BellI({z:10,c:C.accent+'80'}),
          notiInfo?h('span',{style:{fontSize:8,color:C.accent+'80'}},notiInfo.m+'/'+notiInfo.d+' '+notiInfo.t):null
        ):null,
        h('span',{style:{fontSize:13,fontWeight:500,color:C.text,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap',flex:1}},todo.title),
        tg?h('span',{style:{...S.tSm,background:tg.color+'12',color:tg.color,borderColor:tg.color+'25',flexShrink:0,marginLeft:3}},tg.name):null
      ),
      h('button',{onClick:e=>{e.stopPropagation();completeTodo(todo.id)},style:{width:30,height:30,display:'flex',alignItems:'center',justifyContent:'center',background:'none',border:'none',cursor:'pointer',flexShrink:0,marginLeft:4}},
        h('div',{style:{width:17,height:17,borderRadius:'50%',border:'2px solid '+C.border}})
      )
    )
  };

  const arcEl=todo=>{
    const f=fmt(todo.datetime),cd=todo.completedAt?new Date(todo.completedAt):null;
    const tg=gT(todo.tagId);
    const isDaily=todo.isDailyTask;
    const cdStr=cd?(cd.getFullYear()+'ÎÖÑ '+(cd.getMonth()+1)+'Ïõî '+cd.getDate()+'Ïùº '+String(cd.getHours()).padStart(2,'0')+'Ïãú '+String(cd.getMinutes()).padStart(2,'0')+'Î∂Ñ'):'';
    return h('div',{key:todo.id+(todo.completedAt||''),style:{display:'flex',alignItems:'center',padding:'7px 14px',borderBottom:'1px solid '+C.border2,opacity:.85}},
      h('div',{style:{flex:1,minWidth:0}},
        isDaily?h('div',{style:{display:'flex',alignItems:'center',gap:5,flexWrap:'wrap'}},
          h('span',{style:{fontSize:9,fontWeight:700,color:'#FFF',background:'#E8A838',padding:'1px 5px',borderRadius:4,flexShrink:0}},'Ïò§ÎäòÏùò Ìï†Ïùº'),
          h('span',{style:{fontSize:13,color:C.text,textDecoration:'line-through',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap',flex:1}},todo.title),
          cd?h('span',{style:{fontSize:9,color:'#8C7E72',flexShrink:0,fontWeight:500}},cdStr):null
        ):h('div',{style:{display:'flex',alignItems:'center',gap:5}},
          h('span',{style:{fontSize:10,fontWeight:600,color:C.accent,minWidth:30}},f.m+'/'+f.d),
          h('span',{style:{fontSize:9,color:'#7A6E62'}},'('+f.w+')'),
          h('span',{style:{fontSize:10,color:'#7A6E62',marginRight:3}},f.t),
          h('span',{style:{fontSize:13,color:C.text,textDecoration:'line-through',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap',flex:1}},todo.title),
          tg?h('span',{style:{...S.tSm,background:tg.color+'12',color:tg.color,borderColor:tg.color+'25',flexShrink:0,marginLeft:3}},tg.name):null
        )
      ),
      h('div',{style:{display:'flex',alignItems:'center',gap:4,flexShrink:0}},
        !isDaily&&cd?h('span',{style:{fontSize:9,color:'#7A6E62'}},(cd.getMonth()+1)+'/'+cd.getDate()):null,
        h('button',{onClick:e=>{e.stopPropagation();restoreTodo(todo)},title:'Î≥µÍµ¨',style:{width:26,height:26,borderRadius:'50%',background:C.accent+'12',border:'1px solid '+C.accent+'30',display:'flex',alignItems:'center',justifyContent:'center',cursor:'pointer',marginLeft:2}},UndoI({z:12,c:C.accent})),
        h('div',{style:{width:16,height:16,borderRadius:'50%',background:C.greenBg,color:C.green,display:'flex',alignItems:'center',justifyContent:'center',fontSize:9,fontWeight:700}},'‚úì')
      )
    )
  };

  // ‚òÖ Past record item (in archive tab)
  const pastRecEl=rec=>{
    const tg=gT(rec.tagId);const color=tg?tg.color:'#8B6CC1';
    const sd=localDate(rec.startDate),ed=localDate(rec.endDate);
    return h('div',{key:'pr_'+rec.id,onClick:e=>openEditRec(rec,e),style:{display:'flex',alignItems:'center',padding:'7px 14px',borderBottom:'1px solid '+C.border2,opacity:.5,cursor:'pointer',gap:8}},
      h('div',{style:{width:3,height:20,borderRadius:2,background:color,flexShrink:0}}),
      h('div',{style:{flex:1,minWidth:0}},
        h('div',{style:{display:'flex',alignItems:'center',gap:5}},
          h('span',{style:{fontSize:9,fontWeight:600,color:'#fff',background:color+'90',padding:'1px 5px',borderRadius:4}},'ÏßÄÎÇú Í∏∞Î°ù'),
          h('span',{style:{fontSize:10,color}},(sd.getMonth()+1)+'/'+sd.getDate()+' ~ '+(ed.getMonth()+1)+'/'+ed.getDate()),
        ),
        h('span',{style:{fontSize:12,color:C.text2,display:'block',marginTop:2,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}},rec.title)
      )
    )
  };

  // ‚ïê‚ïê‚ïê Render unified item ‚ïê‚ïê‚ïê
  const renderUnifiedItem=item=>{
    if(item.type==='todo')return todoEl(item.data);
    if(item.type==='record')return recEl(item.data);
    return null;
  };

  // ‚ïê‚ïê‚ïê ADD FORM ‚ïê‚ïê‚ïê
  const addF=showAdd?h('div',{style:S.addForm},
    h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:10}},
      h('div',{style:{display:'flex',gap:0,background:C.border2,borderRadius:7,padding:2}},
        h('button',{onClick:()=>setAddMode('todo'),style:{...S.segBtn,background:addMode==='todo'?C.card:'transparent',color:addMode==='todo'?C.text:C.text3}},'Ìï† Ïùº'),
        h('button',{onClick:()=>setAddMode('record'),style:{...S.segBtn,background:addMode==='record'?C.card:'transparent',color:addMode==='record'?C.text:C.text3}},'Í∏∞Î°ù')
      ),
      h('button',{onClick:()=>setShowAdd(false),style:S.closeBtn},'‚úï')
    ),
    addMode==='todo'?h('div',null,
      h('input',{type:'text',placeholder:'Ìï† Ïùº ÏûÖÎ†•',value:nT,onChange:e=>sNT(e.target.value),style:S.input,autoFocus:true,onKeyDown:e=>e.key==='Enter'&&addTodo()}),
      h('div',{style:{display:'flex',gap:6}},h('input',{type:'date',value:nD,onChange:e=>sND(e.target.value),style:{...S.input,flex:1}}),h('input',{type:'time',value:nTi,onChange:e=>sNTi(e.target.value),style:{...S.input,flex:1}})),
      h('select',{value:nTg,onChange:e=>sNTg(e.target.value),style:S.input},h('option',{value:''},'ÌÉúÍ∑∏ ÏÑ†ÌÉù'),...tags.map(t=>h('option',{key:t.id,value:t.id},t.name))),
      notiRow(nNotiOn,sNNotiOn,nNotiBefore,sNNotiBefore,nNotiAtD,sNNotiAtD,nNotiAtT,sNNotiAtT),
      h('button',{onClick:addTodo,style:S.submitBtn},'Ï∂îÍ∞Ä')
    ):h('div',null,
      h('input',{type:'text',placeholder:'Í∏∞Î°ù Ï†úÎ™© (Ïòà: Î∂ÄÎ™®Îãò Ìï¥Ïô∏Ïó¨Ìñâ)',value:rT,onChange:e=>sRT(e.target.value),style:S.input,autoFocus:true,onKeyDown:e=>e.key==='Enter'&&addRecord()}),
      h('div',{style:{display:'flex',gap:6,alignItems:'center'}},h('input',{type:'date',value:rSD,onChange:e=>sRSD(e.target.value),style:{...S.input,flex:1}}),h('span',{style:{color:C.text3,fontSize:12,marginBottom:7}},'~'),h('input',{type:'date',value:rED,onChange:e=>sRED(e.target.value),style:{...S.input,flex:1}})),
      h('select',{value:rTg,onChange:e=>sRTg(e.target.value),style:S.input},h('option',{value:''},'ÌÉúÍ∑∏ ÏÑ†ÌÉù'),...tags.map(t=>h('option',{key:t.id,value:t.id},t.name))),
      h('button',{onClick:addRecord,style:S.submitBtn},'Ï∂îÍ∞Ä')
    )
  ):null;

  const fab=!showAdd&&tab==='current'?h('button',{onClick:()=>setShowAdd(true),style:S.fab},'+'):null;
  const fileInput=h('input',{ref:fileInputRef,type:'file',accept:'.json',style:{display:'none'},onChange:handleImport});

  // ‚ïê‚ïê‚ïê YESTERDAY PROMPT ‚ïê‚ïê‚ïê
  const yesterdayPrompt=showYesterdayPrompt&&yesterdayItems.length>0?h('div',{style:{margin:'6px 10px',padding:12,background:'linear-gradient(135deg,#FFF3E0,#FFF8F0)',borderRadius:12,border:'1px solid #FFD49E',animation:'scaleIn 0.15s ease',boxShadow:'0 2px 8px rgba(200,150,62,0.1)'}},
    h('div',{style:{display:'flex',alignItems:'center',gap:6,marginBottom:8}},
      h('span',{style:{fontSize:16}},'üìã'),
      h('div',{style:{flex:1}},
        h('div',{style:{fontSize:12,fontWeight:700,color:C.text}},'Ïñ¥Ï†ú Î™ª Ìïú ÏùºÏù¥ '+yesterdayItems.length+'Í∞ú ÏûàÏñ¥Ïöî'),
        h('div',{style:{fontSize:10,color:C.text2,marginTop:1}},'Ïò§ÎäòÎ°ú ÏòÆÍ∏∞ÏãúÍ≤†Ïñ¥Ïöî?')
      ),
      h('button',{onClick:()=>setShowYesterdayPrompt(false),style:{background:'none',border:'none',color:C.text3,fontSize:12,cursor:'pointer'}},'‚úï')
    ),
    ...yesterdayItems.map(it=>h('div',{key:it.id,style:{fontSize:11,color:C.text2,padding:'3px 0',paddingLeft:22,borderBottom:'1px solid #FFE8C8'}},'‚Ä¢ '+it.title)),
    h('div',{style:{display:'flex',gap:6,marginTop:8}},
      h('button',{onClick:moveAllToToday,style:{flex:1,padding:'8px',background:C.accent,color:'#FFF',border:'none',borderRadius:7,fontSize:12,fontWeight:600,cursor:'pointer'}},'Ïò§ÎäòÎ°ú ÏòÆÍ∏∞Í∏∞'),
      h('button',{onClick:()=>{moveToTomorrow(yesterdayItems)},style:{flex:1,padding:'8px',background:'transparent',color:C.text2,border:'1px solid '+C.border,borderRadius:7,fontSize:12,fontWeight:500,cursor:'pointer'}},'ÎÇ¥ÏùºÎ°ú'),
      h('button',{onClick:()=>setShowYesterdayPrompt(false),style:{padding:'8px 12px',background:'transparent',color:C.text3,border:'1px solid '+C.border,borderRadius:7,fontSize:11,cursor:'pointer'}},'Î¨¥Ïãú')
    )
  ):null;

  // Tomorrow's daily tasks
  const tmrw=new Date(td);tmrw.setDate(tmrw.getDate()+1);const tmrwDS=toDS(tmrw);
  const tomorrowDT=dailyTasks.filter(d=>d.date===tmrwDS);

  // ‚ïê‚ïê‚ïê DAILY TASKS SECTION (Ïò§Îäò Ìï† Ïùº) ‚ïê‚ïê‚ïê
  const dtSection=tab==='current'&&vm==='list'?h('div',{style:{margin:'4px 10px 2px',background:C.card,borderRadius:10,border:'1px solid '+C.border,overflow:'hidden',boxShadow:'0 1px 4px rgba(0,0,0,0.03)'}},
    // Header - toggle
    h('div',{onClick:()=>setShowDtSection(!showDtSection),style:{display:'flex',alignItems:'center',padding:'8px 12px',cursor:'pointer',background:C.card2}},
      h('span',{style:{fontSize:12,marginRight:6}},'‚òÄÔ∏è'),
      h('span',{style:{fontSize:12,fontWeight:700,color:C.text,flex:1}},'Ïò§Îäò Ìï† Ïùº'),
      todayDTTotal>0?h('span',{style:{fontSize:10,color:C.accent,fontWeight:600,marginRight:6}},todayDTTotal+'Í∞ú'):null,
      h('span',{style:{fontSize:10,color:C.text3,transform:showDtSection?'rotate(90deg)':'rotate(0)',transition:'transform 0.2s'}},'‚ñ∂')
    ),
    showDtSection?h('div',{style:{padding:'6px 12px 8px'}},
      // Today's task list
      ...todayDT.map(dt=>h('div',{key:dt.id,style:{display:'flex',alignItems:'center',gap:8,padding:'5px 0',borderBottom:'1px solid '+C.border2}},
        h('button',{onClick:()=>completeDailyTask(dt.id),style:{width:18,height:18,borderRadius:4,border:'2px solid '+C.border,background:'transparent',display:'flex',alignItems:'center',justifyContent:'center',cursor:'pointer',flexShrink:0}},null),
        h('span',{style:{flex:1,fontSize:12,color:C.text}},dt.title),
        h('button',{onClick:()=>delDailyTask(dt.id),style:{background:'none',border:'none',color:C.text3,fontSize:10,cursor:'pointer',padding:'2px 4px',opacity:.5}},'‚úï')
      )),
      // Uncompleted items "move to tomorrow" button
      todayDT.length>0?h('button',{onClick:()=>{moveToTomorrow(todayDT)},
        style:{width:'100%',padding:'6px',marginTop:4,background:'transparent',border:'1px dashed '+C.accent+'50',borderRadius:6,color:C.accent,fontSize:10,fontWeight:600,cursor:'pointer'}},'‚Üí Î™ª Ìïú Ïùº ÎÇ¥ÏùºÎ°ú ÏòÆÍ∏∞Í∏∞'):null,
      // Tomorrow's tasks (if any)
      tomorrowDT.length>0?h('div',{style:{marginTop:8,padding:'8px',borderTop:'1px solid '+C.border,background:'#F0EDFF',borderRadius:8}},
        h('div',{style:{display:'flex',alignItems:'center',gap:4,marginBottom:6}},
          h('span',{style:{fontSize:11,fontWeight:700,color:'#6366F1'}},'üìÖ ÎÇ¥Ïùº Ìï† Ïùº'),
          h('span',{style:{fontSize:10,color:'#FFF',background:'#6366F1',padding:'1px 6px',borderRadius:8,fontWeight:700}},tomorrowDT.length+'Í∞ú')
        ),
        ...tomorrowDT.map(dt=>h('div',{key:dt.id,style:{display:'flex',alignItems:'center',gap:6,padding:'4px 0',borderBottom:'1px solid #E0DDFA'}},
          h('span',{style:{fontSize:11,color:C.text,flex:1}},dt.title),
          h('button',{onClick:()=>moveBackToToday([dt]),style:{padding:'4px 10px',background:'#6366F1',color:'#FFF',border:'none',borderRadius:12,fontSize:10,fontWeight:700,cursor:'pointer'}},'‚Üê Ïò§ÎäòÎ°ú')
        )),
        h('button',{onClick:()=>moveBackToToday(tomorrowDT),style:{width:'100%',padding:'8px',marginTop:6,background:'#6366F1',color:'#FFF',border:'none',borderRadius:7,fontSize:12,fontWeight:700,cursor:'pointer'}},'‚Üê Ï†ÑÏ≤¥ Ïò§ÎäòÎ°ú ÎêòÎèåÎ¶¨Í∏∞')
      ):null,
      // Add input
      h('div',{style:{display:'flex',gap:4,marginTop:6}},
        h('input',{type:'text',placeholder:'Ïò§Îäò Ìï† Ïùº Ï∂îÍ∞Ä...',value:dtInput,onChange:e=>setDtInput(e.target.value),onKeyDown:e=>e.key==='Enter'&&addDailyTask(),style:{flex:1,padding:'7px 10px',background:C.bg,border:'1px solid '+C.border,borderRadius:6,color:C.text,fontSize:12,outline:'none'}}),
        h('button',{onClick:addDailyTask,style:{padding:'7px 12px',background:C.accent,color:'#FFF',border:'none',borderRadius:6,fontSize:12,fontWeight:600,cursor:'pointer'}},'+')
      )
    ):null
  ):null;

  // ‚ïê‚ïê‚ïê CONTENT ‚ïê‚ïê‚ïê
  let content;
  if(tab==='current'){
    if(vm==='calendar'){content=h('div',{style:{display:'flex',flexDirection:'column',height:'100%'}},calView,addF)}
    else{
      const hasItems=unifiedList.length>0;
      content=h('div',null,
        yesterdayPrompt,
        dtSection,
        !hasItems&&!showAdd&&todayDTTotal===0?h('div',{style:S.empty},h('div',{style:{fontSize:32,marginBottom:8}},'‚úì'),h('div',{style:{fontSize:13,color:C.text2}},'Ìï† ÏùºÏù¥ ÏóÜÏäµÎãàÎã§'),h('div',{style:{fontSize:11,marginTop:4,color:C.text3}},'+ Î≤ÑÌäºÏúºÎ°ú Ï∂îÍ∞Ä')):null,
        // Section header for type sort mode
        sortMode==='type'&&hasItems?h('div',null,
          activeRecords.length>0?h('div',null,
            h('div',{style:{padding:'8px 14px 4px',fontSize:10,fontWeight:600,color:C.text3,letterSpacing:.5}},'üìã Í∏∞Î°ù ¬∑ '+activeRecords.length+'Í∞ú'),
            ...unifiedList.filter(i=>i.type==='record').map(renderUnifiedItem)
          ):null,
          todos.length>0?h('div',null,
            h('div',{style:{padding:'8px 14px 4px',fontSize:10,fontWeight:600,color:C.text3,letterSpacing:.5}},'üìù Ìï† Ïùº ¬∑ '+todos.length+'Í∞ú'),
            ...unifiedList.filter(i=>i.type==='todo').map(renderUnifiedItem)
          ):null
        ):null,
        // For date/name sort: single merged list
        sortMode!=='type'&&hasItems?h('div',null,...unifiedList.map(renderUnifiedItem)):null,
        addF
      );
    }
  }else if(tab==='archive'){
    // ‚òÖ IMPROVED: past records auto-appear here
    const hasPast=archive.length>0||pastRecords.length>0;
    content=!hasPast?h('div',{style:S.empty},h('div',{style:{fontSize:32,marginBottom:8}},'üìã'),h('div',{style:{fontSize:13,color:C.text2}},'ÏôÑÎ£å Ìï≠Î™© ÏóÜÏùå'))
      :h('div',null,
        pastRecords.length>0?h('div',null,
          h('div',{style:{padding:'8px 14px 4px',fontSize:10,fontWeight:600,color:C.text3,letterSpacing:.5}},'üìã ÏßÄÎÇú Í∏∞Î°ù ¬∑ '+pastRecords.length+'Í∞ú'),
          ...pastRecords.map(pastRecEl)
        ):null,
        archive.length>0?h('div',null,
          h('div',{style:{padding:'8px 14px 4px',fontSize:10,fontWeight:600,color:C.text3,letterSpacing:.5}},'‚úÖ ÏôÑÎ£åÎêú Ìï† Ïùº ¬∑ '+archive.length+'Í∞ú'),
          ...archive.map(arcEl)
        ):null
      );
  }else{
    content=h('div',{style:{padding:12}},
      h('div',{style:S.setS},
        h('div',{style:S.setST},'ÌÉúÍ∑∏ Í¥ÄÎ¶¨'),
        h('div',{style:{marginBottom:12}},...tags.map(tg=>h('div',{key:tg.id,style:{display:'flex',alignItems:'center',padding:'7px 0',borderBottom:'1px solid '+C.border2}},h('div',{style:{width:10,height:10,borderRadius:'50%',background:tg.color,marginRight:10}}),h('span',{style:{flex:1,fontSize:13,color:C.text}},tg.name),h('button',{onClick:()=>delTag(tg.id),style:{background:'none',border:'1px solid '+C.red+'30',color:C.red,fontSize:10,padding:'2px 7px',borderRadius:4,cursor:'pointer'}},'ÏÇ≠Ï†ú')))),
        h('div',{style:{paddingTop:10,borderTop:'1px solid '+C.border}},
          h('div',{style:{fontSize:12,fontWeight:600,color:C.text2,marginBottom:6}},'ÏÉà ÌÉúÍ∑∏'),
          h('div',{style:{display:'flex',gap:6}},h('input',{type:'text',placeholder:'Ïù¥Î¶Ñ',value:nTgN,onChange:e=>sNTgN(e.target.value),style:{...S.input,flex:2},onKeyDown:e=>e.key==='Enter'&&addTag()}),h('input',{type:'color',value:nTgC,onChange:e=>sNTgC(e.target.value),style:{width:38,height:38,borderRadius:6,border:'1px solid '+C.border,background:C.card,padding:2,cursor:'pointer',marginBottom:7}})),
          h('button',{onClick:addTag,style:S.submitBtn},'Ï∂îÍ∞Ä')
        )
      ),
      h('div',{style:S.setS},
        h('div',{style:S.setST},'ÏïåÎ¶º ÏÑ§Ï†ï'),
        h('div',{style:{fontSize:12,color:C.text2,marginBottom:8}},'Ìï† Ïùº ÏãúÍ∞Ñ Ï†ÑÏóê ÏïåÎ¶ºÏùÑ Î≥¥ÎÉÖÎãàÎã§.'),
        h('div',{style:{fontSize:11,color:notiPerm==='granted'?C.green:C.text3,marginBottom:8}},notiPerm==='granted'?'‚úì ÏïåÎ¶º ÌôúÏÑ±ÌôîÎê®':notiPerm==='denied'?'‚úï ÏïåÎ¶º Ï∞®Îã®Îê® (Î∏åÎùºÏö∞Ï†Ä ÏÑ§Ï†ïÏóêÏÑú ÌóàÏö© ÌïÑÏöî)':'ÏïåÎ¶º ÎØ∏ÏÑ§Ï†ï'),
        notiPerm==='default'?h('button',{onClick:requestNoti,style:{...S.submitBtn,marginBottom:8}},'ÏïåÎ¶º ÌóàÏö©ÌïòÍ∏∞'):null,
        // Sound toggle
        h('div',{style:{display:'flex',alignItems:'center',justifyContent:'space-between',padding:'8px 0',borderTop:'1px solid '+C.border2}},
          h('div',null,
            h('div',{style:{fontSize:12,fontWeight:600,color:C.text}},'ÏïåÎ¶ºÏùå'),
            h('div',{style:{fontSize:10,color:C.text3}},'ÏïåÎ¶º Ïãú ÏÜåÎ¶¨Î•º Ïû¨ÏÉùÌï©ÎãàÎã§')
          ),
          h('button',{onClick:()=>toggleSound(!soundOn),style:{
            width:44,height:24,borderRadius:12,border:'none',cursor:'pointer',position:'relative',
            background:soundOn?C.accent:C.border,transition:'background 0.2s'
          }},h('div',{style:{
            width:20,height:20,borderRadius:'50%',background:'#FFF',position:'absolute',top:2,
            left:soundOn?22:2,transition:'left 0.2s',boxShadow:'0 1px 3px rgba(0,0,0,0.2)'
          }}))
        ),
        // Vibration toggle
        h('div',{style:{display:'flex',alignItems:'center',justifyContent:'space-between',padding:'8px 0',borderTop:'1px solid '+C.border2}},
          h('div',null,
            h('div',{style:{fontSize:12,fontWeight:600,color:C.text}},'ÏßÑÎèô'),
            h('div',{style:{fontSize:10,color:C.text3}},'ÏïåÎ¶º Ïãú ÏßÑÎèôÏù¥ Ïö∏Î¶ΩÎãàÎã§')
          ),
          h('button',{onClick:()=>toggleVibrate(!vibrateOn),style:{
            width:44,height:24,borderRadius:12,border:'none',cursor:'pointer',position:'relative',
            background:vibrateOn?C.accent:C.border,transition:'background 0.2s'
          }},h('div',{style:{
            width:20,height:20,borderRadius:'50%',background:'#FFF',position:'absolute',top:2,
            left:vibrateOn?22:2,transition:'left 0.2s',boxShadow:'0 1px 3px rgba(0,0,0,0.2)'
          }}))
        ),
        // Test button
        h('button',{onClick:()=>{showNotiAlert('üîî ÌÖåÏä§Ìä∏ ÏïåÎ¶º','ÌôïÏù∏ Î≤ÑÌäºÏùÑ ÎàÑÎ•¥Î©¥ ÏïåÎ¶ºÏù¥ Î©àÏ∂•ÎãàÎã§',C.accent)},style:{
          width:'100%',padding:'10px',marginTop:10,background:C.accent+'12',color:C.accent,
          border:'1px solid '+C.accent+'30',borderRadius:8,fontSize:12,fontWeight:600,cursor:'pointer',
          display:'flex',alignItems:'center',justifyContent:'center',gap:6
        }},BellI({z:14,c:C.accent}),'ÏïåÎ¶º ÌÖåÏä§Ìä∏'),
        h('div',{style:{fontSize:10,color:C.text3,marginTop:8,padding:'6px 10px',background:C.accent+'08',borderRadius:6,border:'1px solid '+C.accent+'15',lineHeight:'1.6'}},
          'üí° PWA ÏïåÎ¶º ÏûëÎèô Î∞©Ïãù:\n',
          '‚Ä¢ Ïï± ÏÇ¨Ïö© Ï§ë ‚Üí ÏÜåÎ¶¨ + ÏßÑÎèô + ÌôîÎ©¥ Î∞∞ÎÑà\n',
          '‚Ä¢ Ïï±Ïù¥ Î∞±Í∑∏ÎùºÏö¥ÎìúÏùº Îïå ‚Üí ÏïåÎ¶ºÏ∞ΩÏóê ÌëúÏãú\n',
          '‚Ä¢ Ïï±ÏùÑ ÏôÑÏ†ÑÌûà Ï¢ÖÎ£åÌïòÎ©¥ ÏïåÎ¶ºÏù¥ Ïò§ÏßÄ ÏïäÏäµÎãàÎã§\n\n',
          'üì± ÏïÑÎûò "Ìôà ÌôîÎ©¥Ïóê Ï∂îÍ∞Ä"Î•º ÌïòÎ©¥ Ïï±Ï≤òÎüº ÏÑ§ÏπòÎêòÏñ¥\nÏïåÎ¶ºÏù¥ Îçî ÏïàÏ†ïÏ†ÅÏúºÎ°ú ÎèôÏûëÌï©ÎãàÎã§.'
        ),
        // PWA install status
        h('div',{style:{display:'flex',alignItems:'center',justifyContent:'space-between',padding:'8px 0',marginTop:4,borderTop:'1px solid '+C.border2}},
          h('div',null,
            h('div',{style:{fontSize:12,fontWeight:600,color:C.text}},'Ïï± ÏÑ§Ïπò ÏÉÅÌÉú'),
            h('div',{style:{fontSize:10,color:C.text3}},window.matchMedia('(display-mode: standalone)').matches?'PWAÎ°ú ÏÑ§ÏπòÎê®':'Î∏åÎùºÏö∞Ï†ÄÏóêÏÑú Ïã§Ìñâ Ï§ë')
          ),
          h('div',{style:{fontSize:10,color:window.matchMedia('(display-mode: standalone)').matches?C.green:C.accent,fontWeight:600}},window.matchMedia('(display-mode: standalone)').matches?'‚úì ÏÑ§ÏπòÎê®':'ÎØ∏ÏÑ§Ïπò')
        )
      ),
      h('div',{style:S.setS},
        h('div',{style:S.setST},'Îç∞Ïù¥ÌÑ∞ Î∞±ÏóÖ / Î≥µÏõê'),
        h('div',{style:{fontSize:11,color:C.text3,marginBottom:10,lineHeight:'1.5'}},'Î∏åÎùºÏö∞Ï†Ä Ï∫êÏãúÎ•º ÏßÄÏö∞Î©¥ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏÇ¨ÎùºÏßà Ïàò ÏûàÏäµÎãàÎã§.\nÏ†ïÍ∏∞Ï†ÅÏúºÎ°ú Î∞±ÏóÖÌï¥ÎëêÏãúÎäî Í≤ÉÏùÑ Í∂åÏû•Ìï©ÎãàÎã§.'),
        h('div',{style:{display:'flex',gap:8,marginBottom:8}},
          h('button',{onClick:exportData,style:{...S.backupBtn,background:C.accent+'12',color:C.accent,borderColor:C.accent+'30'}},DlI({z:14,c:C.accent}),h('span',null,'Î∞±ÏóÖ Ï†ÄÏû•')),
          h('button',{onClick:importData,style:{...S.backupBtn,background:C.green+'12',color:C.green,borderColor:C.green+'30'}},UlI({z:14,c:C.green}),h('span',null,'Î≥µÏõêÌïòÍ∏∞'))
        )
      ),
      h('div',{style:S.setS},
        h('div',{style:S.setST},'Îç∞Ïù¥ÌÑ∞ ÌòÑÌô©'),
        ...[['Ìï† Ïùº',todos.length],['ÏôÑÎ£å',archive.length],['ÏßÑÌñâ Ï§ë Í∏∞Î°ù',activeRecords.length],['ÏßÄÎÇú Í∏∞Î°ù',pastRecords.length],['Ïò§Îäò Ìï† Ïùº',todayDTTotal],['ÌÉúÍ∑∏',tags.length]].map(([l,v])=>h('div',{key:l,style:{display:'flex',justifyContent:'space-between',padding:'7px 0',fontSize:12,color:C.text2,borderBottom:'1px solid '+C.border2}},h('span',null,l),h('span',{style:{background:C.accentBg,color:C.accent,fontSize:10,fontWeight:600,padding:'1px 7px',borderRadius:10}},v))),
        h('button',{onClick:clearAllData,style:{...S.delBtn,marginTop:12,fontSize:11,padding:'8px'}},'Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú')
      )
    );
  }

  const nav=h('div',{style:S.nav},
    ...[['current','üìù','ÌòÑÏû¨'],['archive','‚úÖ','Í≥ºÍ±∞'],['settings','‚öôÔ∏è','ÏÑ§Ï†ï']].map(([k,ic,lb])=>
      h('button',{key:k,onClick:()=>{setTab(k);setShowSearch(false);sSq('');setShowSortMenu(false)},style:{flex:1,display:'flex',flexDirection:'column',alignItems:'center',gap:1,background:'none',border:'none',cursor:'pointer',padding:'5px 0'}},
        h('span',{style:{fontSize:17}},ic),h('span',{style:{fontSize:9,fontWeight:500,color:tab===k?C.accent:C.text3}},lb)
      )
    )
  );

  // ‚òÖ Wide layout for Fold5 - Left: Ìï†Ïùº | Right: Í≥ºÍ±∞
  if(isWide&&tab==='current'&&vm==='list'){
    const hasPast=archive.length>0||pastRecords.length>0;
    return h('div',{style:{...S.root,maxWidth:780}},
      header,searchP,
      h('div',{style:{...S.content,display:'flex',gap:0}},
        // ‚ïê‚ïê‚ïê LEFT COLUMN: Ïò§Îäò Ìï† Ïùº + ÌòÑÏû¨ Î¶¨Ïä§Ìä∏ ‚ïê‚ïê‚ïê
        h('div',{style:{flex:1,minWidth:0,overflowY:'auto',borderRight:'1px solid '+C.border}},
          yesterdayPrompt,
          dtSection,
          !unifiedList.length&&!showAdd&&todayDTTotal===0?h('div',{style:{...S.empty,height:'30vh'}},h('div',{style:{fontSize:28,marginBottom:6}},'‚úì'),h('div',{style:{fontSize:12,color:C.text2}},'Ìï† ÏùºÏù¥ ÏóÜÏäµÎãàÎã§')):null,
          sortMode==='type'&&unifiedList.length>0?h('div',null,
            activeRecords.length>0?h('div',null,
              h('div',{style:{padding:'8px 14px 4px',fontSize:10,fontWeight:600,color:C.text3,letterSpacing:.5}},'üìã Í∏∞Î°ù ¬∑ '+activeRecords.length+'Í∞ú'),
              ...unifiedList.filter(i=>i.type==='record').map(renderUnifiedItem)
            ):null,
            todos.length>0?h('div',null,
              h('div',{style:{padding:'8px 14px 4px',fontSize:10,fontWeight:600,color:C.text3,letterSpacing:.5}},'üìù Ìï† Ïùº ¬∑ '+todos.length+'Í∞ú'),
              ...unifiedList.filter(i=>i.type==='todo').map(renderUnifiedItem)
            ):null
          ):null,
          sortMode!=='type'&&unifiedList.length>0?h('div',null,...unifiedList.map(renderUnifiedItem)):null,
          addF
        ),
        // ‚ïê‚ïê‚ïê RIGHT COLUMN: Í≥ºÍ±∞ (ÏôÑÎ£å + ÏßÄÎÇú Í∏∞Î°ù) ‚ïê‚ïê‚ïê
        h('div',{style:{flex:1,minWidth:0,overflowY:'auto'}},
          h('div',{style:{padding:'8px 12px 4px',background:C.card2,borderBottom:'1px solid '+C.border2,position:'sticky',top:0,zIndex:2}},
            h('span',{style:{fontSize:11,fontWeight:700,color:C.text2}},'‚úÖ Í≥ºÍ±∞'),
            h('span',{style:{fontSize:10,color:C.text3,marginLeft:6}},archive.length+'Í∞ú ÏôÑÎ£å'+(pastRecords.length?' ¬∑ '+pastRecords.length+'Í∞ú ÏßÄÎÇú Í∏∞Î°ù':''))
          ),
          !hasPast?h('div',{style:{...S.empty,height:'30vh'}},h('div',{style:{fontSize:28,marginBottom:6}},'üìã'),h('div',{style:{fontSize:12,color:C.text2}},'ÏôÑÎ£å Ìï≠Î™© ÏóÜÏùå')):null,
          pastRecords.length>0?h('div',null,
            h('div',{style:{padding:'6px 14px 2px',fontSize:10,fontWeight:600,color:C.text3,letterSpacing:.5}},'üìã ÏßÄÎÇú Í∏∞Î°ù'),
            ...pastRecords.map(pastRecEl)
          ):null,
          archive.length>0?h('div',null,
            pastRecords.length>0?h('div',{style:{padding:'6px 14px 2px',fontSize:10,fontWeight:600,color:C.text3,letterSpacing:.5}},'‚úÖ ÏôÑÎ£åÎêú Ìï† Ïùº'):null,
            ...archive.map(arcEl)
          ):null
        )
      ),
      fab,editM,editRM,confirmDialog,toastEl,notiAlertEl,fileInput,nav
    );
  }

  return h('div',{style:{...S.root,maxWidth:isWide?780:480}},header,searchP,h('div',{style:S.content},content),fab,editM,editRM,confirmDialog,toastEl,notiAlertEl,fileInput,nav);
}

const S={
  root:{width:'100%',maxWidth:480,margin:'0 auto',height:'100%',display:'flex',flexDirection:'column',background:C.bg,color:C.text,overflow:'hidden',position:'relative'},
  header:{padding:'max(env(safe-area-inset-top,16px),38px) 14px 8px',background:'linear-gradient(180deg,#EDE8E1,'+C.bg+')',borderBottom:'1px solid '+C.border},
  hDate:{fontSize:15,fontWeight:700,color:C.text,letterSpacing:-0.2},
  hCount:{fontSize:10,color:C.text3},
  hBtn:{background:C.card,border:'1px solid '+C.border,borderRadius:9,width:34,height:34,display:'flex',alignItems:'center',justifyContent:'center',cursor:'pointer',boxShadow:'0 1px 3px rgba(0,0,0,0.04)'},
  sPanel:{background:C.card2,borderBottom:'1px solid '+C.border,animation:'fadeUp 0.12s ease',maxHeight:'48vh',overflowY:'auto'},
  sWrap:{display:'flex',alignItems:'center',gap:7,padding:'9px 14px',borderBottom:'1px solid '+C.border2},
  sInput:{flex:1,background:'none',border:'none',outline:'none',color:C.text,fontSize:13},
  content:{flex:1,overflowY:'auto',paddingBottom:66,WebkitOverflowScrolling:'touch'},
  empty:{display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',height:'40vh',opacity:.6},
  tSm:{display:'inline-block',fontSize:8,fontWeight:600,padding:'1px 5px',borderRadius:10,border:'1px solid',letterSpacing:.2},
  addForm:{margin:'6px 10px',padding:14,background:C.card,borderRadius:12,border:'1px solid '+C.border,animation:'scaleIn 0.12s ease',boxShadow:'0 2px 8px rgba(0,0,0,0.04)'},
  segBtn:{border:'none',padding:'5px 14px',borderRadius:5,fontSize:12,fontWeight:600,cursor:'pointer'},
  closeBtn:{background:'none',border:'none',color:C.text3,fontSize:14,cursor:'pointer',padding:3},
  input:{width:'100%',padding:'9px 11px',background:C.bg,border:'1px solid '+C.border,borderRadius:7,color:C.text,fontSize:14,outline:'none',marginBottom:7},
  submitBtn:{width:'100%',padding:'10px',background:C.accent,color:'#FFF',border:'none',borderRadius:7,fontSize:13,fontWeight:600,cursor:'pointer',marginTop:2},
  delBtn:{width:'100%',padding:'9px',background:'transparent',color:C.red,border:'1px solid '+C.red+'30',borderRadius:7,fontSize:12,cursor:'pointer',marginTop:5},
  overlay:{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,0.35)',display:'flex',alignItems:'center',justifyContent:'center',zIndex:100,animation:'fadeIn 0.15s'},
  modal:{width:'100%',maxWidth:480,background:C.card,borderRadius:'16px 16px 0 0',padding:18,animation:'slideUp 0.2s ease',maxHeight:'75vh',overflowY:'auto',boxShadow:'0 -4px 20px rgba(0,0,0,0.1)',position:'fixed',bottom:0,left:'50%',transform:'translateX(-50%)'},
  fab:{position:'absolute',bottom:74,right:16,width:48,height:48,borderRadius:'50%',background:C.accent,color:'#FFF',border:'none',fontSize:24,fontWeight:300,cursor:'pointer',boxShadow:'0 3px 12px '+C.accent+'40',display:'flex',alignItems:'center',justifyContent:'center',zIndex:10},
  nav:{position:'absolute',bottom:0,left:0,right:0,display:'flex',background:C.card,borderTop:'1px solid '+C.border,padding:'5px 0 max(env(safe-area-inset-bottom,5px),12px)',zIndex:20},
  cNav:{background:'none',border:'none',cursor:'pointer',padding:4,display:'flex',alignItems:'center'},
  setS:{background:C.card,borderRadius:12,border:'1px solid '+C.border,padding:14,marginBottom:10,boxShadow:'0 1px 4px rgba(0,0,0,0.03)'},
  setST:{fontSize:12,fontWeight:600,color:C.text2,marginBottom:10},
  backupBtn:{flex:1,display:'flex',alignItems:'center',justifyContent:'center',gap:6,padding:'10px',border:'1px solid',borderRadius:8,fontSize:12,fontWeight:600,cursor:'pointer',background:'transparent'},
};

ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));

// ‚ïê‚ïê‚ïê SERVICE WORKER REGISTRATION ‚ïê‚ïê‚ïê
let swRegistration = null;

if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    // Force SW update check (bypass browser cache of sw.js)
    navigator.serviceWorker.register('./sw.js', { updateViaCache: 'none' })
      .then(reg => {
        swRegistration = reg;
        console.log('SW registered');
        // Force check for updates
        reg.update();
        // If there's a waiting SW, force it to activate
        if (reg.waiting) {
          reg.waiting.postMessage({ type: 'SKIP_WAITING' });
        }
        reg.addEventListener('updatefound', () => {
          const newSW = reg.installing;
          if (newSW) {
            newSW.addEventListener('statechange', () => {
              if (newSW.state === 'activated') {
                console.log('New SW activated');
              }
            });
          }
        });
      })
      .catch(err => console.log('SW registration failed:', err));
  });
}

// ‚ïê‚ïê‚ïê SYNC NOTIFICATIONS TO SERVICE WORKER ‚ïê‚ïê‚ïê
function syncNotificationsToSW() {
  if (!swRegistration || !swRegistration.active) return;
  try {
    const todos = JSON.parse(localStorage.getItem('td4-t') || '[]');
    const tags = JSON.parse(localStorage.getItem('td4-g') || '[]');
    const notified = JSON.parse(localStorage.getItem('td4-ni') || '[]');
    const now = Date.now();

    const notifications = [];
    todos.forEach(todo => {
      if (!todo.notiOn) return;
      let alertTime, notiKey, lbl;
      if (todo.notiAt) {
        alertTime = new Date(todo.notiAt).getTime();
        notiKey = todo.id + '_at_' + todo.notiAt;
        lbl = 'ÏïåÎ¶º';
      } else {
        const dt = new Date(todo.datetime).getTime();
        const beforeMs = (todo.notiBefore || 30) * 60000;
        alertTime = dt - beforeMs;
        notiKey = todo.id + '_' + todo.notiBefore;
        lbl = todo.notiBefore === 60 ? '1ÏãúÍ∞Ñ Ï†Ñ' : '30Î∂Ñ Ï†Ñ';
      }
      if (alertTime > now - 15000 && !notified.includes(notiKey)) {
        const tg = tags.find(t => t.id === todo.tagId);
        notifications.push({
          todoId: todo.id,
          key: notiKey,
          title: lbl,
          body: todo.title + (tg ? ' [' + tg.name + ']' : ''),
          alertTime: alertTime,
          fired: false
        });
      }
    });

    swRegistration.active.postMessage({
      type: 'SYNC_NOTIFICATIONS',
      notifications: notifications
    });
  } catch (e) {}
}

// Sync every 30 seconds and on visibility change
setInterval(syncNotificationsToSW, 30000);
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'hidden') syncNotificationsToSW();
});
// Initial sync after short delay
setTimeout(syncNotificationsToSW, 3000);

// ‚ïê‚ïê‚ïê PWA INSTALL PROMPT ‚ïê‚ïê‚ïê
let deferredPrompt = null;
window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredPrompt = e;
  // Show custom install button
  const btn = document.createElement('div');
  btn.id = 'pwa-install-bar';
  btn.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;gap:10px;padding:12px 16px;background:linear-gradient(135deg,#C8963E,#D4A84A);color:#FFF;font-family:Noto Sans KR,sans-serif;font-size:13px;font-weight:600;cursor:pointer;position:fixed;bottom:0;left:0;right:0;z-index:999;box-shadow:0 -2px 12px rgba(0,0,0,0.15)"><span>üì± Ïï±ÏúºÎ°ú ÏÑ§ÏπòÌïòÎ©¥ ÏïåÎ¶ºÏùÑ Îçî Ïûò Î∞õÏùÑ Ïàò ÏûàÏñ¥Ïöî</span><span style="background:rgba(255,255,255,0.25);padding:4px 12px;border-radius:20px;font-size:12px">ÏÑ§Ïπò</span></div>';
  document.body.appendChild(btn);
  btn.addEventListener('click', async () => {
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    const result = await deferredPrompt.userChoice;
    deferredPrompt = null;
    btn.remove();
  });
});

window.addEventListener('appinstalled', () => {
  const bar = document.getElementById('pwa-install-bar');
  if (bar) bar.remove();
  deferredPrompt = null;
});
</script>
</body>
</html>
