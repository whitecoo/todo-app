<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#F5F0EA">
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon-192.png">
<meta name="apple-mobile-web-app-status-bar-style" content="default">
<title>Ìï† Ïùº</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0;font-family:'Noto Sans KR',sans-serif;-webkit-tap-highlight-color:transparent}
html,body,#root{height:100%;width:100%;overflow:hidden;background:#F5F0EA}
input,select,button{font-family:'Noto Sans KR',sans-serif}
::-webkit-scrollbar{width:3px}
::-webkit-scrollbar-thumb{background:#D5CEC5;border-radius:4px}
input[type="color"]{-webkit-appearance:none;border:none;cursor:pointer}
input[type="color"]::-webkit-color-swatch-wrapper{padding:2px}
input[type="color"]::-webkit-color-swatch{border-radius:6px;border:2px solid #D5CEC5}
@keyframes fadeUp{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:translateY(0)}}
@keyframes scaleIn{from{opacity:0;transform:scale(0.97)}to{opacity:1;transform:scale(1)}}
@keyframes slideUp{from{transform:translateX(-50%) translateY(100%)}to{transform:translateX(-50%) translateY(0)}}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes toastIn{from{opacity:0;transform:translate(-50%,10px)}to{opacity:1;transform:translate(-50%,0)}}
@keyframes toastOut{from{opacity:1;transform:translate(-50%,0)}to{opacity:0;transform:translate(-50%,10px)}}
@keyframes popIn{from{opacity:0;transform:scale(0.95) translateY(-4px)}to{opacity:1;transform:scale(1) translateY(0)}}
@keyframes bannerSlide{from{opacity:0;transform:translateY(-100%)}to{opacity:1;transform:translateY(0)}}
@keyframes bellRing{0%{transform:rotate(0)}10%{transform:rotate(14deg)}20%{transform:rotate(-14deg)}30%{transform:rotate(10deg)}40%{transform:rotate(-10deg)}50%{transform:rotate(6deg)}60%{transform:rotate(-6deg)}70%{transform:rotate(2deg)}80%{transform:rotate(-2deg)}90%{transform:rotate(0)}100%{transform:rotate(0)}}
@keyframes drawerSlideIn{from{transform:translateX(-100%)}to{transform:translateX(0)}}
@keyframes drawerSlideOut{from{transform:translateX(0)}to{transform:translateX(-100%)}}
@keyframes drawerFadeIn{from{opacity:0}to{opacity:1}}
@keyframes drawerFadeOut{from{opacity:1}to{opacity:0}}
</style>
</head>
<body>
<div id="root"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script>
const{useState,useEffect,useCallback,useMemo,useRef,createElement:h}=React;
const DK=["Ïùº","Ïõî","Ìôî","Ïàò","Î™©","Í∏à","ÌÜ†"];
const DTAGS=[{id:"work",name:"ÏóÖÎ¨¥",color:"#3B82F6"},{id:"personal",name:"Í∞úÏù∏",color:"#10B981"},{id:"urgent",name:"Í∏¥Í∏â",color:"#EF4444"}];
const SK={t:"td4-t",a:"td4-a",g:"td4-g",r:"td4-r",noti:"td4-ni",sort:"td4-sort",dt:"td4-dt",showMS:"td4-sms",showRV:"td4-srv",rvColor:"td4-rvc",st:"td4-st",sr:"td4-sr",sdt:"td4-sdt",sa:"td4-sa",dark:"td4-dark",fbcfg:"td4-fbc",myCode:"td4-mc",pCode:"td4-pc",myName:"td4-mn"};
const NOTI_OPTS=[{v:30,l:'30Î∂Ñ Ï†Ñ'},{v:60,l:'1ÏãúÍ∞Ñ Ï†Ñ'},{v:120,l:'2ÏãúÍ∞Ñ Ï†Ñ'}];
function ld(k,f){try{const v=localStorage.getItem(k);return v?JSON.parse(v):f}catch(e){return f}}
function sv(k,v){try{localStorage.setItem(k,JSON.stringify(v))}catch(e){}}
function fmt(s){const d=new Date(s);return{m:d.getMonth()+1,d:d.getDate(),w:DK[d.getDay()],t:String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0')}}
function todayStr(){const n=new Date();return n.getFullYear()+'. '+String(n.getMonth()+1).padStart(2,'0')+'. '+String(n.getDate()).padStart(2,'0')+'. '+DK[n.getDay()]+'ÏöîÏùº'}
function todayParts(){const n=new Date();return{date:n.getFullYear()+'. '+String(n.getMonth()+1).padStart(2,'0')+'. '+String(n.getDate()).padStart(2,'0')+'.',day:DK[n.getDay()]+'ÏöîÏùº'}}
function toDS(d){return d.getFullYear()+'-'+String(d.getMonth()+1).padStart(2,'0')+'-'+String(d.getDate()).padStart(2,'0')}
function daysBetween(a,b){return Math.ceil((b-a)/(864e5))+1}
// ‚òÖ Parse date string as LOCAL time (not UTC) to fix timezone issues
function localDate(s){return new Date(s+'T00:00:00')}
function notiLabel(m){const o=NOTI_OPTS.find(x=>x.v===m);return o?o.l:'30Î∂Ñ Ï†Ñ'}

const CLt={bg:'#F5F0EA',card:'#FFFFFF',card2:'#FAF7F3',border:'#E8E2DA',border2:'#F0EBE4',text:'#2C2520',text2:'#8C7E72',text3:'#B8AEA2',accent:'#C8963E',accentBg:'#C8963E14',green:'#5A9E6F',greenBg:'#5A9E6F18',red:'#C45C5C'};
const CDk={bg:'#1C1917',card:'#292524',card2:'#1F1D1B',border:'#3D3530',border2:'#332E29',text:'#E8E0D8',text2:'#A89E94',text3:'#6D6560',accent:'#D4A54A',accentBg:'#D4A54A14',green:'#6BAF7F',greenBg:'#6BAF7F18',red:'#D46B6B'};
let C=CLt;

function SI(p){return h('svg',{width:p.z||17,height:p.z||17,viewBox:'0 0 24 24',fill:'none',stroke:p.c||C.text3,strokeWidth:2,strokeLinecap:'round',strokeLinejoin:'round'},h('circle',{cx:11,cy:11,r:8}),h('line',{x1:21,y1:21,x2:16.65,y2:16.65}))}
function CalI(p){return h('svg',{width:p.z||17,height:p.z||17,viewBox:'0 0 24 24',fill:'none',stroke:p.c||C.text3,strokeWidth:2,strokeLinecap:'round',strokeLinejoin:'round'},h('rect',{x:3,y:4,width:18,height:18,rx:2}),h('line',{x1:16,y1:2,x2:16,y2:6}),h('line',{x1:8,y1:2,x2:8,y2:6}),h('line',{x1:3,y1:10,x2:21,y2:10}))}
function LstI(p){return h('svg',{width:p.z||17,height:p.z||17,viewBox:'0 0 24 24',fill:'none',stroke:p.c||C.text3,strokeWidth:2,strokeLinecap:'round',strokeLinejoin:'round'},h('line',{x1:8,y1:6,x2:21,y2:6}),h('line',{x1:8,y1:12,x2:21,y2:12}),h('line',{x1:8,y1:18,x2:21,y2:18}),h('line',{x1:3,y1:6,x2:3.01,y2:6}),h('line',{x1:3,y1:12,x2:3.01,y2:12}),h('line',{x1:3,y1:18,x2:3.01,y2:18}))}
function CL(p){return h('svg',{width:p.z||16,height:p.z||16,viewBox:'0 0 24 24',fill:'none',stroke:p.c||C.text3,strokeWidth:2.5,strokeLinecap:'round',strokeLinejoin:'round'},h('polyline',{points:'15 18 9 12 15 6'}))}
function CR(p){return h('svg',{width:p.z||16,height:p.z||16,viewBox:'0 0 24 24',fill:'none',stroke:p.c||C.text3,strokeWidth:2.5,strokeLinecap:'round',strokeLinejoin:'round'},h('polyline',{points:'9 18 15 12 9 6'}))}
function BellI(p){return h('svg',{width:p.z||15,height:p.z||15,viewBox:'0 0 24 24',fill:p.fill||'none',stroke:p.c||C.text3,strokeWidth:2,strokeLinecap:'round',strokeLinejoin:'round'},h('path',{d:'M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9'}),h('path',{d:'M13.73 21a2 2 0 0 1-3.46 0'}))}
function BellOff(p){return h('svg',{width:p.z||15,height:p.z||15,viewBox:'0 0 24 24',fill:'none',stroke:p.c||C.text3,strokeWidth:2,strokeLinecap:'round',strokeLinejoin:'round'},h('path',{d:'M13.73 21a2 2 0 0 1-3.46 0'}),h('path',{d:'M18.63 13A17.89 17.89 0 0 1 18 8'}),h('path',{d:'M6.26 6.26A5.86 5.86 0 0 0 6 8c0 7-3 9-3 9h14'}),h('path',{d:'M18 8a6 6 0 0 0-9.33-5'}),h('line',{x1:1,y1:1,x2:23,y2:23}))}
function UndoI(p){return h('svg',{width:p.z||14,height:p.z||14,viewBox:'0 0 24 24',fill:'none',stroke:p.c||C.text3,strokeWidth:2,strokeLinecap:'round',strokeLinejoin:'round'},h('polyline',{points:'1 4 1 10 7 10'}),h('path',{d:'M3.51 15a9 9 0 1 0 2.13-9.36L1 10'}))}
function DlI(p){return h('svg',{width:p.z||14,height:p.z||14,viewBox:'0 0 24 24',fill:'none',stroke:p.c||C.text3,strokeWidth:2,strokeLinecap:'round',strokeLinejoin:'round'},h('path',{d:'M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4'}),h('polyline',{points:'7 10 12 15 17 10'}),h('line',{x1:12,y1:15,x2:12,y2:3}))}
function UlI(p){return h('svg',{width:p.z||14,height:p.z||14,viewBox:'0 0 24 24',fill:'none',stroke:p.c||C.text3,strokeWidth:2,strokeLinecap:'round',strokeLinejoin:'round'},h('path',{d:'M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4'}),h('polyline',{points:'17 8 12 3 7 8'}),h('line',{x1:12,y1:3,x2:12,y2:15}))}
// ‚òÖ NEW: Sort icon
function SortI(p){return h('svg',{width:p.z||17,height:p.z||17,viewBox:'0 0 24 24',fill:'none',stroke:p.c||C.text3,strokeWidth:2,strokeLinecap:'round',strokeLinejoin:'round'},h('line',{x1:4,y1:6,x2:13,y2:6}),h('line',{x1:4,y1:12,x2:10,y2:12}),h('line',{x1:4,y1:18,x2:7,y2:18}),h('polyline',{points:'18 9 21 6 18 3'}),h('line',{x1:21,y1:6,x2:21,y2:21}))}
function SharePI(p){return h('svg',{width:p.z||15,height:p.z||15,viewBox:'0 0 24 24',fill:p.fill||'none',stroke:p.c||C.text3,strokeWidth:2,strokeLinecap:'round',strokeLinejoin:'round'},h('path',{d:'M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2'}),h('circle',{cx:12,cy:7,r:4}))}
function MenuI(p){return h('svg',{width:p.z||18,height:p.z||18,viewBox:'0 0 24 24',fill:'none',stroke:p.c||C.text2,strokeWidth:2,strokeLinecap:'round'},h('line',{x1:3,y1:6,x2:21,y2:6}),h('line',{x1:3,y1:12,x2:21,y2:12}),h('line',{x1:3,y1:18,x2:21,y2:18}))}

function App(){
  const[todos,setTodos]=useState(()=>ld(SK.t,[]));
  const[archive,setArchive]=useState(()=>ld(SK.a,[]));
  const[tags,setTags]=useState(()=>ld(SK.g,DTAGS));
  const[records,setRecords]=useState(()=>ld(SK.r,[]));
  const[tab,setTab]=useState('current');
  const[showAdd,setShowAdd]=useState(false);
  const[addMode,setAddMode]=useState('todo');
  const[fadingOut,setFadingOut]=useState(new Set());
  const[nT,sNT]=useState('');const[nD,sND]=useState('');const[nTi,sNTi]=useState('');const[nTg,sNTg]=useState('');
  const[nNotiOn,sNNotiOn]=useState(true);const[nNotiBefore,sNNotiBefore]=useState(30);
  const[nNotiAtD,sNNotiAtD]=useState('');const[nNotiAtT,sNNotiAtT]=useState('');
  const[nMemo,sNMemo]=useState('');
  const[nCL,sNCL]=useState([]);const[nCLInput,sNCLInput]=useState('');const[nCLOpen,sNCLOpen]=useState(false);
  const[nRepeat,sNRepeat]=useState('none');
  const[nRepeatEnd,sNRepeatEnd]=useState('');
  const[rT,sRT]=useState('');const[rSD,sRSD]=useState('');const[rED,sRED]=useState('');const[rTg,sRTg]=useState('');
  const[rMemo,sRMemo]=useState('');
  const[showSearch,setShowSearch]=useState(false);const[sq,sSq]=useState('');const[sqDate,sSqDate]=useState('');
  const[nTgN,sNTgN]=useState('');const[nTgC,sNTgC]=useState('#6366F1');
  const[editTodo,setEditTodo]=useState(null);
  const[eT,sET]=useState('');const[eD,sED]=useState('');const[eTi,sETi]=useState('');const[eTg,sETg]=useState('');
  const[eNotiOn,sENotiOn]=useState(true);const[eNotiBefore,sENotiBefore]=useState(30);
  const[eNotiAtD,sENotiAtD]=useState('');const[eNotiAtT,sENotiAtT]=useState('');
  const[eMemo,sEMemo]=useState('');
  const[eCL,sECL]=useState([]);const[eCLInput,sECLInput]=useState('');const[eCLOpen,sECLOpen]=useState(false);
  
  const[editRec,setEditRec]=useState(null);
  const[erT,sERT]=useState('');const[erSD,sERSD]=useState('');const[erED,sERED]=useState('');const[erTg,sERTg]=useState('');
  const[erMemo,sERMemo]=useState('');
  const[viewOnly,setViewOnly]=useState(false);
  const[editSource,setEditSource]=useState('personal');
  const[editOrigSrc,setEditOrigSrc]=useState('personal');
  const[writeMode,setWriteMode]=useState('personal');
  const[vm,setVm]=useState('list');
  const[cm,setCm]=useState(()=>{const n=new Date();return{y:n.getFullYear(),m:n.getMonth()}});
  const[notiPerm,setNotiPerm]=useState(typeof Notification!=='undefined'?Notification.permission:'denied');
  const notifiedRef=useRef(ld(SK.noti,[]));
  const[confirm,setConfirm]=useState(null);
  const[toast,setToast]=useState(null);
  const toastTimer=useRef(null);
  const[isWide,setIsWide]=useState(window.innerWidth>=580);
  // ‚òÖ NEW: Sort mode & dropdown
  const[sortMode,setSortMode]=useState(()=>ld(SK.sort,'date'));
  const[showSortMenu,setShowSortMenu]=useState(false);
  const sortRef=useRef(null);
  const[filterTag,setFilterTag]=useState('all');
  // ‚òÖ Daily tasks (Ïò§Îäò Ìï† Ïùº)
  const[dailyTasks,setDailyTasks]=useState(()=>ld(SK.dt,[]));
  const[dtInput,setDtInput]=useState('');
  const[dtShareMode,setDtShareMode]=useState(false);
  const[showDtSection,setShowDtSection]=useState(true);
  const[showYesterdayPrompt,setShowYesterdayPrompt]=useState(false);
  const[yesterdayItems,setYesterdayItems]=useState([]);
  // ‚òÖ DRAWER states
  const[showDrawer,setShowDrawer]=useState(false);
  const[drawerClosing,setDrawerClosing]=useState(false);
  const[showMyShared,setShowMyShared]=useState(()=>ld(SK.showMS,true));
  const[showReceived,setShowReceived]=useState(()=>ld(SK.showRV,true));
  const[rvColor,setRvColor]=useState(()=>ld(SK.rvColor,'#E91E8B'));
  const touchStartRef=useRef(null);
  // ‚òÖ SHARED DATA states
  const[shTodos,setShTodos]=useState(()=>ld(SK.st,[]));
  const[shRecords,setShRecords]=useState(()=>ld(SK.sr,[]));
  const[shDailyTasks,setShDailyTasks]=useState(()=>ld(SK.sdt,[]));
  const[shArchive,setShArchive]=useState(()=>ld(SK.sa,[]));
  const[dark,setDark]=useState(()=>ld(SK.dark,false));
  const toggleDark=v=>{setDark(v);sv(SK.dark,v)};
  // ‚òÖ Sync body/meta with dark mode
  useEffect(()=>{
    document.body.style.background=dark?CDk.bg:CLt.bg;
    document.documentElement.style.background=dark?CDk.bg:CLt.bg;
    const meta=document.querySelector('meta[name="theme-color"]');
    if(meta)meta.setAttribute('content',dark?CDk.bg:CLt.bg);
    // Scrollbar
    const sheet=document.styleSheets[0];
    try{
      for(let i=sheet.cssRules.length-1;i>=0;i--){if(sheet.cssRules[i].selectorText==='::-webkit-scrollbar-thumb')sheet.deleteRule(i)}
      sheet.insertRule('::-webkit-scrollbar-thumb{background:'+(dark?'#4A4440':'#D5CEC5')+';border-radius:4px}',sheet.cssRules.length);
    }catch(e){}
  },[dark]);
  // ‚òÖ Apply theme
  C=dark?CDk:CLt;
  const S={
    root:{width:'100%',maxWidth:480,margin:'0 auto',height:'100%',display:'flex',flexDirection:'column',background:C.bg,color:C.text,overflow:'hidden',position:'relative'},
    header:{padding:'max(env(safe-area-inset-top,16px),38px) 14px 8px',background:dark?C.card:('linear-gradient(180deg,#EDE8E1,'+C.bg+')'),borderBottom:'1px solid '+C.border},
    hDate:{fontSize:15,fontWeight:700,color:C.text,letterSpacing:-0.2},
    hCount:{fontSize:10,color:C.text3},
    hBtn:{background:C.card,border:'1px solid '+C.border,borderRadius:9,width:34,height:34,display:'flex',alignItems:'center',justifyContent:'center',cursor:'pointer',boxShadow:dark?'none':'0 1px 3px rgba(0,0,0,0.04)'},
    sPanel:{background:C.card2,borderBottom:'1px solid '+C.border,animation:'fadeUp 0.12s ease',maxHeight:'48vh',overflowY:'auto'},
    sWrap:{display:'flex',alignItems:'center',gap:7,padding:'9px 14px',borderBottom:'1px solid '+C.border2},
    sInput:{flex:1,background:'none',border:'none',outline:'none',color:C.text,fontSize:13},
    content:{flex:1,overflowY:'auto',paddingBottom:66,WebkitOverflowScrolling:'touch'},
    empty:{display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'center',height:'40vh',opacity:.6},
    tSm:{display:'inline-block',fontSize:8,fontWeight:600,padding:'1px 5px',borderRadius:10,border:'1px solid',letterSpacing:.2},
    addForm:{margin:'6px 10px',padding:14,background:C.card,borderRadius:12,border:'1px solid '+C.border,animation:'scaleIn 0.12s ease',boxShadow:dark?'none':'0 2px 8px rgba(0,0,0,0.04)'},
    segBtn:{border:'none',padding:'5px 14px',borderRadius:5,fontSize:12,fontWeight:600,cursor:'pointer'},
    closeBtn:{background:'none',border:'none',color:C.text3,fontSize:14,cursor:'pointer',padding:3},
    input:{width:'100%',padding:'9px 11px',background:C.bg,border:'1px solid '+C.border,borderRadius:7,color:C.text,fontSize:14,outline:'none',marginBottom:7},
    submitBtn:{width:'100%',padding:'10px',background:C.accent,color:'#FFF',border:'none',borderRadius:7,fontSize:13,fontWeight:600,cursor:'pointer',marginTop:2},
    delBtn:{width:'100%',padding:'9px',background:'transparent',color:C.red,border:'1px solid '+C.red+'30',borderRadius:7,fontSize:12,cursor:'pointer',marginTop:5},
    overlay:{position:'fixed',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,'+(dark?'0.5':'0.35')+')',display:'flex',alignItems:'center',justifyContent:'center',zIndex:100,animation:'fadeIn 0.15s'},
    modal:{width:'100%',maxWidth:480,background:C.card,borderRadius:'16px 16px 0 0',padding:18,animation:'slideUp 0.2s ease',maxHeight:'75vh',overflowY:'auto',boxShadow:'0 -4px 20px rgba(0,0,0,'+(dark?'0.3':'0.1')+')',position:'fixed',bottom:0,left:'50%',transform:'translateX(-50%)'},
    fab:{position:'absolute',bottom:74,right:16,width:48,height:48,borderRadius:'50%',background:C.accent,color:'#FFF',border:'none',fontSize:24,fontWeight:300,cursor:'pointer',boxShadow:'0 3px 12px '+C.accent+'40',display:'flex',alignItems:'center',justifyContent:'center',zIndex:10},
    nav:{position:'absolute',bottom:0,left:0,right:0,display:'flex',background:C.card,borderTop:'1px solid '+C.border,padding:'5px 0 max(env(safe-area-inset-bottom,5px),12px)',zIndex:20},
    cNav:{background:'none',border:'none',cursor:'pointer',padding:4,display:'flex',alignItems:'center'},
    setS:{background:C.card,borderRadius:12,border:'1px solid '+C.border,padding:14,marginBottom:10,boxShadow:dark?'none':'0 1px 4px rgba(0,0,0,0.03)'},
    setST:{fontSize:12,fontWeight:600,color:C.text2,marginBottom:10},
    backupBtn:{flex:1,display:'flex',alignItems:'center',justifyContent:'center',gap:6,padding:'10px',border:'1px solid',borderRadius:8,fontSize:12,fontWeight:600,cursor:'pointer',background:'transparent'},
  };
  // ‚ïê‚ïê‚ïê FIREBASE REALTIME SHARING ‚ïê‚ïê‚ïê
  const[fbConfig,setFbConfig]=useState(()=>ld(SK.fbcfg,null));
  const[myCode,setMyCode]=useState(()=>ld(SK.myCode,''));
  const[partnerCode,setPartnerCode]=useState(()=>ld(SK.pCode,''));
  const[myName,setMyName]=useState(()=>ld(SK.myName,'ÎÇò'));
  const[fbConnected,setFbConnected]=useState(false);
  const[fbError,setFbError]=useState('');
  const[fbSyncing,setFbSyncing]=useState(false);
  const[rcvTodosLive,setRcvTodosLive]=useState([]);
  const[rcvRecordsLive,setRcvRecordsLive]=useState([]);
  const[rcvArchiveLive,setRcvArchiveLive]=useState([]);
  const[rcvDTLive,setRcvDTLive]=useState([]);
  const[partnerProfile,setPartnerProfile]=useState(null);
  const fbRef=useRef(null);
  const fbWriteTimer=useRef(null);

  const genCode=()=>{const c='ABCDEFGHJKLMNPQRSTUVWXYZ23456789';let r='';for(let i=0;i<6;i++)r+=c[Math.floor(Math.random()*c.length)];return r};

  const saveFbConfig=(cfg)=>{setFbConfig(cfg);sv(SK.fbcfg,cfg)};
  const saveMyCode=(c)=>{setMyCode(c);sv(SK.myCode,c)};
  const savePartnerCode=(c)=>{setPartnerCode(c);sv(SK.pCode,c)};
  const saveMyName=(n)=>{setMyName(n);sv(SK.myName,n)};

  // Initialize Firebase
  useEffect(()=>{
    if(!fbConfig){setFbConnected(false);return}
    try{
      if(typeof firebase==='undefined'){setFbError('Firebase SDK Î°úÎìú Ïã§Ìå®');return}
      if(!firebase.apps.length)firebase.initializeApp(fbConfig);
      fbRef.current=firebase.database();
      // Test connection
      const connRef=fbRef.current.ref('.info/connected');
      connRef.on('value',snap=>{setFbConnected(!!snap.val())});
      setFbError('');
    }catch(e){setFbError(e.message);setFbConnected(false)}
  },[fbConfig]);

  // WRITE: Sync my shared data TO Firebase (debounced)
  useEffect(()=>{
    if(!fbConnected||!myCode||!fbRef.current)return;
    if(fbWriteTimer.current)clearTimeout(fbWriteTimer.current);
    fbWriteTimer.current=setTimeout(()=>{
      setFbSyncing(true);
      fbRef.current.ref('shares/'+myCode).set({
        profile:{name:myName,updatedAt:new Date().toISOString()},
        todos:shTodos,records:shRecords,archive:shArchive,dailyTasks:shDailyTasks
      }).then(()=>setFbSyncing(false)).catch(e=>{console.log('FB write:',e);setFbSyncing(false)});
    },1500);
    return()=>{if(fbWriteTimer.current)clearTimeout(fbWriteTimer.current)};
  },[fbConnected,myCode,myName,shTodos,shRecords,shArchive,shDailyTasks]);

  // READ: Listen to partner's data FROM Firebase
  useEffect(()=>{
    if(!fbConnected||!partnerCode||!fbRef.current){
      setRcvTodosLive([]);setRcvRecordsLive([]);setRcvArchiveLive([]);setRcvDTLive([]);setPartnerProfile(null);return;
    }
    const ref=fbRef.current.ref('shares/'+partnerCode);
    const handler=ref.on('value',snap=>{
      const data=snap.val();
      if(!data){setRcvTodosLive([]);setRcvRecordsLive([]);setRcvArchiveLive([]);setRcvDTLive([]);setPartnerProfile(null);return}
      const owner=data.profile?.name||'ÏÉÅÎåÄÎ∞©';
      setPartnerProfile(data.profile||null);
      setRcvTodosLive((data.todos||[]).map(t=>({...t,_owner:owner})));
      setRcvRecordsLive((data.records||[]).map(r=>({...r,_owner:owner})));
      setRcvArchiveLive((data.archive||[]).map(a=>({...a,_owner:owner})));
      setRcvDTLive((data.dailyTasks||[]).map(d=>({...d,_owner:owner})));
    });
    return()=>ref.off('value',handler);
  },[fbConnected,partnerCode]);

  // ‚òÖ RECEIVED data: Firebase live ‚Üí fallback dummy
  const dummyRcvTodos=useMemo(()=>{
    if(fbConfig)return[];// Firebase ÏÑ§Ï†ïÎê® ‚Üí ÎçîÎØ∏ Ïïà ÏîÄ
    const td=new Date(),y=td.getFullYear(),m=td.getMonth(),d=td.getDate();
    return[
      {id:'rcv1',title:'ÌåÄ ÌöåÏùò Ï∞∏ÏÑù (Îç∞Î™®)',datetime:new Date(y,m,d+1,10,0).toISOString(),tagId:null,notiOn:false,memo:'ÌöåÏùòÏã§ B',createdAt:new Date().toISOString(),_owner:'Îç∞Î™®'},
      {id:'rcv2',title:'ÌîÑÎ°úÏ†ùÌä∏ ÎßàÍ∞êÏùº (Îç∞Î™®)',datetime:new Date(y,m,d+3,18,0).toISOString(),tagId:null,notiOn:false,memo:'ÏµúÏ¢Ö Î≥¥Í≥†ÏÑú Ï†úÏ∂ú',createdAt:new Date().toISOString(),_owner:'Îç∞Î™®'},
    ];
  },[fbConfig]);
  const dummyRcvRecords=useMemo(()=>{
    if(fbConfig)return[];
    const td=new Date(),y=td.getFullYear(),m=td.getMonth(),d=td.getDate();
    return[{id:'rcvr1',title:'ÌåÄ ÏõåÌÅ¨Ïàç (Îç∞Î™®)',startDate:toDS(new Date(y,m,d+2)),endDate:toDS(new Date(y,m,d+4)),tagId:null,memo:'Ïû•ÏÜå: Ïó∞ÏàòÏõê',createdAt:new Date().toISOString(),_owner:'Îç∞Î™®'}];
  },[fbConfig]);
  const dummyRcvArchive=useMemo(()=>{
    if(fbConfig)return[];
    return[{id:'rcva1',title:'ÏßÄÎÇúÏ£º ÌöåÏùòÎ°ù Ï†ïÎ¶¨ (Îç∞Î™®)',datetime:new Date(new Date().getFullYear(),new Date().getMonth(),new Date().getDate()-2,14,0).toISOString(),completedAt:new Date(new Date().getFullYear(),new Date().getMonth(),new Date().getDate()-1,16,0).toISOString(),tagId:null,memo:'',_owner:'Îç∞Î™®'}];
  },[fbConfig]);

  const rcvTodos=fbConnected&&partnerCode?rcvTodosLive:dummyRcvTodos;
  const rcvRecords=fbConnected&&partnerCode?rcvRecordsLive:dummyRcvRecords;
  const rcvArchive=fbConnected&&partnerCode?rcvArchiveLive:dummyRcvArchive;
  useEffect(()=>{
    const onResize=()=>{
      const wide=window.innerWidth>=580;
      setIsWide(wide);
      // Wide mode: auto-switch from archive tab (since it's visible in split view)
      if(wide)setTab(p=>p==='archive'?'current':p);
    };
    window.addEventListener('resize',onResize);
    const onOrient=()=>setTimeout(onResize,300);
    window.addEventListener('orientationchange',onOrient);
    let screenOrient=null;
    if(window.screen?.orientation){
      screenOrient=window.screen.orientation;
      screenOrient.addEventListener('change',onOrient);
    }
    return()=>{
      window.removeEventListener('resize',onResize);
      window.removeEventListener('orientationchange',onOrient);
      if(screenOrient)screenOrient.removeEventListener('change',onOrient);
    };
  },[]);

  // Close sort menu on outside click
  useEffect(()=>{
    if(!showSortMenu)return;
    const handler=e=>{if(sortRef.current&&!sortRef.current.contains(e.target))setShowSortMenu(false)};
    document.addEventListener('pointerdown',handler);
    return()=>document.removeEventListener('pointerdown',handler);
  },[showSortMenu]);

  const changeSortMode=mode=>{setSortMode(mode);sv(SK.sort,mode);setShowSortMenu(false)};

  // ‚òÖ DRAWER helpers
  const openDrawer=()=>{setDrawerClosing(false);setShowDrawer(true)};
  const closeDrawer=()=>{setDrawerClosing(true);setTimeout(()=>{setShowDrawer(false);setDrawerClosing(false)},250)};
  const toggleShowMS=v=>{setShowMyShared(v);sv(SK.showMS,v)};
  const toggleShowRV=v=>{setShowReceived(v);sv(SK.showRV,v)};
  const changeRvColor=c=>{setRvColor(c);sv(SK.rvColor,c)};
  const sharedViewOn=showMyShared||showReceived;
  const quickToggleShared=()=>{const next=!(showMyShared&&showReceived);toggleShowMS(next);toggleShowRV(next)};

  // ‚òÖ Swipe gesture for drawer
  useEffect(()=>{
    const onTS=e=>{const t=e.touches[0];if(t.clientX<30&&!showDrawer)touchStartRef.current={x:t.clientX,y:t.clientY}};
    const onTM=e=>{if(!touchStartRef.current)return;const dx=e.touches[0].clientX-touchStartRef.current.x;const dy=Math.abs(e.touches[0].clientY-touchStartRef.current.y);if(dx>50&&dy<80){openDrawer();touchStartRef.current=null}};
    const onTE=()=>{touchStartRef.current=null};
    document.addEventListener('touchstart',onTS,{passive:true});
    document.addEventListener('touchmove',onTM,{passive:true});
    document.addEventListener('touchend',onTE,{passive:true});
    return()=>{document.removeEventListener('touchstart',onTS);document.removeEventListener('touchmove',onTM);document.removeEventListener('touchend',onTE)};
  },[showDrawer]);

  const showToast=(msg,duration)=>{
    if(toastTimer.current)clearTimeout(toastTimer.current);
    setToast({msg,out:false});
    toastTimer.current=setTimeout(()=>{
      setToast(p=>p?{...p,out:true}:null);
      setTimeout(()=>setToast(null),250);
    },duration||2000);
  };

  const sT=useCallback(t=>{setTodos(t);sv(SK.t,t);setTimeout(()=>{if(typeof syncNotificationsToSW==='function')syncNotificationsToSW()},500)},[]);
  const sA=useCallback(a=>{setArchive(a);sv(SK.a,a)},[]);
  const sTg=useCallback(t=>{setTags(t);sv(SK.g,t)},[]);
  const sR=useCallback(r=>{setRecords(r);sv(SK.r,r)},[]);
  const sShT=useCallback(t=>{setShTodos(t);sv(SK.st,t);setTimeout(()=>{if(typeof syncNotificationsToSW==='function')syncNotificationsToSW()},500)},[]);
  const sShR=useCallback(r=>{setShRecords(r);sv(SK.sr,r)},[]);
  const sShDT=useCallback(dt=>{setShDailyTasks(dt);sv(SK.sdt,dt)},[]);
  const sShA=useCallback(a=>{setShArchive(a);sv(SK.sa,a)},[]);
  const gT=id=>tags.find(t=>t.id===id);

  const askConfirm=(title,msg,onOk,okLabel,okColor)=>{
    setConfirm({title,msg,onOk:()=>{onOk();setConfirm(null)},onCancel:()=>setConfirm(null),okLabel:okLabel||'ÏÇ≠Ï†ú',okColor:okColor||C.red});
  };

  // ‚ïê‚ïê‚ïê NOTIFICATION SOUND & VIBRATION ‚ïê‚ïê‚ïê
  const[soundOn,setSoundOn]=useState(()=>ld('td4-snd',true));
  const[vibrateOn,setVibrateOn]=useState(()=>ld('td4-vib',true));
  const[notiAlert,setNotiAlert]=useState(null);
  const notiAlertTimer=useRef(null);
  const alarmLoopRef=useRef(null);
  const audioCtxRef=useRef(null);

  const toggleSound=v=>{setSoundOn(v);sv('td4-snd',v)};
  const toggleVibrate=v=>{setVibrateOn(v);sv('td4-vib',v)};

  const getAudioCtx=()=>{
    if(!audioCtxRef.current){
      const AC=window.AudioContext||window.webkitAudioContext;
      if(AC)audioCtxRef.current=new AC();
    }
    return audioCtxRef.current;
  };

  // Play one chime
  const playChimeOnce=()=>{
    try{
      const ctx=getAudioCtx();
      if(!ctx)return;
      if(ctx.state==='suspended')ctx.resume();
      const now=ctx.currentTime;
      const notes=[880,1108.73,1318.51];
      notes.forEach((freq,i)=>{
        const osc=ctx.createOscillator();
        const gain=ctx.createGain();
        osc.type='sine';
        osc.frequency.setValueAtTime(freq,now+i*0.12);
        gain.gain.setValueAtTime(0,now+i*0.12);
        gain.gain.linearRampToValueAtTime(0.25,now+i*0.12+0.03);
        gain.gain.exponentialRampToValueAtTime(0.001,now+i*0.12+0.5);
        osc.connect(gain);gain.connect(ctx.destination);
        osc.start(now+i*0.12);osc.stop(now+i*0.12+0.55);
      });
      setTimeout(()=>{
        const now2=ctx.currentTime;
        notes.forEach((freq,i)=>{
          const osc=ctx.createOscillator();
          const gain=ctx.createGain();
          osc.type='sine';
          osc.frequency.setValueAtTime(freq,now2+i*0.1);
          gain.gain.setValueAtTime(0,now2+i*0.1);
          gain.gain.linearRampToValueAtTime(0.2,now2+i*0.1+0.03);
          gain.gain.exponentialRampToValueAtTime(0.001,now2+i*0.1+0.4);
          osc.connect(gain);gain.connect(ctx.destination);
          osc.start(now2+i*0.1);osc.stop(now2+i*0.1+0.45);
        });
      },600);
    }catch(e){}
  };

  const stopAlarmLoop=()=>{
    if(alarmLoopRef.current){clearInterval(alarmLoopRef.current);alarmLoopRef.current=null}
    try{if(navigator.vibrate)navigator.vibrate(0)}catch(e){}
  };

  // ‚òÖ Start persistent alarm loop (repeats until stopped)
  const startAlarmLoop=()=>{
    stopAlarmLoop();
    // Play once immediately
    if(soundOn)playChimeOnce();
    if(vibrateOn)try{navigator.vibrate&&navigator.vibrate([300,150,300,150,400])}catch(e){}
    // Repeat every 3.5 seconds
    alarmLoopRef.current=setInterval(()=>{
      if(soundOn)playChimeOnce();
      if(vibrateOn)try{navigator.vibrate&&navigator.vibrate([300,150,300,150,400])}catch(e){}
    },3500);
    // Safety: stop after 60 seconds max
    setTimeout(()=>stopAlarmLoop(),60000);
  };

  const showNotiAlert=(title,body,color)=>{
    if(notiAlertTimer.current)clearTimeout(notiAlertTimer.current);
    setNotiAlert({title,body,color,out:false});
    // Start alarm loop (keeps ringing until dismissed)
    startAlarmLoop();
    // Auto-stop after 60 seconds
    notiAlertTimer.current=setTimeout(()=>{
      dismissNotiAlert();
    },60000);
  };

  const dismissNotiAlert=()=>{
    stopAlarmLoop();
    setNotiAlert(p=>p?{...p,out:true}:null);
    setTimeout(()=>setNotiAlert(null),300);
    if(notiAlertTimer.current){clearTimeout(notiAlertTimer.current);notiAlertTimer.current=null}
  };

  // Initialize audio context on first user interaction (required by browsers)
  useEffect(()=>{
    const initAudio=()=>{getAudioCtx();document.removeEventListener('touchstart',initAudio);document.removeEventListener('click',initAudio)};
    document.addEventListener('touchstart',initAudio,{once:true});
    document.addEventListener('click',initAudio,{once:true});
    return()=>{document.removeEventListener('touchstart',initAudio);document.removeEventListener('click',initAudio)};
  },[]);

  // ‚ïê‚ïê‚ïê NOTIFICATIONS ‚ïê‚ïê‚ïê
  const requestNoti=()=>{
    if(typeof Notification==='undefined')return;
    Notification.requestPermission().then(p=>{setNotiPerm(p)});
  };
  useEffect(()=>{
    const iv=setInterval(()=>{
      const now=Date.now();
      [...todos,...shTodos].forEach(todo=>{
        if(!todo.notiOn)return;
        // ‚òÖ Calculate alertTime: notiAt (custom time) takes priority over notiBefore
        let alertTime,notiKey;
        if(todo.notiAt){
          alertTime=new Date(todo.notiAt).getTime();
          notiKey=todo.id+'_at_'+todo.notiAt;
        }else{
          const dt=new Date(todo.datetime).getTime();
          const beforeMs=(todo.notiBefore||30)*60000;
          alertTime=dt-beforeMs;
          notiKey=todo.id+'_'+todo.notiBefore;
        }
        const diff=alertTime-now;
        if(diff>=-15000&&diff<=15000&&!notifiedRef.current.includes(notiKey)){
          notifiedRef.current=[...notifiedRef.current,notiKey];
          sv(SK.noti,notifiedRef.current);
          const tg=tags.find(t=>t.id===todo.tagId);
          const lbl=todo.notiAt?'ÏïåÎ¶º':notiLabel(todo.notiBefore||30);
          const bodyText=todo.title+(tg?' ['+tg.name+']':'');
          const tgColor=tg?tg.color:C.accent;

          // 1+2) Persistent alarm (sound+vibrate loop via showNotiAlert)
          showNotiAlert(lbl,bodyText,tgColor);
          // 3) System notification via Service Worker
          if(notiPerm==='granted'){
            try{
              if(typeof swRegistration!=='undefined'&&swRegistration&&swRegistration.active){
                swRegistration.showNotification(lbl,{body:bodyText,icon:'./icon-192.png',badge:'./icon-192.png',vibrate:[300,150,300,150,400],tag:notiKey,requireInteraction:true,actions:[{action:'confirm',title:'‚úì ÌôïÏù∏'},{action:'dismiss',title:'Îã´Í∏∞'}]});
              }else{
                new Notification(lbl,{body:bodyText,vibrate:[300,150,300,150,400],tag:notiKey,requireInteraction:true});
              }
            }catch(e){}
          }
          setTimeout(()=>{if(typeof syncNotificationsToSW==='function')syncNotificationsToSW()},1000);
        }
      });
    },5000);
    return()=>clearInterval(iv);
  },[todos,shTodos,tags,notiPerm,soundOn,vibrateOn]);
  useEffect(()=>{
    const ids=new Set([...todos,...shTodos].map(t=>t.id));
    const cleaned=notifiedRef.current.filter(k=>ids.has(k.split('_')[0]));
    if(cleaned.length!==notifiedRef.current.length){notifiedRef.current=cleaned;sv(SK.noti,cleaned)}
  },[todos,shTodos]);

  // ‚ïê‚ïê‚ïê CORE DATE REFERENCES ‚ïê‚ïê‚ïê
  const td=new Date();
  const todayDS=toDS(td);

  // ‚ïê‚ïê‚ïê CRUD ‚ïê‚ïê‚ïê
  // ‚òÖ Repeat helpers
  const repeatOpts=[{v:'none',l:'ÏóÜÏùå'},{v:'daily',l:'Îß§Ïùº'},{v:'weekly',l:'Îß§Ï£º'},{v:'monthly',l:'Îß§Ïõî'}];
  const repeatLabel=r=>{const o=repeatOpts.find(x=>x.v===r);return o?o.l:'ÏóÜÏùå'};
  // ‚òÖ Generate ALL repeat instances until endDateStr (or Dec 31 of current year)
  const genRepeatItems=(baseItem,rp,endDateStr)=>{
    const items=[];
    const endDate=endDateStr?new Date(endDateStr+'T23:59:59'):new Date(new Date().getFullYear(),11,31,23,59);
    const base=new Date(baseItem.datetime);
    const groupId='rg_'+Date.now();
    items.push({...baseItem,repeatGroupId:groupId,repeatType:rp,repeatEndDate:endDateStr||null});
    let cur=new Date(base);
    let idx=1;
    while(true){
      if(rp==='daily')cur.setDate(cur.getDate()+1);
      else if(rp==='weekly')cur.setDate(cur.getDate()+7);
      else if(rp==='monthly')cur.setMonth(cur.getMonth()+1);
      if(cur>endDate)break;
      if(idx>730)break;
      items.push({...baseItem,id:baseItem.id+'_'+idx,datetime:cur.toISOString(),repeatGroupId:groupId,repeatType:rp,repeatEndDate:endDateStr||null,checklist:baseItem.checklist?baseItem.checklist.map(c=>({...c,done:false})):[]});
      idx++;
    }
    return items;
  };
  const addTodo=()=>{
    if(!nT.trim())return;
    const dt=nD&&nTi?nD+'T'+nTi:nD?nD+'T00:00':new Date().toISOString();
    const notiAt=(nNotiBefore==='custom'&&nNotiAtD&&nNotiAtT)?nNotiAtD+'T'+nNotiAtT:null;
    const base={id:Date.now().toString(),title:nT.trim(),memo:nMemo.trim()||'',checklist:nCL.length>0?nCL:[],datetime:dt,tagId:nTg||null,notiOn:nNotiOn,notiBefore:nNotiBefore==='custom'?null:nNotiBefore,notiAt:notiAt,createdAt:new Date().toISOString()};
    let newItems;
    if(nRepeat!=='none'){
      newItems=genRepeatItems(base,nRepeat,nRepeatEnd);
    }else{
      newItems=[base];
    }
    if(writeMode==='shared'){sShT([...shTodos,...newItems].sort((a,b)=>new Date(a.datetime)-new Date(b.datetime)))}
    else{sT([...todos,...newItems].sort((a,b)=>new Date(a.datetime)-new Date(b.datetime)))}
    const cnt=newItems.length;
    sNT('');sND('');sNTi('');sNTg('');sNMemo('');sNCL([]);sNCLInput('');sNCLOpen(false);sNRepeat('none');sNRepeatEnd('');sNNotiOn(true);sNNotiBefore(30);sNNotiAtD('');sNNotiAtT('');setShowAdd(false);
    if(cnt>1)showToast('üîÅ '+repeatLabel(nRepeat)+' '+cnt+'Í∞ú ÏùºÏ†ï ÏÉùÏÑ±');
  };
  const completeTodo=(id,src)=>{
    if(src==='received')return;
    setFadingOut(p=>new Set([...p,id]));
    setTimeout(()=>{
      if(src==='shared'){
        const t=shTodos.find(x=>x.id===id);
        if(t){sShA([{...t,completedAt:new Date().toISOString()},...shArchive]);sShT(shTodos.filter(x=>x.id!==id))}
      }else{
        const t=todos.find(x=>x.id===id);
        if(t){sA([{...t,completedAt:new Date().toISOString()},...archive]);sT(todos.filter(x=>x.id!==id))}
      }
      setFadingOut(p=>{const n=new Set(p);n.delete(id);return n});
      showToast('‚úì ÏôÑÎ£å Ï≤òÎ¶¨Îê®');
    },350);
  };
  const restoreTodo=(todo,src)=>{
    if(todo.isDailyTask){
      if(src==='shared'){sShDT([...shDailyTasks,{id:Date.now().toString(),title:todo.title,done:false,date:todayDS}]);sShA(shArchive.filter(x=>x.id!==todo.id||(x.completedAt!==todo.completedAt)))}
      else{sDT([...dailyTasks,{id:Date.now().toString(),title:todo.title,done:false,date:todayDS}]);sA(archive.filter(x=>x.id!==todo.id||(x.completedAt!==todo.completedAt)))}
      showToast('‚Ü© Ïò§Îäò Ìï† ÏùºÎ°ú Î≥µÍµ¨Îê®');
    }else{
      const restored={...todo};delete restored.completedAt;delete restored._src;
      if(src==='shared'){sShT([...shTodos,restored].sort((a,b)=>new Date(a.datetime)-new Date(b.datetime)));sShA(shArchive.filter(x=>x.id!==todo.id||(x.completedAt!==todo.completedAt)))}
      else{sT([...todos,restored].sort((a,b)=>new Date(a.datetime)-new Date(b.datetime)));sA(archive.filter(x=>x.id!==todo.id||(x.completedAt!==todo.completedAt)))}
      showToast('‚Ü© Ìï† ÏùºÎ°ú Î≥µÍµ¨Îê®');
    }
  };
  const openEdit=(todo,e,readOnly,src)=>{
    if(e)e.stopPropagation();const d=new Date(todo.datetime);
    setEditTodo(todo);sET(todo.title);sED(toDS(d));
    sETi(String(d.getHours()).padStart(2,'0')+':'+String(d.getMinutes()).padStart(2,'0'));
    sETg(todo.tagId||'');sEMemo(todo.memo||'');sENotiOn(todo.notiOn!==false);
    sECL(todo.checklist||[]);sECLInput('');sECLOpen((todo.checklist||[]).length>0);
    // repeat is read-only now;
    setViewOnly(!!readOnly);setEditSource(src||'personal');setEditOrigSrc(src||'personal');
    if(todo.notiAt){
      sENotiBefore('custom');
      const nad=new Date(todo.notiAt);
      sENotiAtD(toDS(nad));
      sENotiAtT(String(nad.getHours()).padStart(2,'0')+':'+String(nad.getMinutes()).padStart(2,'0'));
    }else{
      sENotiBefore(todo.notiBefore||30);sENotiAtD('');sENotiAtT('');
    }
  };
  const saveEdit=()=>{
    if(!editTodo||!eT.trim()||viewOnly)return;
    const dt=eD&&eTi?eD+'T'+eTi:eD?eD+'T00:00':editTodo.datetime;
    const notiAt=(eNotiBefore==='custom'&&eNotiAtD&&eNotiAtT)?eNotiAtD+'T'+eNotiAtT:null;
    const oldKeys=notifiedRef.current.filter(k=>k.startsWith(editTodo.id+'_'));
    if(oldKeys.length>0){notifiedRef.current=notifiedRef.current.filter(k=>!k.startsWith(editTodo.id+'_'));sv(SK.noti,notifiedRef.current)}
    const updated={...editTodo,title:eT.trim(),memo:eMemo.trim()||'',checklist:eCL,datetime:dt,tagId:eTg||null,notiOn:eNotiOn,notiBefore:eNotiBefore==='custom'?null:eNotiBefore,notiAt:notiAt};delete updated._src;
    if(editOrigSrc!==editSource){
      // Move between stores
      if(editOrigSrc==='shared'){sShT(shTodos.filter(t=>t.id!==editTodo.id))}else{sT(todos.filter(t=>t.id!==editTodo.id))}
      if(editSource==='shared'){sShT([...shTodos.filter(t=>t.id!==editTodo.id),updated].sort((a,b)=>new Date(a.datetime)-new Date(b.datetime)))}else{sT([...todos.filter(t=>t.id!==editTodo.id),updated].sort((a,b)=>new Date(a.datetime)-new Date(b.datetime)))}
      showToast(editSource==='shared'?'üì§ Í≥µÏú†Î°ú Ïù¥ÎèôÎê®':'üë§ Í∞úÏù∏ÏúºÎ°ú Ïù¥ÎèôÎê®');
    }else{
      const upd=t=>t.id===editTodo.id?updated:t;
      if(editSource==='shared'){sShT(shTodos.map(upd).sort((a,b)=>new Date(a.datetime)-new Date(b.datetime)))}
      else{sT(todos.map(upd).sort((a,b)=>new Date(a.datetime)-new Date(b.datetime)))}
      showToast('‚úì ÏàòÏ†ï ÏôÑÎ£å');
    }
    setEditTodo(null);
  };
  const delEdit=()=>{
    if(!editTodo||viewOnly)return;
    const src=editOrigSrc;
    const list=src==='shared'?shTodos:todos;
    const setList=src==='shared'?sShT:sT;
    askConfirm('Ìï† Ïùº ÏÇ≠Ï†ú','"'+editTodo.title+'"ÏùÑ(Î•º) ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\nÏÇ≠Ï†ú ÌõÑ Î≥µÍµ¨Ìï† Ïàò ÏóÜÏäµÎãàÎã§.',()=>{
      setList(list.filter(t=>t.id!==editTodo.id));setEditTodo(null);showToast('üóë ÏÇ≠Ï†úÎê®');
    });
  };
  const delEditBatch=()=>{
    if(!editTodo||viewOnly||!editTodo.repeatGroupId)return;
    const src=editOrigSrc;
    const list=src==='shared'?shTodos:todos;
    const setList=src==='shared'?sShT:sT;
    const gid=editTodo.repeatGroupId;
    const futureItems=list.filter(t=>t.repeatGroupId===gid&&new Date(t.datetime)>=new Date(editTodo.datetime));
    askConfirm('ÏùºÍ¥Ñ ÏÇ≠Ï†ú','Ïù¥ ÎÇ†Ïßú Ìè¨Ìï® Ïù¥ÌõÑÏùò Î∞òÎ≥µ ÏùºÏ†ï\n'+futureItems.length+'Í∞úÎ•º Î™®Îëê ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?',()=>{
      setList(list.filter(t=>t.repeatGroupId!==gid||new Date(t.datetime)<new Date(editTodo.datetime)));
      setEditTodo(null);showToast('üóë '+futureItems.length+'Í∞ú ÏùºÍ¥Ñ ÏÇ≠Ï†úÎê®');
    });
  };

  const addRecord=()=>{if(!rT.trim()||!rSD||!rED)return;const item={id:Date.now().toString(),title:rT.trim(),memo:rMemo.trim()||'',startDate:rSD,endDate:rED,tagId:rTg||null,createdAt:new Date().toISOString()};if(writeMode==='shared'){sShR([...shRecords,item].sort((a,b)=>new Date(a.startDate)-new Date(b.startDate)))}else{sR([...records,item].sort((a,b)=>new Date(a.startDate)-new Date(b.startDate)))}sRT('');sRSD('');sRED('');sRTg('');sRMemo('');setShowAdd(false)};
  const openEditRec=(rec,e,readOnly,src)=>{if(e)e.stopPropagation();setEditRec(rec);sERT(rec.title);sERSD(rec.startDate);sERED(rec.endDate);sERTg(rec.tagId||'');sERMemo(rec.memo||'');setViewOnly(!!readOnly);setEditSource(src||'personal');setEditOrigSrc(src||'personal')};
  const saveEditRec=()=>{if(!editRec||!erT.trim()||!erSD||!erED||viewOnly)return;const updated={...editRec,title:erT.trim(),memo:erMemo.trim()||'',startDate:erSD,endDate:erED,tagId:erTg||null};delete updated._src;if(editOrigSrc!==editSource){if(editOrigSrc==='shared'){sShR(shRecords.filter(r=>r.id!==editRec.id))}else{sR(records.filter(r=>r.id!==editRec.id))}if(editSource==='shared'){sShR([...shRecords.filter(r=>r.id!==editRec.id),updated].sort((a,b)=>new Date(a.startDate)-new Date(b.startDate)))}else{sR([...records.filter(r=>r.id!==editRec.id),updated].sort((a,b)=>new Date(a.startDate)-new Date(b.startDate)))}showToast(editSource==='shared'?'üì§ Í≥µÏú†Î°ú Ïù¥ÎèôÎê®':'üë§ Í∞úÏù∏ÏúºÎ°ú Ïù¥ÎèôÎê®')}else{const upd=r=>r.id===editRec.id?updated:r;if(editSource==='shared'){sShR(shRecords.map(upd).sort((a,b)=>new Date(a.startDate)-new Date(b.startDate)))}else{sR(records.map(upd).sort((a,b)=>new Date(a.startDate)-new Date(b.startDate)))}showToast('‚úì ÏàòÏ†ï ÏôÑÎ£å')}setEditRec(null)};
  const delEditRec=()=>{
    if(!editRec||viewOnly)return;
    askConfirm('Í∏∞Î°ù ÏÇ≠Ï†ú','"'+editRec.title+'"ÏùÑ(Î•º) ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\nÏÇ≠Ï†ú ÌõÑ Î≥µÍµ¨Ìï† Ïàò ÏóÜÏäµÎãàÎã§.',()=>{
      if(editOrigSrc==='shared'){sShR(shRecords.filter(r=>r.id!==editRec.id))}else{sR(records.filter(r=>r.id!==editRec.id))}
      setEditRec(null);showToast('üóë ÏÇ≠Ï†úÎê®');
    });
  };

  const addTag=()=>{if(!nTgN.trim())return;sTg([...tags,{id:Date.now().toString(),name:nTgN.trim(),color:nTgC}]);sNTgN('');sNTgC('#6366F1')};
  const delTag=id=>{
    const tg=tags.find(t=>t.id===id);
    askConfirm('ÌÉúÍ∑∏ ÏÇ≠Ï†ú','"'+(tg?tg.name:'')+'" ÌÉúÍ∑∏Î•º ÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?',()=>{
      sTg(tags.filter(t=>t.id!==id));showToast('üóë ÌÉúÍ∑∏ ÏÇ≠Ï†úÎê®');
    });
  };

  // ‚ïê‚ïê‚ïê DAILY TASKS (Ïò§Îäò Ìï† Ïùº) ‚ïê‚ïê‚ïê
  const sDT=useCallback(dt=>{setDailyTasks(dt);sv(SK.dt,dt)},[]);
  const todayDT=dailyTasks.filter(d=>d.date===todayDS);
  const shDTToday=shDailyTasks.filter(d=>d.date===todayDS);
  const rcvDTToday=rcvDTLive.filter(d=>d.date===todayDS);
  const todayDTTotal=todayDT.length+shDTToday.length+rcvDTToday.length;

  const addDailyTask=()=>{
    if(!dtInput.trim())return;
    const item={id:Date.now().toString(),title:dtInput.trim(),done:false,date:todayDS};
    if(dtShareMode){sShDT([...shDailyTasks,item])}else{sDT([...dailyTasks,item])}
    setDtInput('');
  };
  const completeDailyTask=(id,src)=>{
    if(src==='shared'){
      const item=shDailyTasks.find(d=>d.id===id);if(!item)return;
      sShA([{id:'dt_'+item.id,title:item.title,datetime:new Date().toISOString(),completedAt:new Date().toISOString(),isDailyTask:true,tagId:null},...shArchive]);
      sShDT(shDailyTasks.filter(d=>d.id!==id));
    }else{
      const item=dailyTasks.find(d=>d.id===id);if(!item)return;
      sA([{id:'dt_'+item.id,title:item.title,datetime:new Date().toISOString(),completedAt:new Date().toISOString(),isDailyTask:true,tagId:null},...archive]);
      sDT(dailyTasks.filter(d=>d.id!==id));
    }
    showToast('‚úì ÏôÑÎ£å ‚Üí Í≥ºÍ±∞ ÌÉ≠ÏúºÎ°ú Ïù¥Îèô');
  };
  const delDailyTask=(id,src)=>{
    if(src==='shared'){sShDT(shDailyTasks.filter(d=>d.id!==id))}
    else{sDT(dailyTasks.filter(d=>d.id!==id))}
  };
  const moveToTomorrow=(pItems,sItems)=>{
    const tmrw=new Date(td);tmrw.setDate(tmrw.getDate()+1);const tmrwDS=toDS(tmrw);
    if(pItems&&pItems.length)sDT(dailyTasks.map(d=>pItems.find(i=>i.id===d.id)?{...d,date:tmrwDS,done:false}:d));
    if(sItems&&sItems.length)sShDT(shDailyTasks.map(d=>sItems.find(i=>i.id===d.id)?{...d,date:tmrwDS,done:false}:d));
    const cnt=(pItems?pItems.length:0)+(sItems?sItems.length:0);
    setShowYesterdayPrompt(false);
    showToast('‚Üí '+cnt+'Í∞úÎ•º ÎÇ¥ÏùºÎ°ú ÏòÆÍ≤ºÏäµÎãàÎã§');
  };
  const moveBackToToday=(pItems,sItems)=>{
    if(pItems&&pItems.length)sDT(dailyTasks.map(d=>pItems.find(i=>i.id===d.id)?{...d,date:todayDS,done:false}:d));
    if(sItems&&sItems.length)sShDT(shDailyTasks.map(d=>sItems.find(i=>i.id===d.id)?{...d,date:todayDS,done:false}:d));
    const cnt=(pItems?pItems.length:0)+(sItems?sItems.length:0);
    showToast('‚Üê '+cnt+'Í∞úÎ•º Ïò§ÎäòÎ°ú ÎêòÎèåÎ†∏ÏäµÎãàÎã§');
  };
  const moveAllToToday=()=>{
    sDT(dailyTasks.map(d=>yesterdayItems.find(i=>i.id===d.id)?{...d,date:todayDS,done:false}:d));
    setShowYesterdayPrompt(false);
    showToast('‚Üí '+yesterdayItems.length+'Í∞úÎ•º Ïò§ÎäòÎ°ú ÏòÆÍ≤ºÏäµÎãàÎã§');
  };

  // Detect yesterday's uncompleted items on load
  useEffect(()=>{
    const yest=new Date(td);yest.setDate(yest.getDate()-1);const yDS=toDS(yest);
    const yItems=dailyTasks.filter(d=>d.date===yDS&&!d.done);
    if(yItems.length>0){setYesterdayItems(yItems);setShowYesterdayPrompt(true)}
    // Clean old items (>7 days)
    const wa=new Date(td);wa.setDate(wa.getDate()-7);const wDS=toDS(wa);
    const cleaned=dailyTasks.filter(d=>d.date>=wDS);
    if(cleaned.length!==dailyTasks.length)sDT(cleaned);
  },[]);

  const exportData=()=>{
    const data={todos,archive,tags,records,dailyTasks,shTodos,shRecords,shDailyTasks,shArchive,exportedAt:new Date().toISOString(),version:'5.0'};
    const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url;a.download='todo-backup-'+toDS(new Date())+'.json';
    document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);
    showToast('üì¶ Î∞±ÏóÖ ÌååÏùº Ï†ÄÏû•Îê®');
  };
  const fileInputRef=useRef(null);
  const importData=()=>{fileInputRef.current&&fileInputRef.current.click()};
  const handleImport=e=>{
    const file=e.target.files[0];if(!file)return;
    const reader=new FileReader();
    reader.onload=ev=>{
      try{
        const data=JSON.parse(ev.target.result);
        if(!data.todos&&!data.archive&&!data.records){showToast('‚ö† Ïò¨Î∞îÎ•∏ Î∞±ÏóÖ ÌååÏùºÏù¥ ÏïÑÎãôÎãàÎã§');return}
        askConfirm('Îç∞Ïù¥ÌÑ∞ Î≥µÏõê','Î∞±ÏóÖ ÌååÏùºÏóêÏÑú Îç∞Ïù¥ÌÑ∞Î•º Î≥µÏõêÌïòÏãúÍ≤†ÏäµÎãàÍπå?\nÌòÑÏû¨ Îç∞Ïù¥ÌÑ∞Í∞Ä Î™®Îëê ÍµêÏ≤¥Îê©ÎãàÎã§.',()=>{
          if(data.todos){sT(data.todos)}
          if(data.archive){sA(data.archive)}
          if(data.tags){sTg(data.tags)}
          if(data.records){sR(data.records)}
          if(data.dailyTasks){sDT(data.dailyTasks)}
          if(data.shTodos){sShT(data.shTodos)}
          if(data.shRecords){sShR(data.shRecords)}
          if(data.shDailyTasks){sShDT(data.shDailyTasks)}
          if(data.shArchive){sShA(data.shArchive)}
          showToast('‚úì Îç∞Ïù¥ÌÑ∞ Î≥µÏõê ÏôÑÎ£å!');
        },'Î≥µÏõê',C.accent);
      }catch(err){showToast('‚ö† ÌååÏùºÏùÑ ÏùΩÏùÑ Ïàò ÏóÜÏäµÎãàÎã§')}
    };
    reader.readAsText(file);
    e.target.value='';
  };
  // Search
  const hasSearch=sq.trim()||sqDate;
  const sf=i=>{
    if(!hasSearch)return true;
    const q=sq.trim().toLowerCase(),tg=gT(i.tagId);
    const textMatch=!q||(i.title.toLowerCase().includes(q)||(i.memo&&i.memo.toLowerCase().includes(q))||(tg&&tg.name.toLowerCase().includes(q)));
    if(!sqDate)return textMatch;
    // Date match
    let dateMatch=false;
    if(i.startDate&&i.endDate){dateMatch=i.startDate<=sqDate&&i.endDate>=sqDate}
    else if(i.datetime){dateMatch=toDS(new Date(i.datetime))===sqDate}
    return textMatch&&dateMatch;
  };
  const sTo=[...todos.filter(sf).map(t=>({...t,_src:'personal'})),...(showMyShared?shTodos.filter(sf).map(t=>({...t,_src:'shared'})):[]),...(showReceived?rcvTodos.filter(sf).map(t=>({...t,_src:'received'})):[])];
  const sAr=[...archive.filter(sf).map(a=>({...a,_src:'personal'})),...(showMyShared?shArchive.filter(sf).map(a=>({...a,_src:'shared'})):[]),...(showReceived?rcvArchive.filter(sf).map(a=>({...a,_src:'received'})):[])];
  const sRc=[...records.filter(sf).map(r=>({...r,_src:'personal'})),...(showMyShared?shRecords.filter(sf).map(r=>({...r,_src:'shared'})):[]),...(showReceived?rcvRecords.filter(sf).map(r=>({...r,_src:'received'})):[])];
  const hl=(t,q)=>{if(!q.trim())return t;const i=t.toLowerCase().indexOf(q.toLowerCase());if(i===-1)return t;return h('span',null,t.slice(0,i),h('span',{style:{color:C.accent,fontWeight:700}},t.slice(i,i+q.length)),t.slice(i+q.length))};

  // ‚ïê‚ïê‚ïê TODAY & ACTIVE/PAST RECORDS ‚ïê‚ïê‚ïê
  const todayStart=new Date(td.getFullYear(),td.getMonth(),td.getDate());
  const activeRecords=records.filter(r=>new Date(r.endDate+'T23:59:59')>=todayStart);
  const pastRecords=records.filter(r=>new Date(r.endDate+'T23:59:59')<todayStart);
  const shActiveRecords=shRecords.filter(r=>new Date(r.endDate+'T23:59:59')>=todayStart);
  const shPastRecords=shRecords.filter(r=>new Date(r.endDate+'T23:59:59')<todayStart);
  const rcvActiveRecords=rcvRecords.filter(r=>new Date(r.endDate+'T23:59:59')>=todayStart);
  const rcvPastRecords=rcvRecords.filter(r=>new Date(r.endDate+'T23:59:59')<todayStart);
  // Merged lists for display
  const allActiveRecords=[...activeRecords.map(r=>({...r,_src:'personal'})),...(showMyShared?shActiveRecords.map(r=>({...r,_src:'shared'})):[]),...(showReceived?rcvActiveRecords.map(r=>({...r,_src:'received'})):[])];
  const allPastRecords=[...pastRecords.map(r=>({...r,_src:'personal'})),...(showMyShared?shPastRecords.map(r=>({...r,_src:'shared'})):[]),...(showReceived?rcvPastRecords.map(r=>({...r,_src:'received'})):[])];
  const allArchive=[...archive.map(a=>({...a,_src:'personal'})),...(showMyShared?shArchive.map(a=>({...a,_src:'shared'})):[]),...(showReceived?rcvArchive.map(a=>({...a,_src:'received'})):[])];
  const allTodos=[...todos.map(t=>({...t,_src:'personal'})),...(showMyShared?shTodos.map(t=>({...t,_src:'shared'})):[]),...(showReceived?rcvTodos.map(t=>({...t,_src:'received'})):[])];

  // ‚ïê‚ïê‚ïê ‚òÖ UNIFIED SORTED LIST (todos + activeRecords mixed) ‚ïê‚ïê‚ïê
  const unifiedList=useMemo(()=>{
    const items=[];
    allTodos.forEach(t=>items.push({type:'todo',data:t,src:t._src,sortDate:new Date(t.datetime),title:t.title}));
    allActiveRecords.forEach(r=>items.push({type:'record',data:r,src:r._src,sortDate:localDate(r.startDate),title:r.title}));

    // Tag filter
    const filtered=filterTag==='all'?items:filterTag==='none'?items.filter(i=>!i.data.tagId):items.filter(i=>i.data.tagId===filterTag);

    if(sortMode==='date'){
      filtered.sort((a,b)=>a.sortDate-b.sortDate);
    }else if(sortMode==='name'){
      filtered.sort((a,b)=>a.title.localeCompare(b.title,'ko'));
    }else if(sortMode==='type'){
      filtered.sort((a,b)=>{
        if(a.type!==b.type) return a.type==='record'?-1:1;
        return a.sortDate-b.sortDate;
      });
    }
    return filtered;
  },[allTodos,allActiveRecords,sortMode,filterTag]);

  const sortLabel=sortMode==='date'?'ÎÇ†ÏßúÏàú':sortMode==='name'?'Ïù¥Î¶ÑÏàú':'Íµ¨Î∂ÑÏàú';

  // ‚ïê‚ïê‚ïê CALENDAR ‚ïê‚ïê‚ïê
  const weeks=useMemo(()=>{
    const first=new Date(cm.y,cm.m,1),ld2=new Date(cm.y,cm.m+1,0).getDate(),sd=first.getDay();
    const rows=[];let row=[];
    for(let i=0;i<sd;i++)row.push(null);
    for(let d=1;d<=ld2;d++){row.push(d);if(row.length===7){rows.push(row);row=[]}}
    if(row.length>0){while(row.length<7)row.push(null);rows.push(row)}
    return rows;
  },[cm]);
  const tfd=useMemo(()=>{
    const mp={};
    const addToMap=(list,src)=>list.forEach(t=>{const d=new Date(t.datetime);if(d.getFullYear()===cm.y&&d.getMonth()===cm.m){const dy=d.getDate();if(!mp[dy])mp[dy]=[];mp[dy].push({...t,_src:src})}});
    addToMap(todos,'personal');
    if(showMyShared)addToMap(shTodos,'shared');
    if(showReceived)addToMap(rcvTodos,'received');
    return mp;
  },[todos,shTodos,rcvTodos,cm,showMyShared,showReceived]);
  // ‚òÖ Archive items for calendar (completed todos - all sources)
  const afd=useMemo(()=>{
    const mp={};
    const addToMap=(list,src)=>list.forEach(t=>{
      const d=new Date(t.datetime);
      if(d.getFullYear()===cm.y&&d.getMonth()===cm.m){const dy=d.getDate();if(!mp[dy])mp[dy]=[];mp[dy].push({...t,_src:src})}
    });
    addToMap(archive,'personal');
    if(showMyShared)addToMap(shArchive,'shared');
    if(showReceived)addToMap(rcvArchive,'received');
    return mp;
  },[archive,shArchive,rcvArchive,cm,showMyShared,showReceived]);
  const recForMonth=useMemo(()=>{
    const mS=new Date(cm.y,cm.m,1),mE=new Date(cm.y,cm.m+1,0);
    const filt=list=>list.filter(r=>{const s=localDate(r.startDate),e=localDate(r.endDate);return s<=mE&&e>=mS});
    return[...filt(records).map(r=>({...r,_src:'personal'})),...(showMyShared?filt(shRecords).map(r=>({...r,_src:'shared'})):[]),...(showReceived?filt(rcvRecords).map(r=>({...r,_src:'received'})):[])];
  },[records,shRecords,rcvRecords,cm,showMyShared,showReceived]);
  const recBars=useMemo(()=>{
    const bars=[];
    recForMonth.forEach(rec=>{
      const tg=gT(rec.tagId);const color=rec._src==='received'?rvColor:tg?tg.color:'#8B6CC1';
      const rs=localDate(rec.startDate),re=localDate(rec.endDate);
      weeks.forEach((week,wi)=>{
        const weekDays=week.map((d,ci)=>d?new Date(cm.y,cm.m,d):null);
        let sc=-1,ec=-1;
        for(let ci=0;ci<7;ci++){if(!weekDays[ci])continue;const wd=weekDays[ci];if(wd>=rs&&wd<=re){if(sc===-1)sc=ci;ec=ci}}
        if(sc!==-1){
          const isS=week[sc]&&new Date(cm.y,cm.m,week[sc]).getTime()===new Date(rs.getFullYear(),rs.getMonth(),rs.getDate()).getTime();
          const isE=week[ec]&&new Date(cm.y,cm.m,week[ec]).getTime()===new Date(re.getFullYear(),re.getMonth(),re.getDate()).getTime();
          bars.push({rec,wi,startCol:sc,endCol:ec,color,isStart:isS,isEnd:isE,title:rec.title});
        }
      });
    });return bars;
  },[recForMonth,weeks,cm,tags,rvColor]);

  const isT=d=>d&&cm.y===td.getFullYear()&&cm.m===td.getMonth()&&d===td.getDate();
  const pM=()=>setCm(p=>p.m===0?{y:p.y-1,m:11}:{y:p.y,m:p.m-1});
  const nM=()=>setCm(p=>p.m===11?{y:p.y+1,m:0}:{y:p.y,m:p.m+1});
  const goTd=()=>setCm({y:td.getFullYear(),m:td.getMonth()});

  // ‚ïê‚ïê‚ïê Checklist UI helper ‚ïê‚ïê‚ïê
  // ‚ïê‚ïê‚ïê Notification row ‚ïê‚ïê‚ïê
  const notiRow=(on,setOn,before,setBefore,atD,setAtD,atT,setAtT)=>
    h('div',{style:{marginBottom:7,padding:'6px 0'}},
      h('div',{style:{display:'flex',alignItems:'center',gap:6,flexWrap:'wrap'}},
        h('button',{onClick:()=>setOn(!on),style:{display:'flex',alignItems:'center',gap:4,background:on?C.accent+'15':'transparent',border:'1px solid '+(on?C.accent+'40':C.border),borderRadius:20,padding:'4px 10px',cursor:'pointer'}},
          on?BellI({z:13,c:C.accent}):BellOff({z:13,c:C.text3}),
          h('span',{style:{fontSize:11,fontWeight:600,color:on?C.accent:C.text3}},on?'ÏïåÎ¶º ON':'ÏïåÎ¶º OFF')
        ),
        on?h('div',{style:{display:'flex',gap:3,flexWrap:'wrap'}},
          ...[{v:30,l:'30Î∂Ñ Ï†Ñ'},{v:60,l:'1ÏãúÍ∞Ñ Ï†Ñ'}].map(o=>h('button',{key:o.v,onClick:()=>setBefore(o.v),style:{
            padding:'4px 8px',borderRadius:14,border:'1px solid '+(before===o.v?C.accent+'50':C.border),
            background:before===o.v?C.accent+'18':'transparent',color:before===o.v?C.accent:C.text3,
            fontSize:10,fontWeight:before===o.v?700:500,cursor:'pointer'
          }},o.l)),
          h('button',{onClick:()=>setBefore('custom'),style:{
            padding:'4px 8px',borderRadius:14,border:'1px solid '+(before==='custom'?C.accent+'50':C.border),
            background:before==='custom'?C.accent+'18':'transparent',color:before==='custom'?C.accent:C.text3,
            fontSize:10,fontWeight:before==='custom'?700:500,cursor:'pointer'
          }},'ÏßÅÏ†ë ÏûÖÎ†•')
        ):null
      ),
      on&&before==='custom'?h('div',{style:{display:'flex',gap:6,marginTop:6}},
        h('input',{type:'date',value:atD||'',onChange:e=>setAtD(e.target.value),style:{...S.input,flex:1,marginBottom:0,fontSize:12,padding:'6px 8px'}}),
        h('input',{type:'time',value:atT||'',onChange:e=>setAtT(e.target.value),style:{...S.input,flex:1,marginBottom:0,fontSize:12,padding:'6px 8px'}}),
      ):null
    );

  // ‚ïê‚ïê‚ïê Checklist UI (Ï†ëÏù¥Ïãù) ‚ïê‚ïê‚ïê
  const clUI=(items,setItems,open,setOpen,readOnly,uid)=>{
    const done=items.filter(x=>x.done).length,total=items.length;
    const inputId='cl-inp-'+uid;
    const addFromInput=()=>{const el=document.getElementById(inputId);if(!el)return;const val=el.value.trim();if(!val)return;setItems([...items,{id:Date.now().toString(),text:val,done:false}]);el.value=''};
    const toggleItem=id=>readOnly?null:setItems(items.map(x=>x.id===id?{...x,done:!x.done}:x));
    const delItem=id=>readOnly?null:setItems(items.filter(x=>x.id!==id));
    return h('div',{style:{marginBottom:7}},
      h('button',{onClick:()=>setOpen(!open),style:{display:'flex',alignItems:'center',gap:6,width:'100%',padding:'7px 10px',background:open?C.accent+'08':'transparent',border:'1px solid '+(open?C.accent+'30':C.border),borderRadius:7,cursor:'pointer',marginBottom:open?6:0}},
        h('span',{style:{fontSize:12}},open?'‚ñº':'‚ñ∂'),
        h('span',{style:{fontSize:12,fontWeight:600,color:open?C.accent:C.text2}},'‚òë Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏'),
        total>0?h('span',{style:{fontSize:10,color:done===total&&total>0?C.green:C.accent,fontWeight:700,marginLeft:'auto',background:done===total&&total>0?C.greenBg:C.accentBg,padding:'1px 7px',borderRadius:10}},done+'/'+total):null
      ),
      open?h('div',{style:{padding:'4px 0'}},
        ...items.map(item=>h('div',{key:item.id,style:{display:'flex',alignItems:'center',gap:8,padding:'5px 4px',borderBottom:'1px solid '+C.border2}},
          h('button',{onClick:()=>toggleItem(item.id),style:{width:18,height:18,borderRadius:4,border:'2px solid '+(item.done?C.green:C.border),background:item.done?C.green:'transparent',display:'flex',alignItems:'center',justifyContent:'center',cursor:readOnly?'default':'pointer',flexShrink:0,color:'#FFF',fontSize:10,fontWeight:700}},item.done?'‚úì':null),
          h('span',{style:{flex:1,fontSize:12,color:item.done?C.text3:C.text,textDecoration:item.done?'line-through':'none'}},item.text),
          !readOnly?h('button',{onClick:()=>delItem(item.id),style:{background:'none',border:'none',color:C.text3,fontSize:10,cursor:'pointer',padding:'2px 4px',opacity:.5}},'‚úï'):null
        )),
        !readOnly?h('div',{key:'cl-input-'+uid,style:{display:'flex',gap:4,marginTop:4}},
          h('input',{id:inputId,type:'text',placeholder:'Ìï≠Î™© Ï∂îÍ∞Ä...',onKeyDown:e=>{if(e.key==='Enter'){e.preventDefault();addFromInput()}},style:{flex:1,padding:'6px 10px',background:C.bg,border:'1px solid '+C.border,borderRadius:6,color:C.text,fontSize:12,outline:'none'},autoComplete:'off'}),
          h('button',{onClick:addFromInput,style:{padding:'6px 10px',background:C.accent,color:'#FFF',border:'none',borderRadius:6,fontSize:12,fontWeight:600,cursor:'pointer'}},'+')
        ):null
      ):null
    );
  };

  // ‚òÖ Confirm dialog
  const confirmDialog=confirm?h('div',{style:S.overlay,onClick:()=>setConfirm(null)},
    h('div',{style:{background:C.card,borderRadius:16,padding:18,maxWidth:340,width:'90%',animation:'scaleIn 0.15s ease',boxShadow:'0 4px 20px rgba(0,0,0,0.15)'},onClick:e=>e.stopPropagation()},
      h('div',{style:{fontSize:15,fontWeight:700,color:C.text,marginBottom:8}},confirm.title),
      h('div',{style:{fontSize:13,color:C.text2,marginBottom:18,whiteSpace:'pre-line',lineHeight:'1.5'}},confirm.msg),
      h('div',{style:{display:'flex',gap:8}},
        h('button',{onClick:confirm.onCancel,style:{flex:1,padding:'10px',background:C.bg,color:C.text2,border:'1px solid '+C.border,borderRadius:8,fontSize:13,fontWeight:600,cursor:'pointer'}},'Ï∑®ÏÜå'),
        h('button',{onClick:confirm.onOk,style:{flex:1,padding:'10px',background:confirm.okColor||C.red,color:'#FFF',border:'none',borderRadius:8,fontSize:13,fontWeight:600,cursor:'pointer'}},confirm.okLabel||'ÏÇ≠Ï†ú')
      )
    )
  ):null;

  // ‚òÖ Toast
  const toastEl=toast?h('div',{style:{
    position:'fixed',bottom:90,left:'50%',transform:'translate(-50%,0)',
    background:C.text,color:'#FFF',padding:'10px 20px',borderRadius:24,
    fontSize:13,fontWeight:500,zIndex:200,boxShadow:'0 4px 16px rgba(0,0,0,0.18)',
    animation:(toast.out?'toastOut':'toastIn')+' 0.25s ease forwards',
    pointerEvents:'none',whiteSpace:'nowrap'
  }},toast.msg):null;

  // ‚òÖ In-app notification alert banner with confirm button
  const notiAlertEl=notiAlert?h('div',{style:{
    position:'fixed',top:0,left:0,right:0,zIndex:300,padding:'max(env(safe-area-inset-top,10px),36px) 12px 12px',
    background:'linear-gradient(135deg,'+C.accent+' 0%,#D4A84A 100%)',
    color:'#FFF',boxShadow:'0 6px 24px rgba(200,150,62,0.4)',
    animation:notiAlert.out?'fadeUp 0.3s ease reverse forwards':'bannerSlide 0.35s cubic-bezier(0.2,0.8,0.3,1)',
  }},
    h('div',{style:{display:'flex',alignItems:'center',gap:10,marginBottom:10}},
      h('div',{style:{width:36,height:36,borderRadius:'50%',background:'rgba(255,255,255,0.25)',display:'flex',alignItems:'center',justifyContent:'center',flexShrink:0,animation:'bellRing 0.8s ease infinite'}},BellI({z:18,c:'#FFF',fill:'rgba(255,255,255,0.3)'})),
      h('div',{style:{flex:1,minWidth:0}},
        h('div',{style:{fontSize:11,fontWeight:700,opacity:0.9,marginBottom:2}},notiAlert.title),
        h('div',{style:{fontSize:14,fontWeight:600,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}},notiAlert.body)
      )
    ),
    h('button',{onClick:dismissNotiAlert,style:{
      width:'100%',padding:'10px',background:'rgba(255,255,255,0.25)',border:'2px solid rgba(255,255,255,0.5)',
      borderRadius:10,color:'#FFF',fontSize:14,fontWeight:700,cursor:'pointer',
      display:'flex',alignItems:'center',justifyContent:'center',gap:6
    }},'‚úì ÌôïÏù∏')
  ):null;

  // ‚ïê‚ïê‚ïê DRAWER ‚ïê‚ïê‚ïê
  const drawerEl=showDrawer?h('div',{style:{position:'fixed',top:0,left:0,right:0,bottom:0,zIndex:250}},
    // Backdrop
    h('div',{onClick:closeDrawer,style:{position:'absolute',top:0,left:0,right:0,bottom:0,background:'rgba(0,0,0,0.35)',animation:drawerClosing?'drawerFadeOut 0.25s ease forwards':'drawerFadeIn 0.25s ease'}}),
    // Drawer panel
    h('div',{style:{position:'absolute',top:0,left:0,bottom:0,width:280,maxWidth:'80vw',background:C.card,boxShadow:'4px 0 20px rgba(0,0,0,0.15)',animation:drawerClosing?'drawerSlideOut 0.25s ease forwards':'drawerSlideIn 0.25s ease',display:'flex',flexDirection:'column'}},
      // Drawer header
      h('div',{style:{padding:'max(env(safe-area-inset-top,12px),36px) 16px 12px',background:'linear-gradient(135deg,'+C.accent+',#D4A84A)',color:'#FFF'}},
        h('div',{style:{display:'flex',alignItems:'center',justifyContent:'space-between'}},
          h('div',{style:{fontSize:16,fontWeight:700}},'üìã ÏùºÏ†ï Î≥¥Í∏∞'),
          h('button',{onClick:closeDrawer,style:{background:'rgba(255,255,255,0.2)',border:'none',color:'#FFF',fontSize:14,cursor:'pointer',width:28,height:28,borderRadius:'50%',display:'flex',alignItems:'center',justifyContent:'center'}},'‚úï')
        ),
        h('div',{style:{fontSize:11,opacity:0.85,marginTop:4}},'ÌëúÏãúÌï† ÏùºÏ†ïÏùÑ ÏÑ†ÌÉùÌïòÏÑ∏Ïöî')
      ),
      // Drawer body
      h('div',{style:{flex:1,overflowY:'auto',padding:'12px 16px'}},
        // Section: ÏùºÏ†ï Î≥¥Í∏∞
        h('div',{style:{marginBottom:16}},
          h('div',{style:{fontSize:10,fontWeight:700,color:C.text3,marginBottom:8,letterSpacing:0.5}},'Î≥¥Í∏∞ ÏÑ§Ï†ï'),
          // ÎÇ¥ ÏùºÏ†ï (Ìï≠ÏÉÅ ON)
          h('div',{style:{display:'flex',alignItems:'center',padding:'12px 0',borderBottom:'1px solid '+C.border2}},
            h('div',{style:{width:8,height:8,borderRadius:'50%',background:C.accent,marginRight:10}}),
            h('div',{style:{flex:1}},
              h('div',{style:{fontSize:13,fontWeight:600,color:C.text}},'üë§ ÎÇ¥ ÏùºÏ†ï'),
              h('div',{style:{fontSize:10,color:C.text3}},'Í∞úÏù∏ Ìï† Ïùº ¬∑ Í∏∞Î°ù')
            ),
            h('span',{style:{fontSize:10,color:C.green,fontWeight:700}},'Ìï≠ÏÉÅ ON')
          ),
          // ÎÇ¥ Í≥µÏú†ÏùºÏ†ï
          h('div',{style:{display:'flex',alignItems:'center',padding:'12px 0',borderBottom:'1px solid '+C.border2}},
            h('div',{style:{width:8,height:8,borderRadius:'50%',background:'#3B82F6',marginRight:10}}),
            h('div',{style:{flex:1}},
              h('div',{style:{fontSize:13,fontWeight:600,color:C.text}},'üì§ ÎÇ¥ Í≥µÏú†ÏùºÏ†ï'),
              h('div',{style:{fontSize:10,color:C.text3}},'ÏÉÅÎåÄÎ∞©ÏóêÍ≤å Í≥µÏú†ÌïòÎäî ÏùºÏ†ï')
            ),
            h('button',{onClick:()=>toggleShowMS(!showMyShared),style:{
              width:42,height:24,borderRadius:12,border:'none',cursor:'pointer',position:'relative',
              background:showMyShared?'#3B82F6':C.border,transition:'background 0.2s'
            }},h('div',{style:{width:20,height:20,borderRadius:'50%',background:'#FFF',position:'absolute',top:2,left:showMyShared?20:2,transition:'left 0.2s',boxShadow:'0 1px 3px rgba(0,0,0,0.2)'}}))
          ),
          // Í≥µÏú†Î∞õÏùÄ ÏùºÏ†ï
          h('div',{style:{display:'flex',alignItems:'center',padding:'12px 0',borderBottom:'1px solid '+C.border2}},
            h('div',{style:{width:8,height:8,borderRadius:'50%',background:rvColor,marginRight:10}}),
            h('div',{style:{flex:1}},
              h('div',{style:{fontSize:13,fontWeight:600,color:C.text}},'üì• Í≥µÏú†Î∞õÏùÄ ÏùºÏ†ï'),
              h('div',{style:{fontSize:10,color:C.text3}},'ÏÉÅÎåÄÎ∞©Ïù¥ Í≥µÏú†Ìïú ÏùºÏ†ï')
            ),
            h('button',{onClick:()=>toggleShowRV(!showReceived),style:{
              width:42,height:24,borderRadius:12,border:'none',cursor:'pointer',position:'relative',
              background:showReceived?rvColor:C.border,transition:'background 0.2s'
            }},h('div',{style:{width:20,height:20,borderRadius:'50%',background:'#FFF',position:'absolute',top:2,left:showReceived?20:2,transition:'left 0.2s',boxShadow:'0 1px 3px rgba(0,0,0,0.2)'}}))
          )
        ),
        // Section: Í≥µÏú†Î∞õÏùÄ ÏùºÏ†ï ÏÉÅÏÑ∏ ÏÑ§Ï†ï
        showReceived?h('div',{style:{marginBottom:16}},
          h('div',{style:{fontSize:10,fontWeight:700,color:C.text3,marginBottom:8,letterSpacing:0.5}},'Í≥µÏú†Î∞õÏùÄ ÏùºÏ†ï ÏÑ§Ï†ï'),
          // Firebase Ïó∞Í≤∞ ÏÉÅÌÉú
          h('div',{style:{padding:10,background:C.card2,borderRadius:8,border:'1px solid '+(fbConnected?C.green+'30':C.border2),marginBottom:8}},
            fbConnected&&partnerCode&&partnerProfile?
              h('div',{style:{display:'flex',alignItems:'center',gap:8}},
                h('div',{style:{width:32,height:32,borderRadius:'50%',background:rvColor+'20',border:'2px solid '+rvColor,display:'flex',alignItems:'center',justifyContent:'center',fontSize:14}},'üë©'),
                h('div',{style:{flex:1}},
                  h('div',{style:{fontSize:12,fontWeight:600,color:C.text}},partnerProfile.name||'ÏÉÅÎåÄÎ∞©'),
                  h('div',{style:{fontSize:10,color:C.green}},'üü¢ Ïã§ÏãúÍ∞Ñ Ïó∞Í≤∞Îê®')
                ),
                fbSyncing?h('span',{style:{fontSize:9,color:C.accent}},'ÎèôÍ∏∞ÌôîÏ§ë...'):null
              ):
              fbConnected?h('div',{style:{display:'flex',alignItems:'center',gap:8}},
                h('span',{style:{fontSize:14}},'üîó'),
                h('div',{style:{flex:1}},
                  h('div',{style:{fontSize:12,fontWeight:600,color:C.text}},'Firebase Ïó∞Í≤∞Îê®'),
                  h('div',{style:{fontSize:10,color:C.text3}},partnerCode?'ÏÉÅÎåÄÎ∞© ÏΩîÎìú: '+partnerCode+' (Îç∞Ïù¥ÌÑ∞ ÎåÄÍ∏∞Ï§ë)':'‚öôÔ∏è ÏÑ§Ï†ïÏóêÏÑú ÏÉÅÎåÄÎ∞© ÏΩîÎìúÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî')
                )
              ):
              h('div',{style:{display:'flex',alignItems:'center',gap:8}},
                h('span',{style:{fontSize:14}},fbConfig?'‚ö†Ô∏è':'üí°'),
                h('div',{style:{flex:1}},
                  h('div',{style:{fontSize:12,fontWeight:600,color:C.text}},fbConfig?'Ïó∞Í≤∞ ÏãúÎèÑ Ï§ë...':'Îç∞Î™® Î™®Îìú'),
                  h('div',{style:{fontSize:10,color:C.text3}},fbConfig?fbError||'Ïó∞Í≤∞ Ï§ë...':'‚öôÔ∏è ÏÑ§Ï†ï ÌÉ≠ÏóêÏÑú FirebaseÎ•º Ïó∞Í≤∞ÌïòÏÑ∏Ïöî')
                )
              )
          ),
          // ÏÉâÏÉÅ ÏÑ§Ï†ï
          h('div',{style:{display:'flex',alignItems:'center',gap:8,padding:'8px 0'}},
            h('span',{style:{fontSize:12,color:C.text2,flex:1}},'ÌëúÏãú ÏÉâÏÉÅ'),
            ...[['#E91E8B','ÌïëÌÅ¨'],['#8B5CF6','Î≥¥Îùº'],['#06B6D4','Ï≤≠Î°ù'],['#F97316','Ï£ºÌô©']].map(([clr,lbl])=>
              h('button',{key:clr,onClick:()=>changeRvColor(clr),style:{
                width:28,height:28,borderRadius:'50%',background:clr,border:rvColor===clr?'3px solid '+C.text:'2px solid transparent',
                cursor:'pointer',transition:'border 0.15s'
              }})
            ),
            h('input',{type:'color',value:rvColor,onChange:e=>changeRvColor(e.target.value),style:{width:28,height:28,borderRadius:'50%',border:'1px solid '+C.border,cursor:'pointer',padding:1}})
          )
        ):null,
        // Info box
        h('div',{style:{marginTop:8,padding:10,background:C.accent+'08',borderRadius:8,border:'1px solid '+C.accent+'15'}},
          h('div',{style:{fontSize:11,color:C.text2,lineHeight:'1.6'}},
            'üí° ÏÇ¨Ïö©Î≤ï\n',
            '‚Ä¢ ÏôºÏ™Ω ÎÅùÏóêÏÑú Ïä§ÏôÄÏù¥ÌîÑÌïòÎ©¥ Ïù¥ Î©îÎâ¥Í∞Ä Ïó¥Î¶ΩÎãàÎã§\n',
            '‚Ä¢ Ìó§ÎçîÏùò üë§/üë• ÏïÑÏù¥ÏΩòÏúºÎ°ú Îπ†Î•¥Í≤å Ï†ÑÌôòÌï† Ïàò ÏûàÏäµÎãàÎã§\n',
            '‚Ä¢ Firebase Ïó∞Í≤∞ ÌõÑ Ïã§ÏãúÍ∞Ñ Í≥µÏú†Í∞Ä Í∞ÄÎä•Ìï©ÎãàÎã§'
          )
        )
      )
    )
  ):null;

  // ‚ïê‚ïê‚ïê HEADER ‚ïê‚ïê‚ïê
  const header=h('div',{style:S.header},
    h('div',{style:{display:'flex',alignItems:'center',gap:8}},
      // ‚òÖ ÏôºÏ™Ω: ÌñÑÎ≤ÑÍ±∞ Î©îÎâ¥ + Ï∫òÎ¶∞Îçî/Î¶¨Ïä§Ìä∏ ÌÜ†Í∏Ä
      h('div',{style:{display:'flex',alignItems:'center',gap:4}},
        h('button',{onClick:openDrawer,style:{...S.hBtn,borderColor:C.border}},MenuI({z:17,c:C.text2})),
        tab==='current'?h('button',{onClick:()=>setVm(vm==='list'?'calendar':'list'),style:{...S.hBtn,borderColor:vm==='calendar'?C.accent:C.border}},
          vm==='list'?CalI({z:17,c:C.text2}):LstI({z:17,c:C.accent})
        ):null
      ),
      h('div',{style:{flex:1,textAlign:'center',minWidth:0}},
        isWide?h('div',{style:S.hDate},todayStr()):h('div',{style:{...S.hDate,lineHeight:'1.2'}},todayParts().date,h('br'),h('span',{style:{fontSize:12,fontWeight:500}},todayParts().day))
      ),
      // ‚òÖ Ïò§Î•∏Ï™Ω: üë§/üë• Îπ†Î•∏ ÌÜ†Í∏Ä + Ï†ïÎ†¨ + Í≤ÄÏÉâ
      h('button',{onClick:quickToggleShared,style:{...S.hBtn,borderColor:sharedViewOn?'#3B82F6':C.border,background:sharedViewOn?'#3B82F610':'transparent',minWidth:34}},
        h('span',{style:{fontSize:13}},sharedViewOn?'üë•':'üë§')
      ),
      tab==='current'&&vm==='list'?h('div',{ref:sortRef,style:{position:'relative'}},
        h('button',{onClick:()=>setShowSortMenu(!showSortMenu),style:{...S.hBtn,borderColor:showSortMenu?C.accent:C.border,position:'relative'}},
          SortI({z:17,c:showSortMenu?C.accent:C.text2})
        ),
        // Sort dropdown menu
        showSortMenu?h('div',{style:{position:'absolute',top:40,right:0,background:C.card,border:'1px solid '+C.border,borderRadius:10,boxShadow:'0 4px 16px rgba(0,0,0,0.1)',zIndex:50,minWidth:120,overflow:'hidden',animation:'popIn 0.12s ease'}},
          ...[['date','üìÖ ÎÇ†ÏßúÏàú'],['name','üî§ Ïù¥Î¶ÑÏàú'],['type','üìÇ Íµ¨Î∂ÑÏàú']].map(([k,label])=>
            h('button',{key:k,onClick:()=>changeSortMode(k),style:{
              display:'flex',alignItems:'center',gap:8,width:'100%',padding:'10px 14px',
              background:sortMode===k?C.accent+'10':'transparent',
              border:'none',borderBottom:'1px solid '+C.border2,
              fontSize:12,fontWeight:sortMode===k?700:400,
              color:sortMode===k?C.accent:C.text,cursor:'pointer',textAlign:'left'
            }},
              h('span',null,label),
              sortMode===k?h('span',{style:{marginLeft:'auto',fontSize:10,color:C.accent}},'‚úì'):null
            )
          )
        ):null
      ):null,
      h('button',{onClick:()=>{setShowSearch(!showSearch);sSq('');sSqDate('')},style:{...S.hBtn,borderColor:showSearch?C.accent:C.border}},SI({z:17,c:showSearch?C.accent:C.text2}))
    ),
    h('div',{style:{display:'flex',justifyContent:'center',alignItems:'center',gap:8,marginTop:4}},
      h('span',{style:S.hCount},tab==='current'?(allTodos.length+'Í∞ú Ìï† Ïùº'+(allActiveRecords.length?' ¬∑ '+allActiveRecords.length+'Í∞ú Í∏∞Î°ù':'')+(todayDTTotal?' ¬∑ Ïò§Îäò '+todayDTTotal+'Í∞ú':'')+(allPastRecords.length?' ¬∑ ÏßÄÎÇú '+allPastRecords.length:''))
        :tab==='archive'?(allArchive.length+'Í∞ú ÏôÑÎ£å'+(allPastRecords.length?' ¬∑ '+allPastRecords.length+'Í∞ú ÏßÄÎÇú Í∏∞Î°ù':''))
        :'ÏÑ§Ï†ï'),
      tab==='current'&&vm==='list'?h('span',{style:{fontSize:9,color:C.accent,background:C.accent+'12',padding:'1px 6px',borderRadius:8,fontWeight:600}},sortLabel):null,
      tab==='current'&&notiPerm!=='granted'?h('button',{onClick:requestNoti,style:{background:'none',border:'1px solid '+C.border,borderRadius:6,padding:'2px 6px',cursor:'pointer',display:'flex',alignItems:'center',gap:3}},BellI({z:12,c:C.text3}),h('span',{style:{fontSize:9,color:C.text3}},'ÏïåÎ¶º')):null,
      tab==='current'&&notiPerm==='granted'?h('span',{style:{display:'flex',alignItems:'center',gap:2}},BellI({z:11,c:C.green}),h('span',{style:{fontSize:9,color:C.green}},'ON')):null
    )
  );

  // ‚ïê‚ïê‚ïê SEARCH ‚ïê‚ïê‚ïê
  const searchP=showSearch?h('div',{style:S.sPanel},
    h('div',{style:S.sWrap},SI({z:14,c:C.text3}),h('input',{type:'text',placeholder:'Í≤ÄÏÉâ...',value:sq,onChange:e=>sSq(e.target.value),style:S.sInput,autoFocus:true}),sq?h('button',{onClick:()=>sSq(''),style:{background:'none',border:'none',color:C.text3,fontSize:12,cursor:'pointer'}},'‚úï'):null),
    // ‚òÖ Date search row
    h('div',{style:{display:'flex',alignItems:'center',gap:6,padding:'4px 14px 6px',borderBottom:'1px solid '+C.border2}},
      CalI({z:13,c:C.text3}),
      h('input',{type:'date',value:sqDate,onChange:e=>sSqDate(e.target.value),style:{flex:1,background:'none',border:'none',outline:'none',color:C.text,fontSize:12,fontFamily:'inherit'}}),
      sqDate?h('button',{onClick:()=>sSqDate(''),style:{background:'none',border:'none',color:C.text3,fontSize:11,cursor:'pointer'}},'‚úï'):null,
      sqDate?h('span',{style:{fontSize:10,color:C.accent,fontWeight:600}},sqDate.replace(/-/g,'.')):null
    ),
    hasSearch?h('div',{style:{padding:'4px 0'}},
      h('div',{style:{padding:'4px 16px 8px'}},
        h('div',{style:{display:'flex',alignItems:'center',gap:5,marginBottom:4}},h('span',{style:{width:6,height:6,borderRadius:'50%',background:C.accent}}),h('span',{style:{fontSize:10,fontWeight:600,color:C.text3,flex:1}},'Ìï† Ïùº'),h('span',{style:{fontSize:9,color:C.text3,background:C.card,padding:'1px 5px',borderRadius:6}},sTo.length)),
        sTo.length===0?h('div',{style:{fontSize:10,color:C.text3,fontStyle:'italic'}},'ÏóÜÏùå'):sTo.map(t=>{const f=fmt(t.datetime),tg=gT(t.tagId),isSh=t._src==='shared',isRcv=t._src==='received';return h('div',{key:t.id+(t._src||''),onClick:e=>openEdit(t,e,isRcv,t._src),style:{display:'flex',alignItems:'center',padding:'4px 0',borderBottom:'1px solid '+C.border2,gap:6,cursor:'pointer'}},isSh?h('span',{style:{fontSize:8,color:'#3B82F6',fontWeight:700}},'üì§'):null,isRcv?h('span',{style:{fontSize:8,color:rvColor,fontWeight:700}},'üì•'):null,h('span',{style:{fontSize:10,color:C.text3,minWidth:55}},f.m+'/'+f.d+' '+f.t),h('span',{style:{fontSize:12,color:C.text,flex:1}},hl(t.title,sq)),isRcv&&t._owner?h('span',{style:{fontSize:8,color:rvColor}},t._owner):null,tg?h('span',{style:{...S.tSm,background:tg.color+'15',color:tg.color,borderColor:tg.color+'30'}},tg.name):null)})
      ),
      sRc.length>0?h('div',{style:{padding:'4px 16px 8px'}},
        h('div',{style:{display:'flex',alignItems:'center',gap:5,marginBottom:4}},h('span',{style:{width:6,height:6,borderRadius:'50%',background:'#8B6CC1'}}),h('span',{style:{fontSize:10,fontWeight:600,color:C.text3,flex:1}},'Í∏∞Î°ù'),h('span',{style:{fontSize:9,color:C.text3,background:C.card,padding:'1px 5px',borderRadius:6}},sRc.length)),
        sRc.map(r=>{const sd=localDate(r.startDate),ed=localDate(r.endDate),isSh=r._src==='shared',isRcv=r._src==='received';return h('div',{key:r.id+(r._src||''),onClick:e=>openEditRec(r,e,isRcv,r._src),style:{display:'flex',alignItems:'center',padding:'4px 0',borderBottom:'1px solid '+C.border2,gap:6,cursor:'pointer'}},isSh?h('span',{style:{fontSize:8,color:'#3B82F6',fontWeight:700}},'üì§'):null,isRcv?h('span',{style:{fontSize:8,color:rvColor,fontWeight:700}},'üì•'):null,h('span',{style:{fontSize:10,color:C.text3,minWidth:72}},(sd.getMonth()+1)+'/'+sd.getDate()+'~'+(ed.getMonth()+1)+'/'+ed.getDate()),h('span',{style:{fontSize:12,color:C.text,flex:1}},hl(r.title,sq)))})
      ):null,
      h('div',{style:{padding:'4px 16px 8px'}},
        h('div',{style:{display:'flex',alignItems:'center',gap:5,marginBottom:4}},h('span',{style:{width:6,height:6,borderRadius:'50%',background:C.green}}),h('span',{style:{fontSize:10,fontWeight:600,color:C.text3,flex:1}},'ÏôÑÎ£å'),h('span',{style:{fontSize:9,color:C.text3,background:C.card,padding:'1px 5px',borderRadius:6}},sAr.length)),
        sAr.length===0?h('div',{style:{fontSize:10,color:C.text3,fontStyle:'italic'}},'ÏóÜÏùå'):sAr.slice(0,10).map(t=>{const f=fmt(t.datetime),isSh=t._src==='shared',isRcv=t._src==='received';return h('div',{key:t.id+(t.completedAt||'')+(t._src||''),onClick:e=>{if(!t.isDailyTask)openEdit(t,e,isRcv||true,t._src)},style:{display:'flex',alignItems:'center',padding:'4px 0',borderBottom:'1px solid '+C.border2,gap:6,opacity:.5,cursor:t.isDailyTask?'default':'pointer'}},isSh?h('span',{style:{fontSize:8,color:'#3B82F6',fontWeight:700}},'üì§'):null,isRcv?h('span',{style:{fontSize:8,color:rvColor,fontWeight:700}},'üì•'):null,h('span',{style:{fontSize:10,color:C.text3,minWidth:55}},f.m+'/'+f.d+' '+f.t),h('span',{style:{fontSize:12,color:C.text2,flex:1,textDecoration:'line-through'}},hl(t.title,sq)))})
      )
    ):null
  ):null;

  // ‚ïê‚ïê‚ïê EDIT TODO MODAL ‚ïê‚ïê‚ïê
  const srcSeg=(src,setSrc,disabled)=>src==='received'?h('div',{style:{display:'flex',alignItems:'center',gap:6,padding:'6px 10px',background:rvColor+'12',borderRadius:7,marginBottom:10,border:'1px solid '+rvColor+'30'}},
    h('span',{style:{fontSize:14}},'üì•'),
    h('span',{style:{fontSize:12,fontWeight:700,color:rvColor}},'Í≥µÏú†Î∞õÏùÄ ÏùºÏ†ï'),
    editTodo&&editTodo._owner?h('span',{style:{fontSize:10,color:C.text2}},'from '+editTodo._owner):editRec&&editRec._owner?h('span',{style:{fontSize:10,color:C.text2}},'from '+editRec._owner):null,
    h('span',{style:{marginLeft:'auto',fontSize:10,color:rvColor,fontWeight:600}},'üëÅÔ∏è ÏùΩÍ∏∞ Ï†ÑÏö©')
  ):h('div',{style:{display:'flex',gap:0,background:C.border2,borderRadius:7,padding:2,marginBottom:10}},
    h('button',{onClick:()=>!disabled&&setSrc('personal'),style:{...S.segBtn,flex:1,background:src==='personal'?C.card:'transparent',color:src==='personal'?C.accent:C.text3,gap:4,display:'flex',alignItems:'center',justifyContent:'center',opacity:disabled?.5:1,cursor:disabled?'default':'pointer'}},h('span',{style:{fontSize:12}},'üë§'),h('span',null,'Í∞úÏù∏')),
    h('button',{onClick:()=>!disabled&&setSrc('shared'),style:{...S.segBtn,flex:1,background:src==='shared'?C.card:'transparent',color:src==='shared'?'#3B82F6':C.text3,gap:4,display:'flex',alignItems:'center',justifyContent:'center',opacity:disabled?.5:1,cursor:disabled?'default':'pointer'}},h('span',{style:{fontSize:12}},'üì§'),h('span',null,'Í≥µÏú†'))
  );
  const editM=editTodo?h('div',{style:S.overlay,onClick:()=>{setEditTodo(null);setViewOnly(false)}},
    h('div',{style:S.modal,onClick:e=>e.stopPropagation()},
      h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:10}},h('span',{style:{fontSize:15,fontWeight:600,color:C.text}},viewOnly?'Ìï† Ïùº Î≥¥Í∏∞':'Ìï† Ïùº ÏàòÏ†ï'),h('button',{onClick:()=>{setEditTodo(null);setViewOnly(false)},style:S.closeBtn},'‚úï')),
      srcSeg(editSource,setEditSource,viewOnly),
      h('input',{type:'text',value:eT,onChange:e=>sET(e.target.value),style:{...S.input,background:viewOnly?C.border2:C.bg},readOnly:viewOnly,onKeyDown:e=>e.key==='Enter'&&saveEdit()}),
      h('div',{style:{display:'flex',gap:6}},h('input',{type:'date',value:eD,onChange:e=>sED(e.target.value),style:{...S.input,flex:1},readOnly:viewOnly}),h('input',{type:'time',value:eTi,onChange:e=>sETi(e.target.value),style:{...S.input,flex:1},readOnly:viewOnly})),
      h('select',{value:eTg,onChange:e=>sETg(e.target.value),style:S.input,disabled:viewOnly},h('option',{value:''},'ÌÉúÍ∑∏ ÏóÜÏùå'),...tags.map(t=>h('option',{key:t.id,value:t.id},t.name))),
      viewOnly?null:notiRow(eNotiOn,sENotiOn,eNotiBefore,sENotiBefore,eNotiAtD,sENotiAtD,eNotiAtT,sENotiAtT),
      editTodo&&editTodo.repeatGroupId?h('div',{style:{display:'flex',alignItems:'center',gap:6,marginBottom:7,padding:'6px 10px',background:C.accent+'10',borderRadius:8,border:'1px solid '+C.accent+'20'}},
        h('span',{style:{fontSize:13}},'üîÅ'),
        h('span',{style:{fontSize:11,fontWeight:600,color:C.accent}},repeatLabel(editTodo.repeatType)+' Î∞òÎ≥µ'),
        h('span',{style:{fontSize:10,color:C.text3}},'(Í∑∏Î£π ÏùºÏ†ï)')
      ):null,
      h('textarea',{placeholder:'Î©îÎ™®',value:eMemo,onChange:e=>sEMemo(e.target.value),onInput:e=>{e.target.style.height='auto';e.target.style.height=e.target.scrollHeight+'px'},rows:1,style:{...S.input,resize:'none',fontFamily:'inherit',minHeight:32,overflow:'hidden',background:viewOnly?C.border2:C.bg},readOnly:viewOnly}),
      clUI(eCL,sECL,eCLOpen,sECLOpen,viewOnly,'edit'),
      viewOnly?h('button',{onClick:()=>{setEditTodo(null);setViewOnly(false)},style:{...S.submitBtn,background:C.text3}},'Îã´Í∏∞'):null,
      !viewOnly?h('button',{onClick:saveEdit,style:S.submitBtn},'Ï†ÄÏû•'):null,
      !viewOnly&&editTodo&&editTodo.repeatGroupId?h('div',{style:{display:'flex',gap:6,marginTop:5}},
        h('button',{onClick:delEdit,style:{flex:1,padding:'9px',background:'transparent',color:C.red,border:'1px solid '+C.red+'30',borderRadius:7,fontSize:12,cursor:'pointer'}},'ÏÇ≠Ï†ú'),
        h('button',{onClick:delEditBatch,style:{flex:1,padding:'9px',background:C.red,color:'#FFF',border:'none',borderRadius:7,fontSize:12,fontWeight:600,cursor:'pointer'}},'ÏùºÍ¥ÑÏÇ≠Ï†ú')
      ):null,
      !viewOnly&&editTodo&&!editTodo.repeatGroupId?h('button',{onClick:delEdit,style:S.delBtn},'ÏÇ≠Ï†ú'):null
    )
  ):null;

  // ‚ïê‚ïê‚ïê EDIT RECORD MODAL ‚ïê‚ïê‚ïê
  const editRM=editRec?h('div',{style:S.overlay,onClick:()=>{setEditRec(null);setViewOnly(false)}},
    h('div',{style:S.modal,onClick:e=>e.stopPropagation()},
      h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:10}},h('span',{style:{fontSize:15,fontWeight:600,color:C.text}},viewOnly?'Í∏∞Î°ù Î≥¥Í∏∞':'Í∏∞Î°ù ÏàòÏ†ï'),h('button',{onClick:()=>{setEditRec(null);setViewOnly(false)},style:S.closeBtn},'‚úï')),
      srcSeg(editSource,setEditSource,viewOnly),
      h('input',{type:'text',value:erT,onChange:e=>sERT(e.target.value),style:{...S.input,background:viewOnly?C.border2:C.bg},readOnly:viewOnly,onKeyDown:e=>e.key==='Enter'&&saveEditRec()}),
      h('div',{style:{display:'flex',gap:6,alignItems:'center'}},h('input',{type:'date',value:erSD,onChange:e=>sERSD(e.target.value),style:{...S.input,flex:1},readOnly:viewOnly}),h('span',{style:{color:C.text3,fontSize:12,marginBottom:7}},'~'),h('input',{type:'date',value:erED,onChange:e=>sERED(e.target.value),style:{...S.input,flex:1},readOnly:viewOnly})),
      h('select',{value:erTg,onChange:e=>sERTg(e.target.value),style:S.input,disabled:viewOnly},h('option',{value:''},'ÌÉúÍ∑∏ ÏóÜÏùå'),...tags.map(t=>h('option',{key:t.id,value:t.id},t.name))),
      h('textarea',{placeholder:'Î©îÎ™®',value:erMemo,onChange:e=>sERMemo(e.target.value),onInput:e=>{e.target.style.height='auto';e.target.style.height=e.target.scrollHeight+'px'},rows:1,style:{...S.input,resize:'none',fontFamily:'inherit',minHeight:32,overflow:'hidden',background:viewOnly?C.border2:C.bg},readOnly:viewOnly}),
      viewOnly?h('button',{onClick:()=>{setEditRec(null);setViewOnly(false)},style:{...S.submitBtn,background:C.text3}},'Îã´Í∏∞'):null,
      !viewOnly?h('button',{onClick:saveEditRec,style:S.submitBtn},'Ï†ÄÏû•'):null,
      !viewOnly?h('button',{onClick:delEditRec,style:S.delBtn},'ÏÇ≠Ï†ú'):null
    )
  ):null;

  // ‚ïê‚ïê‚ïê CALENDAR VIEW ‚ïê‚ïê‚ïê
  const CW=100/7;
  const calView=h('div',{style:{padding:'0 6px',overflowY:'auto',WebkitOverflowScrolling:'touch',flex:1}},
    h('div',{style:{display:'flex',alignItems:'center',justifyContent:'space-between',padding:'10px 4px 6px',position:'sticky',top:0,background:C.bg,zIndex:3}},
      h('button',{onClick:pM,style:S.cNav},CL({z:15,c:C.text2})),
      h('button',{onClick:goTd,style:{background:'none',border:'none',cursor:'pointer'}},h('span',{style:{fontSize:14,fontWeight:600,color:C.text}},cm.y+'ÎÖÑ '+(cm.m+1)+'Ïõî')),
      h('button',{onClick:nM,style:S.cNav},CR({z:15,c:C.text2}))
    ),
    h('div',{style:{display:'grid',gridTemplateColumns:'repeat(7,1fr)',marginBottom:2,position:'sticky',top:36,background:C.bg,zIndex:3}},
      ...DK.map((d,i)=>h('div',{key:d+i,style:{textAlign:'center',fontSize:9,fontWeight:600,color:i===0?C.red:i===6?'#3B82F6':C.text3,padding:'2px 0'}},d))
    ),
    ...weeks.map((week,wi)=>{
      const weekBars=recBars.filter(b=>b.wi===wi);
      const barSlots=[];
      weekBars.forEach(bar=>{let slot=0;while(barSlots[slot]&&barSlots[slot].some(b=>!(bar.endCol<b.startCol||bar.startCol>b.endCol))){slot++}if(!barSlots[slot])barSlots[slot]=[];barSlots[slot].push(bar)});
      const bc=barSlots.length;
      const barGap=bc>0?bc*11+5:0;
      return h('div',{key:'w'+wi,style:{position:'relative',display:'grid',gridTemplateColumns:'repeat(7,1fr)'}},
        ...week.map((day,ci)=>{
          if(!day)return h('div',{key:'e'+ci,style:{minHeight:22+barGap,padding:2,borderBottom:'1px solid '+C.border2+'60'}});
          const it=isT(day);const dw=new Date(cm.y,cm.m,day).getDay();
          // ‚òÖ Todos for this day sorted by time
          const dayTodos=(tfd[day]||[]).sort((a,b)=>new Date(a.datetime)-new Date(b.datetime));
          const dayDone=(afd[day]||[]).sort((a,b)=>new Date(a.datetime)-new Date(b.datetime));
          return h('div',{key:day,style:{minHeight:22+barGap,padding:'2px 1px',borderRadius:4,background:it?C.accent+'0C':'transparent',border:it?'1px solid '+C.accent+'35':'1px solid transparent',borderBottom:'1px solid '+C.border2+'60'}},
            h('div',{style:{fontSize:10,fontWeight:it?700:400,color:it?C.accent:dw===0?C.red:dw===6?'#3B82F6':C.text2,textAlign:'center',marginBottom:barGap||1}},day),
            // Todos sorted by time (records are shown as bars above, no duplication)
            ...dayTodos.map(t=>{const tg=gT(t.tagId);const f=fmt(t.datetime);const isSh=t._src==='shared';const isRcv=t._src==='received';const bgClr=isRcv?rvColor+'15':isSh?'#3B82F615':tg?tg.color+'15':C.border2;const txtClr=isRcv?rvColor:tg?tg.color:C.text2;const bdrL=isRcv?'2px solid '+rvColor:isSh?'2px solid #3B82F6':'none';return h('div',{key:'ct'+t.id+(t._src||''),onClick:e=>openEdit(t,e,isRcv,t._src),style:{fontSize:6,lineHeight:'8px',padding:'1px 2px',marginBottom:1,borderRadius:2,background:bgClr,color:txtClr,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap',cursor:'pointer',display:'flex',gap:1,borderLeft:bdrL}},h('span',{style:{color:C.text3,fontSize:6,flexShrink:0}},f.t),h('span',null,t.title))}),
            // ‚òÖ Completed todos with strikethrough (prominent)
            ...dayDone.map(t=>{const f=fmt(t.datetime);const isSh=t._src==='shared';const isRcv=t._src==='received';const clr=isRcv?rvColor:isSh?'#3B82F6':'#4A8C5E';return h('div',{key:'cd'+t.id+(t.completedAt||'')+(t._src||''),style:{fontSize:6,lineHeight:'8px',padding:'1px 2px',marginBottom:1,borderRadius:2,background:clr+'25',color:clr,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap',display:'flex',gap:1,opacity:.85}},h('span',{style:{fontSize:6,flexShrink:0}},f.t),h('span',{style:{textDecoration:'line-through',fontWeight:600}},'‚úì'+t.title))})
          )
        }),
        ...barSlots.flatMap((slot,si)=>slot.map(bar=>{
          const left=bar.startCol*CW,width=(bar.endCol-bar.startCol+1)*CW;
          const bL=bar.isStart?'4px':'0',bR=bar.isEnd?'4px':'0';
          return h('div',{key:'rb'+bar.rec.id+'w'+wi+'s'+si,onClick:e=>openEditRec(bar.rec,e,bar.rec._src==='received',bar.rec._src),style:{
            position:'absolute',top:20+si*11,left:left+'%',width:width+'%',height:10,
            background:bar.color+'28',borderLeft:bar.isStart?'3px solid '+bar.color:'none',
            borderRadius:bL+' '+bR+' '+bR+' '+bL,cursor:'pointer',display:'flex',alignItems:'center',paddingLeft:bar.isStart?3:2,overflow:'hidden',zIndex:2
          }},h('span',{style:{fontSize:7,fontWeight:600,color:bar.color,whiteSpace:'nowrap',overflow:'hidden',textOverflow:'ellipsis'}},bar.title))
        }))
      )
    })
  );

  // ‚ïê‚ïê‚ïê LIST ITEMS ‚ïê‚ïê‚ïê
  const recEl=(rec,src)=>{
    const tg=gT(rec.tagId);const isSh=src==='shared';const isRcv=src==='received';
    const color=isRcv?rvColor:tg?tg.color:'#8B6CC1';
    const sd=localDate(rec.startDate),ed=localDate(rec.endDate),days=daysBetween(sd,ed);
    const now=new Date(),elapsed=Math.ceil((now-sd)/864e5),pct=Math.min(Math.max(elapsed/days*100,0),100);
    const borderClr=isRcv?rvColor:isSh?'#3B82F6':'transparent';
    return h('div',{key:'r_'+rec.id+(src||''),onClick:e=>openEditRec(rec,e,isRcv,src),style:{display:'flex',alignItems:'center',padding:'8px 14px',borderBottom:'1px solid '+C.border2,cursor:'pointer',gap:8,borderLeft:'3px solid '+borderClr}},
      h('div',{style:{width:3,height:28,borderRadius:2,background:color,flexShrink:0}}),
      h('div',{style:{flex:1,minWidth:0}},
        h('div',{style:{display:'flex',alignItems:'center',gap:6,marginBottom:2}},
          h('span',{style:{fontSize:9,fontWeight:600,color:'#fff',background:color,padding:'1px 5px',borderRadius:4}},'Í∏∞Î°ù'),
          isSh?h('span',{style:{fontSize:8,fontWeight:700,color:'#3B82F6',background:'#3B82F612',padding:'1px 4px',borderRadius:3}},'üì§'):null,
          isRcv?h('span',{style:{fontSize:8,fontWeight:700,color:rvColor,background:rvColor+'12',padding:'1px 4px',borderRadius:3}},'üì• '+rec._owner):null,
          h('span',{style:{fontSize:10,fontWeight:600,color}},(sd.getMonth()+1)+'/'+sd.getDate()+' ~ '+(ed.getMonth()+1)+'/'+ed.getDate()),
          h('span',{style:{fontSize:9,color:C.text3}},days+'Ïùº'),
          tg?h('span',{style:{...S.tSm,background:tg.color+'12',color:tg.color,borderColor:tg.color+'25'}},tg.name):null
        ),
        h('div',{style:{fontSize:13,fontWeight:500,color:C.text,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}},rec.title),
        h('div',{style:{marginTop:3,height:2,borderRadius:1,background:C.border}},h('div',{style:{height:'100%',borderRadius:1,background:color,width:pct+'%',transition:'width 0.3s'}}))
      )
    )
  };

  const todoEl=(todo,src)=>{
    const f=fmt(todo.datetime),tg=gT(todo.tagId),fd=fadingOut.has(todo.id);const isSh=src==='shared';const isRcv=src==='received';
    const hasNoti=todo.notiOn!==false;
    const notiInfo=hasNoti?(todo.notiAt?fmt(todo.notiAt):null):null;
    const borderClr=isRcv?rvColor:isSh?'#3B82F6':'transparent';
    const dateClr=isRcv?rvColor:isSh?'#3B82F6':C.accent;
    return h('div',{key:'t_'+todo.id+(src||''),style:{display:'flex',alignItems:'center',padding:fd?'0 14px':'7px 14px',borderBottom:'1px solid '+C.border2,overflow:'hidden',opacity:fd?0:1,transform:fd?'translateX(40px)':'none',maxHeight:fd?0:46,transition:'all 0.35s cubic-bezier(0.4,0,0.2,1)',borderLeft:'3px solid '+borderClr}},
      h('div',{onClick:e=>openEdit(todo,e,isRcv,src),style:{flex:1,minWidth:0,display:'flex',alignItems:'center',gap:5,cursor:'pointer',padding:'2px 0'}},
        h('span',{style:{fontSize:10,fontWeight:600,color:dateClr,minWidth:30,flexShrink:0}},f.m+'/'+f.d),
        h('span',{style:{fontSize:9,color:C.text3,flexShrink:0}},'('+f.w+')'),
        h('span',{style:{fontSize:10,color:C.text3,flexShrink:0,marginRight:2}},f.t),
        isSh?h('span',{style:{fontSize:8,fontWeight:700,color:'#3B82F6',flexShrink:0,marginRight:1}},'üì§'):null,
        isRcv?h('span',{style:{fontSize:8,fontWeight:700,color:rvColor,flexShrink:0,marginRight:1}},'üì•'):null,
        hasNoti&&!isRcv?h('span',{style:{flexShrink:0,display:'flex',alignItems:'center',gap:2,marginRight:1}},
          BellI({z:10,c:C.accent+'80'}),
          notiInfo?h('span',{style:{fontSize:8,color:C.accent+'80'}},notiInfo.m+'/'+notiInfo.d+' '+notiInfo.t):null
        ):null,
        todo.repeatType?h('span',{style:{fontSize:8,color:'#8B5CF6',fontWeight:700,flexShrink:0,marginRight:1}},'üîÅ'):null,
        h('span',{style:{fontSize:13,fontWeight:500,color:C.text,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap',flex:1}},todo.title),
        todo.checklist&&todo.checklist.length>0?h('span',{style:{fontSize:8,color:C.green,fontWeight:700,background:C.greenBg,padding:'1px 4px',borderRadius:4,flexShrink:0,marginLeft:2}},todo.checklist.filter(x=>x.done).length+'/'+todo.checklist.length):null,
        isRcv&&todo._owner?h('span',{style:{fontSize:8,color:rvColor,fontWeight:600,flexShrink:0,marginLeft:2}},todo._owner):null,
        tg?h('span',{style:{...S.tSm,background:tg.color+'12',color:tg.color,borderColor:tg.color+'25',flexShrink:0,marginLeft:3}},tg.name):null
      ),
      isRcv?h('div',{style:{width:30,height:30,display:'flex',alignItems:'center',justifyContent:'center',flexShrink:0,marginLeft:4}},
        h('span',{style:{fontSize:11,opacity:.5}},'üëÅÔ∏è')
      ):h('button',{onClick:e=>{e.stopPropagation();completeTodo(todo.id,src)},style:{width:30,height:30,display:'flex',alignItems:'center',justifyContent:'center',background:'none',border:'none',cursor:'pointer',flexShrink:0,marginLeft:4}},
        h('div',{style:{width:17,height:17,borderRadius:'50%',border:'2px solid '+(isSh?'#3B82F640':C.border)}})
      )
    )
  };

  const arcEl=(todo,src)=>{
    const f=fmt(todo.datetime),cd=todo.completedAt?new Date(todo.completedAt):null;
    const tg=gT(todo.tagId);const isDaily=todo.isDailyTask;const isSh=src==='shared';const isRcv=src==='received';
    const borderClr=isRcv?rvColor+'30':isSh?'#3B82F630':'transparent';
    const cdStr=cd?(cd.getFullYear()+'ÎÖÑ '+(cd.getMonth()+1)+'Ïõî '+cd.getDate()+'Ïùº '+String(cd.getHours()).padStart(2,'0')+'Ïãú '+String(cd.getMinutes()).padStart(2,'0')+'Î∂Ñ'):'';
    return h('div',{key:todo.id+(todo.completedAt||'')+(src||''),onClick:e=>{if(!isDaily)openEdit(todo,e,true,src)},style:{display:'flex',alignItems:'center',padding:'7px 14px',borderBottom:'1px solid '+C.border2,opacity:.85,cursor:isDaily?'default':'pointer',borderLeft:'3px solid '+borderClr}},
      h('div',{style:{flex:1,minWidth:0}},
        isDaily?h('div',{style:{display:'flex',alignItems:'center',gap:5,flexWrap:'wrap'}},
          h('span',{style:{fontSize:9,fontWeight:700,color:'#FFF',background:isRcv?rvColor:isSh?'#3B82F6':'#E8A838',padding:'1px 5px',borderRadius:4,flexShrink:0}},isRcv?'üì• Í≥µÏú†Î∞õÏùÄ Ìï†Ïùº':isSh?'üì§ Ïò§ÎäòÏùò Ìï†Ïùº':'Ïò§ÎäòÏùò Ìï†Ïùº'),
          h('span',{style:{fontSize:13,color:C.text,textDecoration:'line-through',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap',flex:1}},todo.title),
          cd?h('span',{style:{fontSize:9,color:'#8C7E72',flexShrink:0,fontWeight:500}},cdStr):null
        ):h('div',{style:{display:'flex',alignItems:'center',gap:5}},
          h('span',{style:{fontSize:10,fontWeight:600,color:isRcv?rvColor:isSh?'#3B82F6':C.accent,minWidth:30}},f.m+'/'+f.d),
          h('span',{style:{fontSize:9,color:'#7A6E62'}},'('+f.w+')'),
          h('span',{style:{fontSize:10,color:'#7A6E62',marginRight:3}},f.t),
          isSh?h('span',{style:{fontSize:8,fontWeight:700,color:'#3B82F6',marginRight:1}},'üì§'):null,
          isRcv?h('span',{style:{fontSize:8,fontWeight:700,color:rvColor,marginRight:1}},'üì•'):null,
          h('span',{style:{fontSize:13,color:C.text,textDecoration:'line-through',overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap',flex:1}},todo.title),
          isRcv&&todo._owner?h('span',{style:{fontSize:8,color:rvColor,fontWeight:600,flexShrink:0}},todo._owner):null,
          tg?h('span',{style:{...S.tSm,background:tg.color+'12',color:tg.color,borderColor:tg.color+'25',flexShrink:0,marginLeft:3}},tg.name):null
        )
      ),
      h('div',{style:{display:'flex',alignItems:'center',gap:4,flexShrink:0}},
        !isDaily&&cd?h('span',{style:{fontSize:9,color:'#7A6E62'}},(cd.getMonth()+1)+'/'+cd.getDate()):null,
        isRcv?h('span',{style:{fontSize:11,opacity:.5}},'üëÅÔ∏è'):h('button',{onClick:e=>{e.stopPropagation();restoreTodo(todo,src)},title:'Î≥µÍµ¨',style:{width:26,height:26,borderRadius:'50%',background:C.accent+'12',border:'1px solid '+C.accent+'30',display:'flex',alignItems:'center',justifyContent:'center',cursor:'pointer',marginLeft:2}},UndoI({z:12,c:C.accent})),
        h('div',{style:{width:16,height:16,borderRadius:'50%',background:C.greenBg,color:C.green,display:'flex',alignItems:'center',justifyContent:'center',fontSize:9,fontWeight:700}},'‚úì')
      )
    )
  };

  // ‚òÖ Past record item (in archive tab)
  const pastRecEl=(rec,src)=>{
    const tg=gT(rec.tagId);const isSh=src==='shared';const isRcv=src==='received';
    const color=isRcv?rvColor:tg?tg.color:'#8B6CC1';
    const borderClr=isRcv?rvColor+'30':isSh?'#3B82F630':'transparent';
    const sd=localDate(rec.startDate),ed=localDate(rec.endDate);
    return h('div',{key:'pr_'+rec.id+(src||''),onClick:e=>openEditRec(rec,e,true,src),style:{display:'flex',alignItems:'center',padding:'7px 14px',borderBottom:'1px solid '+C.border2,opacity:.5,cursor:'pointer',gap:8,borderLeft:'3px solid '+borderClr}},
      h('div',{style:{width:3,height:20,borderRadius:2,background:color,flexShrink:0}}),
      h('div',{style:{flex:1,minWidth:0}},
        h('div',{style:{display:'flex',alignItems:'center',gap:5}},
          h('span',{style:{fontSize:9,fontWeight:600,color:'#fff',background:color+'90',padding:'1px 5px',borderRadius:4}},'ÏßÄÎÇú Í∏∞Î°ù'),
          isSh?h('span',{style:{fontSize:8,fontWeight:700,color:'#3B82F6'}},'üì§'):null,
          isRcv?h('span',{style:{fontSize:8,fontWeight:700,color:rvColor}},'üì• '+rec._owner):null,
          h('span',{style:{fontSize:10,color}},(sd.getMonth()+1)+'/'+sd.getDate()+' ~ '+(ed.getMonth()+1)+'/'+ed.getDate()),
        ),
        h('span',{style:{fontSize:12,color:C.text2,display:'block',marginTop:2,overflow:'hidden',textOverflow:'ellipsis',whiteSpace:'nowrap'}},rec.title)
      )
    )
  };

  // ‚ïê‚ïê‚ïê Render unified item ‚ïê‚ïê‚ïê
  const renderUnifiedItem=item=>{
    if(item.type==='todo')return todoEl(item.data,item.src);
    if(item.type==='record')return recEl(item.data,item.src);
    return null;
  };

  // ‚ïê‚ïê‚ïê ADD FORM ‚ïê‚ïê‚ïê
  const addFormInner=h('div',{style:isWide?{width:'100%',maxWidth:420,background:C.card,borderRadius:16,padding:18,animation:'scaleIn 0.15s ease',boxShadow:'0 4px 24px rgba(0,0,0,'+(dark?'0.4':'0.15')+')'}:S.addForm},
    h('div',{style:{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:6}},
      h('div',{style:{display:'flex',gap:0,background:C.border2,borderRadius:7,padding:2}},
        h('button',{onClick:()=>setAddMode('todo'),style:{...S.segBtn,background:addMode==='todo'?C.card:'transparent',color:addMode==='todo'?C.text:C.text3}},'Ìï† Ïùº'),
        h('button',{onClick:()=>setAddMode('record'),style:{...S.segBtn,background:addMode==='record'?C.card:'transparent',color:addMode==='record'?C.text:C.text3}},'Í∏∞Î°ù')
      ),
      h('button',{onClick:()=>setShowAdd(false),style:S.closeBtn},'‚úï')
    ),
    // ‚òÖ Í∞úÏù∏/Í≥µÏú† ÏÑ∏Í∑∏Î®ºÌä∏
    h('div',{style:{display:'flex',gap:0,background:C.border2,borderRadius:7,padding:2,marginBottom:10}},
      h('button',{onClick:()=>setWriteMode('personal'),style:{...S.segBtn,flex:1,background:writeMode==='personal'?C.card:'transparent',color:writeMode==='personal'?C.accent:C.text3,gap:4,display:'flex',alignItems:'center',justifyContent:'center'}},
        h('span',{style:{fontSize:12}},'üë§'),h('span',null,'Í∞úÏù∏')
      ),
      h('button',{onClick:()=>setWriteMode('shared'),style:{...S.segBtn,flex:1,background:writeMode==='shared'?C.card:'transparent',color:writeMode==='shared'?'#3B82F6':C.text3,gap:4,display:'flex',alignItems:'center',justifyContent:'center'}},
        h('span',{style:{fontSize:12}},'üì§'),h('span',null,'Í≥µÏú†')
      )
    ),
    addMode==='todo'?h('div',null,
      h('input',{type:'text',placeholder:'Ìï† Ïùº ÏûÖÎ†•',value:nT,onChange:e=>sNT(e.target.value),style:S.input,autoFocus:true,onKeyDown:e=>e.key==='Enter'&&addTodo()}),
      h('div',{style:{display:'flex',gap:6}},h('input',{type:'date',value:nD,onChange:e=>sND(e.target.value),style:{...S.input,flex:1}}),h('input',{type:'time',value:nTi,onChange:e=>sNTi(e.target.value),style:{...S.input,flex:1}})),
      h('select',{value:nTg,onChange:e=>sNTg(e.target.value),style:S.input},h('option',{value:''},'ÌÉúÍ∑∏ ÏÑ†ÌÉù'),...tags.map(t=>h('option',{key:t.id,value:t.id},t.name))),
      notiRow(nNotiOn,sNNotiOn,nNotiBefore,sNNotiBefore,nNotiAtD,sNNotiAtD,nNotiAtT,sNNotiAtT),
      h('div',{style:{display:'flex',alignItems:'center',gap:6,marginBottom:nRepeat!=='none'?4:7,flexWrap:'wrap'}},
        h('span',{style:{fontSize:11,color:C.text2,fontWeight:600}},'üîÅ Î∞òÎ≥µ'),
        ...repeatOpts.map(o=>h('button',{key:o.v,onClick:()=>sNRepeat(o.v),style:{padding:'4px 8px',borderRadius:14,border:'1px solid '+(nRepeat===o.v?C.accent+'50':C.border),background:nRepeat===o.v?C.accent+'18':'transparent',color:nRepeat===o.v?C.accent:C.text3,fontSize:10,fontWeight:nRepeat===o.v?700:500,cursor:'pointer'}},o.l))
      ),
      nRepeat!=='none'?h('div',{style:{display:'flex',alignItems:'center',gap:6,marginBottom:7,padding:'6px 10px',background:C.accent+'08',borderRadius:8,border:'1px solid '+C.accent+'15'}},
        h('span',{style:{fontSize:10,color:C.accent,fontWeight:600,flexShrink:0}},'Ï¢ÖÎ£åÏùº'),
        h('input',{type:'date',value:nRepeatEnd,onChange:e=>sNRepeatEnd(e.target.value),style:{flex:1,padding:'5px 8px',background:C.bg,border:'1px solid '+C.border,borderRadius:6,color:C.text,fontSize:12,outline:'none'}}),
        h('span',{style:{fontSize:9,color:C.text3}},nRepeatEnd?'':'ÎØ∏ÏûÖÎ†• Ïãú Ïó∞ÎßêÍπåÏßÄ')
      ):null,
      h('textarea',{placeholder:'Î©îÎ™® (ÏÑ†ÌÉù)',value:nMemo,onChange:e=>sNMemo(e.target.value),onInput:e=>{e.target.style.height='auto';e.target.style.height=e.target.scrollHeight+'px'},rows:1,style:{...S.input,resize:'none',fontFamily:'inherit',minHeight:32,overflow:'hidden'}}),
      clUI(nCL,sNCL,nCLOpen,sNCLOpen,false,'new'),
      h('button',{onClick:addTodo,style:{...S.submitBtn,background:writeMode==='shared'?'#3B82F6':C.accent}},writeMode==='shared'?'üì§ Í≥µÏú† Ï∂îÍ∞Ä':'Ï∂îÍ∞Ä')
    ):h('div',null,
      h('input',{type:'text',placeholder:'Í∏∞Î°ù Ï†úÎ™© (Ïòà: Î∂ÄÎ™®Îãò Ìï¥Ïô∏Ïó¨Ìñâ)',value:rT,onChange:e=>sRT(e.target.value),style:S.input,autoFocus:true,onKeyDown:e=>e.key==='Enter'&&addRecord()}),
      h('div',{style:{display:'flex',gap:6,alignItems:'center'}},h('input',{type:'date',value:rSD,onChange:e=>sRSD(e.target.value),style:{...S.input,flex:1}}),h('span',{style:{color:C.text3,fontSize:12,marginBottom:7}},'~'),h('input',{type:'date',value:rED,onChange:e=>sRED(e.target.value),style:{...S.input,flex:1}})),
      h('select',{value:rTg,onChange:e=>sRTg(e.target.value),style:S.input},h('option',{value:''},'ÌÉúÍ∑∏ ÏÑ†ÌÉù'),...tags.map(t=>h('option',{key:t.id,value:t.id},t.name))),
      h('textarea',{placeholder:'Î©îÎ™® (ÏÑ†ÌÉù)',value:rMemo,onChange:e=>sRMemo(e.target.value),onInput:e=>{e.target.style.height='auto';e.target.style.height=e.target.scrollHeight+'px'},rows:1,style:{...S.input,resize:'none',fontFamily:'inherit',minHeight:32,overflow:'hidden'}}),
      h('button',{onClick:addRecord,style:{...S.submitBtn,background:writeMode==='shared'?'#3B82F6':C.accent}},writeMode==='shared'?'üì§ Í≥µÏú† Ï∂îÍ∞Ä':'Ï∂îÍ∞Ä')
    )
  );
  const addF=showAdd?(isWide?h('div',{style:S.overlay,onClick:()=>setShowAdd(false)},h('div',{onClick:e=>e.stopPropagation(),style:{position:'absolute',top:60,left:'50%',transform:'translateX(-50%)'}},addFormInner)):addFormInner):null;

  const fab=!showAdd&&tab==='current'?h('button',{onClick:()=>setShowAdd(true),style:S.fab},'+'):null;
  const fileInput=h('input',{ref:fileInputRef,type:'file',accept:'.json',style:{display:'none'},onChange:handleImport});

  // ‚ïê‚ïê‚ïê YESTERDAY PROMPT ‚ïê‚ïê‚ïê
  const yesterdayPrompt=showYesterdayPrompt&&yesterdayItems.length>0?h('div',{style:{margin:'6px 10px',padding:12,background:'linear-gradient(135deg,#FFF3E0,#FFF8F0)',borderRadius:12,border:'1px solid #FFD49E',animation:'scaleIn 0.15s ease',boxShadow:'0 2px 8px rgba(200,150,62,0.1)'}},
    h('div',{style:{display:'flex',alignItems:'center',gap:6,marginBottom:8}},
      h('span',{style:{fontSize:16}},'üìã'),
      h('div',{style:{flex:1}},
        h('div',{style:{fontSize:12,fontWeight:700,color:C.text}},'Ïñ¥Ï†ú Î™ª Ìïú ÏùºÏù¥ '+yesterdayItems.length+'Í∞ú ÏûàÏñ¥Ïöî'),
        h('div',{style:{fontSize:10,color:C.text2,marginTop:1}},'Ïò§ÎäòÎ°ú ÏòÆÍ∏∞ÏãúÍ≤†Ïñ¥Ïöî?')
      ),
      h('button',{onClick:()=>setShowYesterdayPrompt(false),style:{background:'none',border:'none',color:C.text3,fontSize:12,cursor:'pointer'}},'‚úï')
    ),
    ...yesterdayItems.map(it=>h('div',{key:it.id,style:{fontSize:11,color:C.text2,padding:'3px 0',paddingLeft:22,borderBottom:'1px solid #FFE8C8'}},'‚Ä¢ '+it.title)),
    h('div',{style:{display:'flex',gap:6,marginTop:8}},
      h('button',{onClick:moveAllToToday,style:{flex:1,padding:'8px',background:C.accent,color:'#FFF',border:'none',borderRadius:7,fontSize:12,fontWeight:600,cursor:'pointer'}},'Ïò§ÎäòÎ°ú ÏòÆÍ∏∞Í∏∞'),
      h('button',{onClick:()=>{moveToTomorrow(yesterdayItems,null)},style:{flex:1,padding:'8px',background:'transparent',color:C.text2,border:'1px solid '+C.border,borderRadius:7,fontSize:12,fontWeight:500,cursor:'pointer'}},'ÎÇ¥ÏùºÎ°ú'),
      h('button',{onClick:()=>setShowYesterdayPrompt(false),style:{padding:'8px 12px',background:'transparent',color:C.text3,border:'1px solid '+C.border,borderRadius:7,fontSize:11,cursor:'pointer'}},'Î¨¥Ïãú')
    )
  ):null;

  // Tomorrow's daily tasks
  const tmrw=new Date(td);tmrw.setDate(tmrw.getDate()+1);const tmrwDS=toDS(tmrw);
  const tomorrowDT=dailyTasks.filter(d=>d.date===tmrwDS);
  const shTomorrowDT=shDailyTasks.filter(d=>d.date===tmrwDS);
  const allTomorrowDT=[...tomorrowDT.map(d=>({...d,_src:'personal'})),...shTomorrowDT.map(d=>({...d,_src:'shared'}))];

  // ‚ïê‚ïê‚ïê TAG FILTER ROW ‚ïê‚ïê‚ïê
  const tagFilterRow=tab==='current'&&vm==='list'?h('div',{style:{display:'flex',gap:4,padding:'6px 12px 2px',overflowX:'auto',WebkitOverflowScrolling:'touch'}},
    h('button',{onClick:()=>setFilterTag('all'),style:{padding:'3px 10px',borderRadius:12,border:'1px solid '+(filterTag==='all'?C.accent:C.border),background:filterTag==='all'?C.accent+'15':'transparent',color:filterTag==='all'?C.accent:C.text3,fontSize:10,fontWeight:filterTag==='all'?700:500,cursor:'pointer',whiteSpace:'nowrap',flexShrink:0}},'Ï†ÑÏ≤¥'),
    ...tags.map(tg=>h('button',{key:tg.id,onClick:()=>setFilterTag(filterTag===tg.id?'all':tg.id),style:{padding:'3px 10px',borderRadius:12,border:'1px solid '+(filterTag===tg.id?tg.color+'50':C.border),background:filterTag===tg.id?tg.color+'15':'transparent',color:filterTag===tg.id?tg.color:C.text3,fontSize:10,fontWeight:filterTag===tg.id?700:500,cursor:'pointer',whiteSpace:'nowrap',flexShrink:0,display:'flex',alignItems:'center',gap:3}},
      h('span',{style:{width:6,height:6,borderRadius:'50%',background:tg.color,flexShrink:0}}),tg.name
    )),
    h('button',{onClick:()=>setFilterTag(filterTag==='none'?'all':'none'),style:{padding:'3px 10px',borderRadius:12,border:'1px solid '+(filterTag==='none'?C.text3+'50':C.border),background:filterTag==='none'?C.text3+'15':'transparent',color:filterTag==='none'?C.text2:C.text3,fontSize:10,fontWeight:filterTag==='none'?700:500,cursor:'pointer',whiteSpace:'nowrap',flexShrink:0}},'ÌÉúÍ∑∏ÏóÜÏùå')
  ):null;

  // ‚ïê‚ïê‚ïê DAILY TASKS SECTION (Ïò§Îäò Ìï† Ïùº) ‚ïê‚ïê‚ïê
  const dtSection=tab==='current'&&vm==='list'?h('div',{style:{margin:'4px 10px 2px',background:C.card,borderRadius:10,border:'1px solid '+C.border,overflow:'hidden',boxShadow:'0 1px 4px rgba(0,0,0,0.03)'}},
    // Header - toggle
    h('div',{onClick:()=>setShowDtSection(!showDtSection),style:{display:'flex',alignItems:'center',padding:'8px 12px',cursor:'pointer',background:C.card2}},
      h('span',{style:{fontSize:12,marginRight:6}},'‚òÄÔ∏è'),
      h('span',{style:{fontSize:12,fontWeight:700,color:C.text,flex:1}},'Ïò§Îäò Ìï† Ïùº'),
      todayDTTotal>0?h('span',{style:{fontSize:10,color:C.accent,fontWeight:600,marginRight:6}},todayDTTotal+'Í∞ú'):null,
      h('span',{style:{fontSize:10,color:C.text3,transform:showDtSection?'rotate(90deg)':'rotate(0)',transition:'transform 0.2s'}},'‚ñ∂')
    ),
    showDtSection?h('div',{style:{padding:'6px 12px 8px'}},
      // ‚ë† Add input + Í≥µÏú† ÌÜ†Í∏Ä
      h('div',{style:{display:'flex',gap:4,marginBottom:6}},
        h('input',{type:'text',placeholder:dtShareMode?'üì§ Í≥µÏú† Ïò§Îäò Ìï† Ïùº Ï∂îÍ∞Ä...':'Ïò§Îäò Ìï† Ïùº Ï∂îÍ∞Ä...',value:dtInput,onChange:e=>setDtInput(e.target.value),onKeyDown:e=>e.key==='Enter'&&addDailyTask(),style:{flex:1,padding:'7px 10px',background:dtShareMode?'#3B82F608':C.bg,border:'1px solid '+(dtShareMode?'#3B82F640':C.border),borderRadius:6,color:C.text,fontSize:12,outline:'none'}}),
        h('button',{onClick:addDailyTask,style:{padding:'7px 12px',background:dtShareMode?'#3B82F6':C.accent,color:'#FFF',border:'none',borderRadius:6,fontSize:12,fontWeight:600,cursor:'pointer'}},'+'),
        h('button',{onClick:()=>setDtShareMode(!dtShareMode),title:dtShareMode?'Í≥µÏú† Î™®Îìú ON':'Í≥µÏú† Î™®Îìú OFF',style:{padding:'7px 8px',background:dtShareMode?'#3B82F6':'transparent',border:'1px solid '+(dtShareMode?'#3B82F6':C.border),borderRadius:6,cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'center'}},SharePI({z:15,c:dtShareMode?'#FFF':C.text3}))
      ),
      // ‚ë° Í∞úÏù∏ Ïò§ÎäòÌï†Ïùº
      ...todayDT.map(dt=>h('div',{key:dt.id,style:{display:'flex',alignItems:'center',gap:8,padding:'5px 0',borderBottom:'1px solid '+C.border2}},
        h('button',{onClick:()=>completeDailyTask(dt.id),style:{width:18,height:18,borderRadius:4,border:'2px solid '+C.border,background:'transparent',display:'flex',alignItems:'center',justifyContent:'center',cursor:'pointer',flexShrink:0}},null),
        h('span',{style:{flex:1,fontSize:12,color:C.text}},dt.title),
        h('button',{onClick:()=>delDailyTask(dt.id),style:{background:'none',border:'none',color:C.text3,fontSize:10,cursor:'pointer',padding:'2px 4px',opacity:.5}},'‚úï')
      )),
      // ‚ë¢ üì§ Í≥µÏú† Ïò§ÎäòÌï†Ïùº
      ...shDTToday.map(dt=>h('div',{key:'sh_'+dt.id,style:{display:'flex',alignItems:'center',gap:8,padding:'5px 0',borderBottom:'1px solid '+C.border2,background:'#3B82F606'}},
        h('button',{onClick:()=>completeDailyTask(dt.id,'shared'),style:{width:18,height:18,borderRadius:4,border:'2px solid #3B82F650',background:'transparent',display:'flex',alignItems:'center',justifyContent:'center',cursor:'pointer',flexShrink:0}},null),
        h('span',{style:{fontSize:9,color:'#3B82F6',fontWeight:700,flexShrink:0}},'üì§'),
        h('span',{style:{flex:1,fontSize:12,color:C.text}},dt.title),
        h('button',{onClick:()=>delDailyTask(dt.id,'shared'),style:{background:'none',border:'none',color:C.text3,fontSize:10,cursor:'pointer',padding:'2px 4px',opacity:.5}},'‚úï')
      )),
      // ‚ë£ üì• Î∞õÏùÄ Ïò§ÎäòÌï†Ïùº (ÏùΩÍ∏∞Ï†ÑÏö©)
      ...rcvDTToday.map(dt=>h('div',{key:'rcv_'+dt.id,style:{display:'flex',alignItems:'center',gap:8,padding:'5px 0',borderBottom:'1px solid '+C.border2,borderLeft:'3px solid '+rvColor+'30'}},
        h('span',{style:{fontSize:9,color:rvColor,fontWeight:700,flexShrink:0}},'üì•'),
        h('span',{style:{flex:1,fontSize:12,color:C.text}},dt.title),
        dt._owner?h('span',{style:{fontSize:9,color:rvColor,fontWeight:500,flexShrink:0}},dt._owner):null
      )),
      // Move to tomorrow button (Í∞úÏù∏+Í≥µÏú† Î™®Îëê)
      (todayDT.length>0||shDTToday.length>0)?h('button',{onClick:()=>{moveToTomorrow(todayDT,shDTToday)},
        style:{width:'100%',padding:'6px',marginTop:4,background:'transparent',border:'1px dashed '+C.accent+'50',borderRadius:6,color:C.accent,fontSize:10,fontWeight:600,cursor:'pointer'}},'‚Üí Î™ª Ìïú Ïùº ÎÇ¥ÏùºÎ°ú ÏòÆÍ∏∞Í∏∞ ('+(todayDT.length+shDTToday.length)+'Í∞ú)'):null,
      // Tomorrow's tasks (Í∞úÏù∏+Í≥µÏú† ÌÜµÌï©)
      allTomorrowDT.length>0?h('div',{style:{marginTop:8,padding:'8px',borderTop:'1px solid '+C.border,background:'#F0EDFF',borderRadius:8}},
        h('div',{style:{display:'flex',alignItems:'center',gap:4,marginBottom:6}},
          h('span',{style:{fontSize:11,fontWeight:700,color:'#6366F1'}},'üìÖ ÎÇ¥Ïùº Ìï† Ïùº'),
          h('span',{style:{fontSize:10,color:'#FFF',background:'#6366F1',padding:'1px 6px',borderRadius:8,fontWeight:700}},allTomorrowDT.length+'Í∞ú')
        ),
        ...allTomorrowDT.map(dt=>h('div',{key:(dt._src==='shared'?'sh_':'')+dt.id,style:{display:'flex',alignItems:'center',gap:6,padding:'4px 0',borderBottom:'1px solid #E0DDFA'}},
          dt._src==='shared'?h('span',{style:{fontSize:9,color:'#3B82F6',fontWeight:700,flexShrink:0}},'üì§'):null,
          h('span',{style:{flex:1,fontSize:11,color:C.text}},dt.title),
          h('button',{onClick:()=>{dt._src==='shared'?moveBackToToday(null,[dt]):moveBackToToday([dt],null)},style:{padding:'4px 10px',background:'#6366F1',color:'#FFF',border:'none',borderRadius:12,fontSize:10,fontWeight:700,cursor:'pointer'}},'‚Üê Ïò§ÎäòÎ°ú')
        )),
        h('button',{onClick:()=>moveBackToToday(tomorrowDT,shTomorrowDT),style:{width:'100%',padding:'8px',marginTop:6,background:'#6366F1',color:'#FFF',border:'none',borderRadius:7,fontSize:12,fontWeight:700,cursor:'pointer'}},'‚Üê Ï†ÑÏ≤¥ Ïò§ÎäòÎ°ú ÎêòÎèåÎ¶¨Í∏∞')
      ):null
    ):null
  ):null;

  // ‚ïê‚ïê‚ïê CONTENT ‚ïê‚ïê‚ïê
  let content;
  if(tab==='current'){
    if(vm==='calendar'){content=h('div',{style:{display:'flex',flexDirection:'column',height:'100%'}},calView,addF)}
    else{
      const hasItems=unifiedList.length>0;
      content=h('div',null,
        yesterdayPrompt,
        tagFilterRow,
        dtSection,
        !hasItems&&!showAdd&&todayDTTotal===0?h('div',{style:S.empty},h('div',{style:{fontSize:32,marginBottom:8}},'‚úì'),h('div',{style:{fontSize:13,color:C.text2}},'Ìï† ÏùºÏù¥ ÏóÜÏäµÎãàÎã§'),h('div',{style:{fontSize:11,marginTop:4,color:C.text3}},'+ Î≤ÑÌäºÏúºÎ°ú Ï∂îÍ∞Ä')):null,
        // Section header for type sort mode
        sortMode==='type'&&hasItems?h('div',null,
          unifiedList.filter(i=>i.type==='record').length>0?h('div',null,
            h('div',{style:{padding:'8px 14px 4px',fontSize:10,fontWeight:600,color:C.text3,letterSpacing:.5}},'üìã Í∏∞Î°ù ¬∑ '+unifiedList.filter(i=>i.type==='record').length+'Í∞ú'),
            ...unifiedList.filter(i=>i.type==='record').map(renderUnifiedItem)
          ):null,
          unifiedList.filter(i=>i.type==='todo').length>0?h('div',null,
            h('div',{style:{padding:'8px 14px 4px',fontSize:10,fontWeight:600,color:C.text3,letterSpacing:.5}},'üìù Ìï† Ïùº ¬∑ '+unifiedList.filter(i=>i.type==='todo').length+'Í∞ú'),
            ...unifiedList.filter(i=>i.type==='todo').map(renderUnifiedItem)
          ):null
        ):null,
        // For date/name sort: single merged list
        sortMode!=='type'&&hasItems?h('div',null,...unifiedList.map(renderUnifiedItem)):null,
        addF
      );
    }
  }else if(tab==='archive'){
    const hasPast=allArchive.length>0||allPastRecords.length>0;
    content=!hasPast?h('div',{style:S.empty},h('div',{style:{fontSize:32,marginBottom:8}},'üìã'),h('div',{style:{fontSize:13,color:C.text2}},'ÏôÑÎ£å Ìï≠Î™© ÏóÜÏùå'))
      :h('div',null,
        allPastRecords.length>0?h('div',null,
          h('div',{style:{padding:'8px 14px 4px',fontSize:10,fontWeight:600,color:C.text3,letterSpacing:.5}},'üìã ÏßÄÎÇú Í∏∞Î°ù ¬∑ '+allPastRecords.length+'Í∞ú'),
          ...allPastRecords.map(r=>pastRecEl(r,r._src))
        ):null,
        allArchive.length>0?h('div',null,
          h('div',{style:{padding:'8px 14px 4px',fontSize:10,fontWeight:600,color:C.text3,letterSpacing:.5}},'‚úÖ ÏôÑÎ£åÎêú Ìï† Ïùº ¬∑ '+allArchive.length+'Í∞ú'),
          ...allArchive.map(a=>arcEl(a,a._src))
        ):null
      );
  }else if(tab==='stats'){
    // ‚ïê‚ïê‚ïê STATISTICS ‚ïê‚ïê‚ïê
    const now=new Date();
    const allDone=[...archive,...shArchive];
    // This week (Mon~Sun)
    const weekStart=new Date(now);weekStart.setDate(now.getDate()-((now.getDay()+6)%7));weekStart.setHours(0,0,0,0);
    const thisWeekDone=allDone.filter(a=>a.completedAt&&new Date(a.completedAt)>=weekStart).length;
    // This month
    const monthStart=new Date(now.getFullYear(),now.getMonth(),1);
    const thisMonthDone=allDone.filter(a=>a.completedAt&&new Date(a.completedAt)>=monthStart).length;
    // Today
    const todayStart2=new Date(now.getFullYear(),now.getMonth(),now.getDate());
    const todayDone=allDone.filter(a=>a.completedAt&&new Date(a.completedAt)>=todayStart2).length;
    // Weekly trend (last 8 weeks)
    const weeklyData=[];
    for(let w=7;w>=0;w--){
      const ws=new Date(weekStart);ws.setDate(ws.getDate()-w*7);
      const we=new Date(ws);we.setDate(we.getDate()+7);
      const cnt=allDone.filter(a=>a.completedAt&&new Date(a.completedAt)>=ws&&new Date(a.completedAt)<we).length;
      const lbl=(ws.getMonth()+1)+'/'+ws.getDate()+'~';
      weeklyData.push({lbl,cnt});
    }
    const maxW=Math.max(...weeklyData.map(w=>w.cnt),1);
    // Tag distribution
    const tagDist={};
    allDone.forEach(a=>{const tid=a.tagId||'_none';tagDist[tid]=(tagDist[tid]||0)+1});
    const tagEntries=Object.entries(tagDist).sort((a,b)=>b[1]-a[1]);
    const tagTotal=allDone.length||1;
    // Streak
    let streak=0;
    const checkDay=new Date(now);checkDay.setHours(0,0,0,0);
    // If nothing done today, start from yesterday
    const todayHasDone=allDone.some(a=>a.completedAt&&new Date(a.completedAt)>=checkDay);
    if(!todayHasDone)checkDay.setDate(checkDay.getDate()-1);
    while(true){
      const dayEnd=new Date(checkDay);dayEnd.setDate(dayEnd.getDate()+1);
      const hasDone=allDone.some(a=>a.completedAt&&new Date(a.completedAt)>=checkDay&&new Date(a.completedAt)<dayEnd);
      if(hasDone){streak++;checkDay.setDate(checkDay.getDate()-1)}else break;
    }
    // Repeat task count
    const repeatCount=[...todos,...shTodos].filter(t=>t.repeatType).length;

    const statCard=(emoji,label,value,sub,color)=>h('div',{style:{flex:1,minWidth:0,background:C.card,borderRadius:10,padding:'12px 10px',border:'1px solid '+C.border,textAlign:'center',boxShadow:dark?'none':'0 1px 4px rgba(0,0,0,0.03)'}},
      h('div',{style:{fontSize:20,marginBottom:2}},emoji),
      h('div',{style:{fontSize:20,fontWeight:700,color:color||C.accent}},value),
      h('div',{style:{fontSize:10,fontWeight:600,color:C.text2,marginTop:1}},label),
      sub?h('div',{style:{fontSize:9,color:C.text3,marginTop:1}},sub):null
    );

    content=h('div',{style:{padding:12}},
      // Summary cards row 1
      h('div',{style:{display:'flex',gap:8,marginBottom:8}},
        statCard('üî•','Ïó∞ÏÜç Îã¨ÏÑ±',streak+'Ïùº',streak>=7?'ÎåÄÎã®Ìï¥Ïöî!':streak>=3?'Ïûò ÌïòÍ≥† ÏûàÏñ¥Ïöî':'ÏãúÏûëÏù¥ Î∞ò!','#E8663C'),
        statCard('üìÖ','Ïò§Îäò ÏôÑÎ£å',todayDone+'Í∞ú',null,C.accent),
        statCard('üìä','Ïù¥Î≤à Ï£º',thisWeekDone+'Í∞ú',null,'#3B82F6')
      ),
      // Summary cards row 2
      h('div',{style:{display:'flex',gap:8,marginBottom:12}},
        statCard('üóì','Ïù¥Î≤à Îã¨',thisMonthDone+'Í∞ú',null,C.green),
        statCard('‚úÖ','Ï†ÑÏ≤¥ ÏôÑÎ£å',allDone.length+'Í∞ú',null,'#8B5CF6'),
        statCard('üîÅ','Î∞òÎ≥µ ÏùºÏ†ï',repeatCount+'Í∞ú',null,'#EC4899')
      ),
      // Weekly trend chart
      h('div',{style:{...S.setS,marginBottom:10}},
        h('div',{style:S.setST},'üìà Ï£ºÍ∞Ñ ÏôÑÎ£å Ï∂îÏù¥'),
        h('div',{style:{display:'flex',alignItems:'flex-end',gap:4,height:100,padding:'8px 0'}},
          ...weeklyData.map((w,i)=>h('div',{key:i,style:{flex:1,display:'flex',flexDirection:'column',alignItems:'center',justifyContent:'flex-end',height:'100%'}},
            h('div',{style:{fontSize:9,fontWeight:700,color:i===weeklyData.length-1?C.accent:C.text3,marginBottom:2}},w.cnt||''),
            h('div',{style:{width:'100%',maxWidth:28,height:Math.max(w.cnt/maxW*70,3),background:i===weeklyData.length-1?C.accent:'linear-gradient(180deg,'+C.accent+'40,'+C.accent+'15)',borderRadius:'4px 4px 0 0',transition:'height 0.3s'}}),
            h('div',{style:{fontSize:7,color:C.text3,marginTop:3,whiteSpace:'nowrap'}},w.lbl)
          ))
        )
      ),
      // Tag distribution
      h('div',{style:{...S.setS,marginBottom:10}},
        h('div',{style:S.setST},'üè∑ ÌÉúÍ∑∏Î≥Ñ ÏôÑÎ£å'),
        tagEntries.length===0?h('div',{style:{fontSize:12,color:C.text3,padding:8}},'ÏïÑÏßÅ ÏôÑÎ£å Îç∞Ïù¥ÌÑ∞Í∞Ä ÏóÜÏäµÎãàÎã§'):null,
        ...tagEntries.map(([tid,cnt])=>{
          const tg=tags.find(t=>t.id===tid);
          const nm=tid==='_none'?'ÌÉúÍ∑∏ ÏóÜÏùå':tg?tg.name:'ÏÇ≠Ï†úÎêú ÌÉúÍ∑∏';
          const clr=tg?tg.color:C.text3;
          const pct=Math.round(cnt/tagTotal*100);
          return h('div',{key:tid,style:{display:'flex',alignItems:'center',gap:8,padding:'6px 0',borderBottom:'1px solid '+C.border2}},
            h('div',{style:{width:8,height:8,borderRadius:'50%',background:clr,flexShrink:0}}),
            h('span',{style:{fontSize:12,color:C.text,flex:1}},nm),
            h('div',{style:{width:80,height:6,borderRadius:3,background:C.border,overflow:'hidden',flexShrink:0}},
              h('div',{style:{height:'100%',borderRadius:3,background:clr,width:pct+'%'}})
            ),
            h('span',{style:{fontSize:11,fontWeight:600,color:clr,minWidth:30,textAlign:'right'}},cnt+'Í∞ú'),
            h('span',{style:{fontSize:9,color:C.text3,minWidth:28,textAlign:'right'}},pct+'%')
          )
        })
      ),
      // Quick tips
      h('div',{style:{...S.setS,background:C.accent+'08',borderColor:C.accent+'20'}},
        h('div',{style:{fontSize:11,color:C.accent,fontWeight:600,marginBottom:4}},'üí° ÌåÅ'),
        h('div',{style:{fontSize:11,color:C.text2,lineHeight:'1.6'}},
          streak>=7?'üî• '+streak+'Ïùº Ïó∞ÏÜç! ÎÜÄÎùºÏö¥ Íæ∏Ï§ÄÌï®Ïù¥ÏóêÏöî!':
          streak>=3?'üëè '+streak+'Ïùº Ïó∞ÏÜç Îã¨ÏÑ± Ï§ë. Ïù¥ ÌéòÏù¥Ïä§ Ïú†ÏßÄ!':
          thisWeekDone>0?'‚ú® Ïù¥Î≤à Ï£º '+thisWeekDone+'Í∞ú ÏôÑÎ£å! Îß§Ïùº 1Í∞úÏî© ÎèÑÏ†ÑÌï¥Î≥¥ÏÑ∏Ïöî.':
          'üìù Ïò§Îäò Ìï† ÏùºÏùÑ Ï∂îÍ∞ÄÌïòÍ≥† ÏôÑÎ£åÌï¥Î≥¥ÏÑ∏Ïöî!'
        )
      )
    );
  }else{
    content=h('div',{style:{padding:12}},
      // ‚òÖ Dark mode section
      h('div',{style:S.setS},
        h('div',{style:S.setST},'ÌôîÎ©¥ ÏÑ§Ï†ï'),
        h('div',{style:{display:'flex',alignItems:'center',justifyContent:'space-between',padding:'8px 0'}},
          h('div',null,
            h('div',{style:{fontSize:12,fontWeight:600,color:C.text}},'Îã§ÌÅ¨ Î™®Îìú'),
            h('div',{style:{fontSize:10,color:C.text3}},'Î∂ÄÎìúÎü¨Ïö¥ Ïñ¥ÎëêÏö¥ ÌÜ§ÏúºÎ°ú Ï†ÑÌôò')
          ),
          h('button',{onClick:()=>toggleDark(!dark),style:{
            width:44,height:24,borderRadius:12,border:'none',cursor:'pointer',position:'relative',
            background:dark?C.accent:C.border,transition:'background 0.2s'
          }},h('div',{style:{
            width:20,height:20,borderRadius:'50%',background:'#FFF',position:'absolute',top:2,
            left:dark?22:2,transition:'left 0.2s',boxShadow:'0 1px 3px rgba(0,0,0,0.2)'
          }}))
        )
      ),
      h('div',{style:S.setS},
        h('div',{style:S.setST},'ÌÉúÍ∑∏ Í¥ÄÎ¶¨'),
        h('div',{style:{marginBottom:12}},...tags.map(tg=>h('div',{key:tg.id,style:{display:'flex',alignItems:'center',padding:'7px 0',borderBottom:'1px solid '+C.border2}},h('div',{style:{width:10,height:10,borderRadius:'50%',background:tg.color,marginRight:10}}),h('span',{style:{flex:1,fontSize:13,color:C.text}},tg.name),h('button',{onClick:()=>delTag(tg.id),style:{background:'none',border:'1px solid '+C.red+'30',color:C.red,fontSize:10,padding:'2px 7px',borderRadius:4,cursor:'pointer'}},'ÏÇ≠Ï†ú')))),
        h('div',{style:{paddingTop:10,borderTop:'1px solid '+C.border}},
          h('div',{style:{fontSize:12,fontWeight:600,color:C.text2,marginBottom:6}},'ÏÉà ÌÉúÍ∑∏'),
          h('div',{style:{display:'flex',gap:6}},h('input',{type:'text',placeholder:'Ïù¥Î¶Ñ',value:nTgN,onChange:e=>sNTgN(e.target.value),style:{...S.input,flex:2},onKeyDown:e=>e.key==='Enter'&&addTag()}),h('input',{type:'color',value:nTgC,onChange:e=>sNTgC(e.target.value),style:{width:38,height:38,borderRadius:6,border:'1px solid '+C.border,background:C.card,padding:2,cursor:'pointer',marginBottom:7}})),
          h('button',{onClick:addTag,style:S.submitBtn},'Ï∂îÍ∞Ä')
        )
      ),
      h('div',{style:S.setS},
        h('div',{style:S.setST},'ÏïåÎ¶º ÏÑ§Ï†ï'),
        h('div',{style:{fontSize:12,color:C.text2,marginBottom:8}},'Ìï† Ïùº ÏãúÍ∞Ñ Ï†ÑÏóê ÏïåÎ¶ºÏùÑ Î≥¥ÎÉÖÎãàÎã§.'),
        h('div',{style:{fontSize:11,color:notiPerm==='granted'?C.green:C.text3,marginBottom:8}},notiPerm==='granted'?'‚úì ÏïåÎ¶º ÌôúÏÑ±ÌôîÎê®':notiPerm==='denied'?'‚úï ÏïåÎ¶º Ï∞®Îã®Îê® (Î∏åÎùºÏö∞Ï†Ä ÏÑ§Ï†ïÏóêÏÑú ÌóàÏö© ÌïÑÏöî)':'ÏïåÎ¶º ÎØ∏ÏÑ§Ï†ï'),
        notiPerm==='default'?h('button',{onClick:requestNoti,style:{...S.submitBtn,marginBottom:8}},'ÏïåÎ¶º ÌóàÏö©ÌïòÍ∏∞'):null,
        // Sound toggle
        h('div',{style:{display:'flex',alignItems:'center',justifyContent:'space-between',padding:'8px 0',borderTop:'1px solid '+C.border2}},
          h('div',null,
            h('div',{style:{fontSize:12,fontWeight:600,color:C.text}},'ÏïåÎ¶ºÏùå'),
            h('div',{style:{fontSize:10,color:C.text3}},'ÏïåÎ¶º Ïãú ÏÜåÎ¶¨Î•º Ïû¨ÏÉùÌï©ÎãàÎã§')
          ),
          h('button',{onClick:()=>toggleSound(!soundOn),style:{
            width:44,height:24,borderRadius:12,border:'none',cursor:'pointer',position:'relative',
            background:soundOn?C.accent:C.border,transition:'background 0.2s'
          }},h('div',{style:{
            width:20,height:20,borderRadius:'50%',background:'#FFF',position:'absolute',top:2,
            left:soundOn?22:2,transition:'left 0.2s',boxShadow:'0 1px 3px rgba(0,0,0,0.2)'
          }}))
        ),
        // Vibration toggle
        h('div',{style:{display:'flex',alignItems:'center',justifyContent:'space-between',padding:'8px 0',borderTop:'1px solid '+C.border2}},
          h('div',null,
            h('div',{style:{fontSize:12,fontWeight:600,color:C.text}},'ÏßÑÎèô'),
            h('div',{style:{fontSize:10,color:C.text3}},'ÏïåÎ¶º Ïãú ÏßÑÎèôÏù¥ Ïö∏Î¶ΩÎãàÎã§')
          ),
          h('button',{onClick:()=>toggleVibrate(!vibrateOn),style:{
            width:44,height:24,borderRadius:12,border:'none',cursor:'pointer',position:'relative',
            background:vibrateOn?C.accent:C.border,transition:'background 0.2s'
          }},h('div',{style:{
            width:20,height:20,borderRadius:'50%',background:'#FFF',position:'absolute',top:2,
            left:vibrateOn?22:2,transition:'left 0.2s',boxShadow:'0 1px 3px rgba(0,0,0,0.2)'
          }}))
        ),
        // Test button
        h('button',{onClick:()=>{showNotiAlert('üîî ÌÖåÏä§Ìä∏ ÏïåÎ¶º','ÌôïÏù∏ Î≤ÑÌäºÏùÑ ÎàÑÎ•¥Î©¥ ÏïåÎ¶ºÏù¥ Î©àÏ∂•ÎãàÎã§',C.accent)},style:{
          width:'100%',padding:'10px',marginTop:10,background:C.accent+'12',color:C.accent,
          border:'1px solid '+C.accent+'30',borderRadius:8,fontSize:12,fontWeight:600,cursor:'pointer',
          display:'flex',alignItems:'center',justifyContent:'center',gap:6
        }},BellI({z:14,c:C.accent}),'ÏïåÎ¶º ÌÖåÏä§Ìä∏'),
        h('div',{style:{fontSize:10,color:C.text3,marginTop:8,padding:'6px 10px',background:C.accent+'08',borderRadius:6,border:'1px solid '+C.accent+'15',lineHeight:'1.6'}},
          'üí° PWA ÏïåÎ¶º ÏûëÎèô Î∞©Ïãù:\n',
          '‚Ä¢ Ïï± ÏÇ¨Ïö© Ï§ë ‚Üí ÏÜåÎ¶¨ + ÏßÑÎèô + ÌôîÎ©¥ Î∞∞ÎÑà\n',
          '‚Ä¢ Ïï±Ïù¥ Î∞±Í∑∏ÎùºÏö¥ÎìúÏùº Îïå ‚Üí ÏïåÎ¶ºÏ∞ΩÏóê ÌëúÏãú\n',
          '‚Ä¢ Ïï±ÏùÑ ÏôÑÏ†ÑÌûà Ï¢ÖÎ£åÌïòÎ©¥ ÏïåÎ¶ºÏù¥ Ïò§ÏßÄ ÏïäÏäµÎãàÎã§\n\n',
          'üì± ÏïÑÎûò "Ìôà ÌôîÎ©¥Ïóê Ï∂îÍ∞Ä"Î•º ÌïòÎ©¥ Ïï±Ï≤òÎüº ÏÑ§ÏπòÎêòÏñ¥\nÏïåÎ¶ºÏù¥ Îçî ÏïàÏ†ïÏ†ÅÏúºÎ°ú ÎèôÏûëÌï©ÎãàÎã§.'
        ),
        // PWA install status
        h('div',{style:{display:'flex',alignItems:'center',justifyContent:'space-between',padding:'8px 0',marginTop:4,borderTop:'1px solid '+C.border2}},
          h('div',null,
            h('div',{style:{fontSize:12,fontWeight:600,color:C.text}},'Ïï± ÏÑ§Ïπò ÏÉÅÌÉú'),
            h('div',{style:{fontSize:10,color:C.text3}},window.matchMedia('(display-mode: standalone)').matches?'PWAÎ°ú ÏÑ§ÏπòÎê®':'Î∏åÎùºÏö∞Ï†ÄÏóêÏÑú Ïã§Ìñâ Ï§ë')
          ),
          h('div',{style:{fontSize:10,color:window.matchMedia('(display-mode: standalone)').matches?C.green:C.accent,fontWeight:600}},window.matchMedia('(display-mode: standalone)').matches?'‚úì ÏÑ§ÏπòÎê®':'ÎØ∏ÏÑ§Ïπò')
        )
      ),
      // ‚ïê‚ïê‚ïê FIREBASE Í≥µÏú† ÏÑ§Ï†ï ‚ïê‚ïê‚ïê
      h('div',{style:S.setS},
        h('div',{style:S.setST},'üîó Ïã§ÏãúÍ∞Ñ Í≥µÏú† (Firebase)'),
        // Connection status
        h('div',{style:{display:'flex',alignItems:'center',gap:8,padding:'8px 10px',background:fbConnected?C.green+'10':C.bg,borderRadius:8,border:'1px solid '+(fbConnected?C.green+'30':C.border),marginBottom:10}},
          h('div',{style:{width:8,height:8,borderRadius:'50%',background:fbConnected?C.green:'#ccc'}}),
          h('span',{style:{fontSize:12,fontWeight:600,color:fbConnected?C.green:C.text3}},fbConnected?'Ïó∞Í≤∞Îê®':'ÎØ∏Ïó∞Í≤∞'),
          fbSyncing?h('span',{style:{fontSize:10,color:C.accent,marginLeft:'auto'}},'ÎèôÍ∏∞ÌôîÏ§ë...'):null
        ),
        fbError?h('div',{style:{fontSize:10,color:C.red,marginBottom:8,padding:'6px 8px',background:C.red+'08',borderRadius:6}},'‚ö† '+fbError):null,
        // Step 1: Firebase Config
        h('div',{style:{marginBottom:12}},
          h('div',{style:{fontSize:12,fontWeight:600,color:C.text,marginBottom:6}},'‚ë† Firebase ÌîÑÎ°úÏ†ùÌä∏ Ïó∞Í≤∞'),
          !fbConfig?h('div',null,
            h('div',{style:{fontSize:10,color:C.text3,marginBottom:8,lineHeight:'1.6'}},
              '1. Firebase Console (firebase.google.com) Ï†ëÏÜç\n',
              '2. ÌîÑÎ°úÏ†ùÌä∏ ÏÉùÏÑ± ‚Üí Realtime Database ÌôúÏÑ±Ìôî\n',
              '3. Í∑úÏπôÏùÑ {"rules":{".read":true,".write":true}} Î°ú ÏÑ§Ï†ï\n',
              '4. ÌîÑÎ°úÏ†ùÌä∏ ÏÑ§Ï†ï ‚Üí ÏõπÏï± Ï∂îÍ∞Ä ‚Üí config Î≥µÏÇ¨\n',
              '5. ÏïÑÎûòÏóê Î∂ôÏó¨ÎÑ£Í∏∞'
            ),
            h('textarea',{id:'fb-config-input',placeholder:'Firebase config JSON Î∂ôÏó¨ÎÑ£Í∏∞\nÏòà: {"apiKey":"...","databaseURL":"...","projectId":"..."}',style:{width:'100%',minHeight:80,padding:8,background:C.bg,border:'1px solid '+C.border,borderRadius:7,color:C.text,fontSize:11,fontFamily:'monospace',outline:'none',resize:'vertical',marginBottom:6}}),
            h('button',{onClick:()=>{
              try{
                const el=document.getElementById('fb-config-input');
                let cfg=JSON.parse(el.value.trim());
                if(!cfg.databaseURL&&!cfg.projectId){showToast('‚ö† databaseURL ÎòêÎäî projectId ÌïÑÏöî');return}
                if(!cfg.databaseURL&&cfg.projectId){cfg.databaseURL='https://'+cfg.projectId+'-default-rtdb.firebaseio.com'}
                saveFbConfig(cfg);
                if(!myCode){const c=genCode();saveMyCode(c)}
                showToast('‚úÖ Firebase Ïó∞Í≤∞ ÏÑ§Ï†ï ÏôÑÎ£å!');
              }catch(e){showToast('‚ö† JSON ÌòïÏãùÏù¥ Ïò¨Î∞îÎ•¥ÏßÄ ÏïäÏäµÎãàÎã§')}
            },style:S.submitBtn},'Firebase Ïó∞Í≤∞')
          ):h('div',null,
            h('div',{style:{fontSize:11,color:C.green,marginBottom:6}},'‚úÖ Firebase ÌîÑÎ°úÏ†ùÌä∏ Ïó∞Í≤∞Îê®'),
            h('button',{onClick:()=>{
              askConfirm('Firebase Ïó∞Í≤∞ Ìï¥Ï†ú','Firebase Ïó∞Í≤∞ÏùÑ Ìï¥Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\nÍ≥µÏú† ÏΩîÎìúÎäî Ïú†ÏßÄÎê©ÎãàÎã§.',()=>{
                saveFbConfig(null);setFbConnected(false);showToast('Ïó∞Í≤∞ Ìï¥Ï†úÎê®');
              },'Ìï¥Ï†ú',C.red);
            },style:{fontSize:11,color:C.red,background:'none',border:'1px solid '+C.red+'30',borderRadius:6,padding:'4px 10px',cursor:'pointer'}},'Ïó∞Í≤∞ Ìï¥Ï†ú')
          )
        ),
        // Step 2: My share code
        fbConfig?h('div',{style:{marginBottom:12,padding:10,background:C.accent+'08',borderRadius:8,border:'1px solid '+C.accent+'20'}},
          h('div',{style:{fontSize:12,fontWeight:600,color:C.text,marginBottom:6}},'‚ë° ÎÇ¥ Í≥µÏú† ÏΩîÎìú'),
          h('div',{style:{fontSize:10,color:C.text3,marginBottom:6}},'Ïù¥ ÏΩîÎìúÎ•º ÏÉÅÎåÄÎ∞©ÏóêÍ≤å ÏïåÎ†§Ï£ºÏÑ∏Ïöî.\nÏÉÅÎåÄÎ∞©Ïù¥ Ïù¥ ÏΩîÎìúÎ•º ÏûÖÎ†•ÌïòÎ©¥ ÎÇ¥ üì§Í≥µÏú† ÏùºÏ†ïÏùÑ Î≥º Ïàò ÏûàÏäµÎãàÎã§.'),
          h('div',{style:{display:'flex',alignItems:'center',gap:8}},
            h('div',{style:{fontSize:20,fontWeight:700,color:C.accent,letterSpacing:3,background:C.card,padding:'8px 16px',borderRadius:8,border:'2px solid '+C.accent+'40',fontFamily:'monospace'}},myCode||'---'),
            h('button',{onClick:()=>{
              try{navigator.clipboard.writeText(myCode);showToast('üìã ÏΩîÎìú Î≥µÏÇ¨Îê®!')}catch(e){showToast(myCode)}
            },style:{padding:'8px 12px',background:C.accent,color:'#FFF',border:'none',borderRadius:8,fontSize:11,fontWeight:600,cursor:'pointer'}},'Î≥µÏÇ¨'),
            h('button',{onClick:()=>{
              askConfirm('ÏΩîÎìú Ïû¨ÏÉùÏÑ±','ÏÉà ÏΩîÎìúÎ•º ÏÉùÏÑ±ÌïòÎ©¥ ÏÉÅÎåÄÎ∞©ÏóêÍ≤å Îã§Ïãú ÏïåÎ†§Ïïº Ìï©ÎãàÎã§.\nÍ≥ÑÏÜçÌï†ÍπåÏöî?',()=>{
                const c=genCode();saveMyCode(c);showToast('ÏÉà ÏΩîÎìú: '+c);
              },'Ïû¨ÏÉùÏÑ±',C.accent);
            },style:{padding:'8px 10px',background:'none',border:'1px solid '+C.border,borderRadius:8,fontSize:11,cursor:'pointer',color:C.text3}},'üîÑ')
          ),
          // My name setting
          h('div',{style:{display:'flex',alignItems:'center',gap:6,marginTop:8}},
            h('span',{style:{fontSize:11,color:C.text2,flexShrink:0}},'ÎÇ¥ Ïù¥Î¶Ñ:'),
            h('input',{type:'text',value:myName,onChange:e=>saveMyName(e.target.value),style:{flex:1,padding:'5px 8px',background:C.card,border:'1px solid '+C.border,borderRadius:6,fontSize:12,color:C.text,outline:'none'},placeholder:'ÌëúÏãúÎê† Ïù¥Î¶Ñ'})
          )
        ):null,
        // Step 3: Partner code
        fbConfig?h('div',{style:{marginBottom:12,padding:10,background:rvColor+'08',borderRadius:8,border:'1px solid '+rvColor+'20'}},
          h('div',{style:{fontSize:12,fontWeight:600,color:C.text,marginBottom:6}},'‚ë¢ ÏÉÅÎåÄÎ∞© ÏΩîÎìú ÏûÖÎ†•'),
          h('div',{style:{fontSize:10,color:C.text3,marginBottom:6}},'ÏÉÅÎåÄÎ∞©Ïù¥ ÏïåÎ†§Ï§Ä ÏΩîÎìúÎ•º ÏûÖÎ†•ÌïòÏÑ∏Ïöî.\nÏûÖÎ†•ÌïòÎ©¥ üì•Í≥µÏú†Î∞õÏùÄ ÏùºÏ†ïÏóê ÏûêÎèôÏúºÎ°ú ÌëúÏãúÎê©ÎãàÎã§.'),
          h('div',{style:{display:'flex',gap:6}},
            h('input',{type:'text',value:partnerCode,onChange:e=>savePartnerCode(e.target.value.toUpperCase().replace(/[^A-Z0-9]/g,'')),maxLength:6,placeholder:'6ÏûêÎ¶¨ ÏΩîÎìú',style:{flex:1,padding:'8px 12px',background:C.card,border:'1px solid '+C.border,borderRadius:8,fontSize:16,fontWeight:700,color:rvColor,letterSpacing:3,textAlign:'center',fontFamily:'monospace',outline:'none'}}),
            partnerCode.length===6&&partnerProfile?h('div',{style:{display:'flex',alignItems:'center',gap:4,padding:'4px 8px',background:C.green+'12',borderRadius:8,border:'1px solid '+C.green+'30'}},
              h('span',{style:{fontSize:11,color:C.green,fontWeight:600}},partnerProfile.name||'Ïó∞Í≤∞Îê®'),
              h('span',{style:{fontSize:14}},'üü¢')
            ):null
          ),
          partnerCode&&!partnerProfile?h('div',{style:{fontSize:10,color:C.text3,marginTop:4}},'‚è≥ ÏÉÅÎåÄÎ∞© Îç∞Ïù¥ÌÑ∞ ÎåÄÍ∏∞ Ï§ë... (ÏΩîÎìúÍ∞Ä ÎßûÎäîÏßÄ ÌôïÏù∏ÌïòÏÑ∏Ïöî)'):null
        ):null
      ),
      h('div',{style:S.setS},
        h('div',{style:S.setST},'Îç∞Ïù¥ÌÑ∞ Î∞±ÏóÖ / Î≥µÏõê'),
        h('div',{style:{fontSize:11,color:C.text3,marginBottom:10,lineHeight:'1.5'}},'Î∏åÎùºÏö∞Ï†Ä Ï∫êÏãúÎ•º ÏßÄÏö∞Î©¥ Îç∞Ïù¥ÌÑ∞Í∞Ä ÏÇ¨ÎùºÏßà Ïàò ÏûàÏäµÎãàÎã§.\nÏ†ïÍ∏∞Ï†ÅÏúºÎ°ú Î∞±ÏóÖÌï¥ÎëêÏãúÎäî Í≤ÉÏùÑ Í∂åÏû•Ìï©ÎãàÎã§.'),
        h('div',{style:{display:'flex',gap:8,marginBottom:8}},
          h('button',{onClick:exportData,style:{...S.backupBtn,background:C.accent+'12',color:C.accent,borderColor:C.accent+'30'}},DlI({z:14,c:C.accent}),h('span',null,'Î∞±ÏóÖ Ï†ÄÏû•')),
          h('button',{onClick:importData,style:{...S.backupBtn,background:C.green+'12',color:C.green,borderColor:C.green+'30'}},UlI({z:14,c:C.green}),h('span',null,'Î≥µÏõêÌïòÍ∏∞'))
        )
      ),
      h('div',{style:S.setS},
        h('div',{style:S.setST},'Îç∞Ïù¥ÌÑ∞ ÌòÑÌô©'),
        ...[['üë§ Ìï† Ïùº',todos.length],['üë§ ÏôÑÎ£å',archive.length],['üë§ Í∏∞Î°ù',records.length],['üë§ Ïò§Îäò Ìï† Ïùº',todayDT.length],['üì§ Í≥µÏú† Ìï† Ïùº',shTodos.length],['üì§ Í≥µÏú† ÏôÑÎ£å',shArchive.length],['üì§ Í≥µÏú† Í∏∞Î°ù',shRecords.length],['üì§ Í≥µÏú† Ïò§Îäò Ìï† Ïùº',shDTToday.length],['üì• Í≥µÏú†Î∞õÏùÄ Ìï† Ïùº',rcvTodos.length],['üì• Í≥µÏú†Î∞õÏùÄ Í∏∞Î°ù',rcvRecords.length],['üì• Í≥µÏú†Î∞õÏùÄ Ïò§Îäò Ìï† Ïùº',rcvDTToday.length],['üîÅ Î∞òÎ≥µ ÏùºÏ†ï',[...todos,...shTodos].filter(t=>t.repeatType).length],['ÌÉúÍ∑∏',tags.length]].map(([l,v])=>h('div',{key:l,style:{display:'flex',justifyContent:'space-between',padding:'7px 0',fontSize:12,color:C.text2,borderBottom:'1px solid '+C.border2}},h('span',null,l),h('span',{style:{background:l.startsWith('üì•')?rvColor+'10':l.startsWith('üì§')?'#3B82F610':C.accentBg,color:l.startsWith('üì•')?rvColor:l.startsWith('üì§')?'#3B82F6':C.accent,fontSize:10,fontWeight:600,padding:'1px 7px',borderRadius:10}},v))),
        h('button',{onClick:()=>{
          askConfirm('Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú','Î™®Îì† Ìï† Ïùº, Í∏∞Î°ù, ÏôÑÎ£å ÎÇ¥Ïó≠, ÌÉúÍ∑∏Î•º\nÏÇ≠Ï†úÌïòÏãúÍ≤†ÏäµÎãàÍπå?\n\n‚ö† Ïù¥ ÏûëÏóÖÏùÄ ÎêòÎèåÎ¶¥ Ïàò ÏóÜÏäµÎãàÎã§.\nÎ®ºÏ†Ä Î∞±ÏóÖÏùÑ Í∂åÏû•Ìï©ÎãàÎã§.',()=>{
            sT([]);sA([]);sR([]);sTg(DTAGS);sDT([]);sShT([]);sShR([]);sShA([]);sShDT([]);showToast('üóë Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†úÎê®');
          },'Ï†ÑÏ≤¥ ÏÇ≠Ï†ú');
        },style:{...S.delBtn,marginTop:12,fontSize:11,padding:'8px'}},'Ï†ÑÏ≤¥ Îç∞Ïù¥ÌÑ∞ ÏÇ≠Ï†ú')
      )
    );
  }

  const nav=h('div',{style:S.nav},
    ...[['current','üìù','ÌòÑÏû¨'],['archive','‚úÖ','Í≥ºÍ±∞'],['stats','üìä','ÌÜµÍ≥Ñ'],['settings','‚öôÔ∏è','ÏÑ§Ï†ï']].map(([k,ic,lb])=>
      h('button',{key:k,onClick:()=>{setTab(k);setShowSearch(false);sSq('');sSqDate('');setShowSortMenu(false)},style:{flex:1,display:'flex',flexDirection:'column',alignItems:'center',gap:1,background:'none',border:'none',cursor:'pointer',padding:'5px 0'}},
        h('span',{style:{fontSize:17}},ic),h('span',{style:{fontSize:9,fontWeight:500,color:tab===k?C.accent:C.text3}},lb)
      )
    )
  );

  // Wide nav for Fold5 - only ÌòÑÏû¨+ÏÑ§Ï†ï (Í≥ºÍ±∞ is already visible in split view)
  const wideNav=h('div',{style:S.nav},
    ...[['current','üìù','ÌòÑÏû¨'],['stats','üìä','ÌÜµÍ≥Ñ'],['settings','‚öôÔ∏è','ÏÑ§Ï†ï']].map(([k,ic,lb])=>
      h('button',{key:k,onClick:()=>{setTab(k);setShowSearch(false);sSq('');sSqDate('');setShowSortMenu(false)},style:{flex:1,display:'flex',flexDirection:'column',alignItems:'center',gap:1,background:'none',border:'none',cursor:'pointer',padding:'5px 0'}},
        h('span',{style:{fontSize:17}},ic),h('span',{style:{fontSize:9,fontWeight:500,color:tab===k?C.accent:C.text3}},lb)
      )
    )
  );

  // ‚òÖ Wide layout for Fold5
  if(isWide&&tab==='current'&&vm==='list'){
    const hasPast=allArchive.length>0||allPastRecords.length>0;
    // Wide version of daily tasks section - input always on top
    const dtSectionWide=h('div',{style:{background:C.card,borderBottom:'1px solid '+C.border,overflow:'hidden'}},
      h('div',{onClick:()=>setShowDtSection(!showDtSection),style:{display:'flex',alignItems:'center',padding:'7px 14px',cursor:'pointer',background:C.card2,borderBottom:'1px solid '+C.border2}},
        h('span',{style:{fontSize:12,marginRight:6}},'‚òÄÔ∏è'),
        h('span',{style:{fontSize:12,fontWeight:700,color:C.text,flex:1}},'Ïò§Îäò Ìï† Ïùº'),
        todayDTTotal>0?h('span',{style:{fontSize:10,color:C.accent,fontWeight:600,marginRight:6}},todayDTTotal+'Í∞ú'):null,
        h('span',{style:{fontSize:10,color:C.text3,transform:showDtSection?'rotate(90deg)':'rotate(0)',transition:'transform 0.2s'}},'‚ñ∂')
      ),
      showDtSection?h('div',{style:{padding:'6px 14px 8px'}},
        // ‚ë† Add input + Í≥µÏú† ÌÜ†Í∏Ä
        h('div',{style:{display:'flex',gap:4,marginBottom:6}},
          h('input',{type:'text',placeholder:dtShareMode?'üì§ Í≥µÏú† Ïò§Îäò Ìï† Ïùº Ï∂îÍ∞Ä...':'Ïò§Îäò Ìï† Ïùº Ï∂îÍ∞Ä...',value:dtInput,onChange:e=>setDtInput(e.target.value),onKeyDown:e=>e.key==='Enter'&&addDailyTask(),style:{flex:1,padding:'7px 10px',background:dtShareMode?'#3B82F608':C.bg,border:'1px solid '+(dtShareMode?'#3B82F640':C.border),borderRadius:6,color:C.text,fontSize:12,outline:'none'}}),
          h('button',{onClick:addDailyTask,style:{padding:'7px 12px',background:dtShareMode?'#3B82F6':C.accent,color:'#FFF',border:'none',borderRadius:6,fontSize:12,fontWeight:600,cursor:'pointer'}},'+'),
          h('button',{onClick:()=>setDtShareMode(!dtShareMode),title:dtShareMode?'Í≥µÏú† Î™®Îìú ON':'Í≥µÏú† Î™®Îìú OFF',style:{padding:'7px 8px',background:dtShareMode?'#3B82F6':'transparent',border:'1px solid '+(dtShareMode?'#3B82F6':C.border),borderRadius:6,cursor:'pointer',display:'flex',alignItems:'center',justifyContent:'center'}},SharePI({z:15,c:dtShareMode?'#FFF':C.text3}))
        ),
        // ‚ë° Today tasks + Tomorrow in flex row
        h('div',{style:{display:'flex',gap:12,flexWrap:'wrap',alignItems:'flex-start'}},
          // Left: today tasks (Í∞úÏù∏ + üì§Í≥µÏú† + üì•Î∞õÏùÄ)
          h('div',{style:{flex:1,minWidth:200}},
            ...todayDT.map(dt=>h('div',{key:dt.id,style:{display:'flex',alignItems:'center',gap:8,padding:'4px 0',borderBottom:'1px solid '+C.border2}},
              h('button',{onClick:()=>completeDailyTask(dt.id),style:{width:18,height:18,borderRadius:4,border:'2px solid '+C.border,background:'transparent',display:'flex',alignItems:'center',justifyContent:'center',cursor:'pointer',flexShrink:0}},null),
              h('span',{style:{flex:1,fontSize:12,color:C.text}},dt.title),
              h('button',{onClick:()=>delDailyTask(dt.id),style:{background:'none',border:'none',color:C.text3,fontSize:10,cursor:'pointer',padding:'2px 4px',opacity:.5}},'‚úï')
            )),
            ...shDTToday.map(dt=>h('div',{key:'sh_'+dt.id,style:{display:'flex',alignItems:'center',gap:8,padding:'4px 0',borderBottom:'1px solid '+C.border2,background:'#3B82F606'}},
              h('button',{onClick:()=>completeDailyTask(dt.id,'shared'),style:{width:18,height:18,borderRadius:4,border:'2px solid #3B82F650',background:'transparent',display:'flex',alignItems:'center',justifyContent:'center',cursor:'pointer',flexShrink:0}},null),
              h('span',{style:{fontSize:9,color:'#3B82F6',fontWeight:700,flexShrink:0}},'üì§'),
              h('span',{style:{flex:1,fontSize:12,color:C.text}},dt.title),
              h('button',{onClick:()=>delDailyTask(dt.id,'shared'),style:{background:'none',border:'none',color:C.text3,fontSize:10,cursor:'pointer',padding:'2px 4px',opacity:.5}},'‚úï')
            )),
            ...rcvDTToday.map(dt=>h('div',{key:'rcv_'+dt.id,style:{display:'flex',alignItems:'center',gap:8,padding:'4px 0',borderBottom:'1px solid '+C.border2,borderLeft:'3px solid '+rvColor+'30'}},
              h('span',{style:{fontSize:9,color:rvColor,fontWeight:700,flexShrink:0}},'üì•'),
              h('span',{style:{flex:1,fontSize:12,color:C.text}},dt.title),
              dt._owner?h('span',{style:{fontSize:9,color:rvColor,fontWeight:500,flexShrink:0}},dt._owner):null
            )),
            (todayDT.length>0||shDTToday.length>0)?h('button',{onClick:()=>{moveToTomorrow(todayDT,shDTToday)},style:{width:'100%',padding:'5px',marginTop:3,background:'transparent',border:'1px dashed '+C.accent+'50',borderRadius:6,color:C.accent,fontSize:10,fontWeight:600,cursor:'pointer'}},'‚Üí Î™ª Ìïú Ïùº ÎÇ¥ÏùºÎ°ú ÏòÆÍ∏∞Í∏∞ ('+(todayDT.length+shDTToday.length)+'Í∞ú)'):null
          ),
          // Right: tomorrow tasks (Í∞úÏù∏+Í≥µÏú† ÌÜµÌï©)
          allTomorrowDT.length>0?h('div',{style:{flex:1,minWidth:200}},
            h('div',{style:{padding:'6px 8px',background:'#F0EDFF',borderRadius:8}},
              h('div',{style:{display:'flex',alignItems:'center',gap:4,marginBottom:4}},
                h('span',{style:{fontSize:11,fontWeight:700,color:'#6366F1'}},'üìÖ ÎÇ¥Ïùº Ìï† Ïùº'),
                h('span',{style:{fontSize:10,color:'#FFF',background:'#6366F1',padding:'1px 6px',borderRadius:8,fontWeight:700}},allTomorrowDT.length+'Í∞ú')
              ),
              ...allTomorrowDT.map(dt=>h('div',{key:(dt._src==='shared'?'sh_':'')+dt.id,style:{display:'flex',alignItems:'center',gap:6,padding:'3px 0',borderBottom:'1px solid #E0DDFA'}},
                dt._src==='shared'?h('span',{style:{fontSize:9,color:'#3B82F6',fontWeight:700,flexShrink:0}},'üì§'):null,
                h('span',{style:{fontSize:11,color:C.text,flex:1}},dt.title),
                h('button',{onClick:()=>{dt._src==='shared'?moveBackToToday(null,[dt]):moveBackToToday([dt],null)},style:{padding:'3px 8px',background:'#6366F1',color:'#FFF',border:'none',borderRadius:12,fontSize:10,fontWeight:700,cursor:'pointer'}},'‚Üê Ïò§ÎäòÎ°ú')
              )),
              allTomorrowDT.length>1?h('button',{onClick:()=>moveBackToToday(tomorrowDT,shTomorrowDT),style:{width:'100%',padding:'6px',marginTop:4,background:'#6366F1',color:'#FFF',border:'none',borderRadius:7,fontSize:11,fontWeight:700,cursor:'pointer'}},'‚Üê Ï†ÑÏ≤¥ Ïò§ÎäòÎ°ú ÎêòÎèåÎ¶¨Í∏∞'):null
            )
          ):null
        )
      ):null
    );

    return h('div',{style:{...S.root,maxWidth:780}},
      header,searchP,
      yesterdayPrompt,
      tagFilterRow,
      dtSectionWide,
      // ‚ïê‚ïê‚ïê Ï¢åÏö∞ Î∂ÑÌï†: ÏôºÏ™Ω=Í≥ºÍ±∞ | Ïò§Î•∏Ï™Ω=Ìï†Ïùº ‚ïê‚ïê‚ïê
      h('div',{style:{flex:1,display:'flex',overflow:'hidden'}},
        // LEFT: Í≥ºÍ±∞ Î¶¨Ïä§Ìä∏
        h('div',{style:{flex:1,minWidth:0,overflowY:'auto',borderRight:'1px solid '+C.border,paddingBottom:66,WebkitOverflowScrolling:'touch'}},
          h('div',{style:{padding:'6px 14px 4px',background:C.card2,borderBottom:'1px solid '+C.border2,position:'sticky',top:0,zIndex:2}},
            h('span',{style:{fontSize:11,fontWeight:700,color:C.text2}},'‚úÖ Í≥ºÍ±∞'),
            h('span',{style:{fontSize:10,color:C.text3,marginLeft:6}},allArchive.length+'Í∞ú ÏôÑÎ£å'+(allPastRecords.length?' ¬∑ '+allPastRecords.length+'Í∞ú ÏßÄÎÇú Í∏∞Î°ù':''))
          ),
          !hasPast?h('div',{style:{...S.empty,height:'25vh'}},h('div',{style:{fontSize:28,marginBottom:6}},'üìã'),h('div',{style:{fontSize:12,color:C.text2}},'ÏôÑÎ£å Ìï≠Î™© ÏóÜÏùå')):null,
          allPastRecords.length>0?h('div',null,
            h('div',{style:{padding:'6px 14px 2px',fontSize:10,fontWeight:600,color:C.text3,letterSpacing:.5}},'üìã ÏßÄÎÇú Í∏∞Î°ù'),
            ...allPastRecords.map(r=>pastRecEl(r,r._src))
          ):null,
          allArchive.length>0?h('div',null,
            allPastRecords.length>0?h('div',{style:{padding:'6px 14px 2px',fontSize:10,fontWeight:600,color:C.text3,letterSpacing:.5}},'‚úÖ ÏôÑÎ£åÎêú Ìï† Ïùº'):null,
            ...allArchive.map(a=>arcEl(a,a._src))
          ):null
        ),
        // RIGHT: Ìï† Ïùº Î¶¨Ïä§Ìä∏
        h('div',{style:{flex:1,minWidth:0,overflowY:'auto',paddingBottom:66,WebkitOverflowScrolling:'touch'}},
          h('div',{style:{padding:'6px 14px 4px',background:C.card2,borderBottom:'1px solid '+C.border2,position:'sticky',top:0,zIndex:2}},
            h('span',{style:{fontSize:11,fontWeight:700,color:C.text2}},'üìù ÌòÑÏû¨'),
            h('span',{style:{fontSize:10,color:C.text3,marginLeft:6}},allTodos.length+'Í∞ú Ìï† Ïùº'+(allActiveRecords.length?' ¬∑ '+allActiveRecords.length+'Í∞ú Í∏∞Î°ù':''))
          ),
          !unifiedList.length&&!showAdd?h('div',{style:{...S.empty,height:'25vh'}},h('div',{style:{fontSize:28,marginBottom:6}},'‚úì'),h('div',{style:{fontSize:12,color:C.text2}},'Ìï† ÏùºÏù¥ ÏóÜÏäµÎãàÎã§')):null,
          sortMode==='type'&&unifiedList.length>0?h('div',null,
            unifiedList.filter(i=>i.type==='record').length>0?h('div',null,
              h('div',{style:{padding:'6px 14px 2px',fontSize:10,fontWeight:600,color:C.text3,letterSpacing:.5}},'üìã Í∏∞Î°ù ¬∑ '+unifiedList.filter(i=>i.type==='record').length+'Í∞ú'),
              ...unifiedList.filter(i=>i.type==='record').map(renderUnifiedItem)
            ):null,
            unifiedList.filter(i=>i.type==='todo').length>0?h('div',null,
              h('div',{style:{padding:'6px 14px 2px',fontSize:10,fontWeight:600,color:C.text3,letterSpacing:.5}},'üìù Ìï† Ïùº ¬∑ '+unifiedList.filter(i=>i.type==='todo').length+'Í∞ú'),
              ...unifiedList.filter(i=>i.type==='todo').map(renderUnifiedItem)
            ):null
          ):null,
          sortMode!=='type'&&unifiedList.length>0?h('div',null,...unifiedList.map(renderUnifiedItem)):null,
          addF
        )
      ),
      fab,editM,editRM,confirmDialog,toastEl,notiAlertEl,fileInput,drawerEl,wideNav
    );
  }

  return h('div',{style:{...S.root,maxWidth:isWide?780:480}},header,searchP,h('div',{style:S.content},content),fab,editM,editRM,confirmDialog,toastEl,notiAlertEl,fileInput,drawerEl,isWide?wideNav:nav);
}


ReactDOM.createRoot(document.getElementById('root')).render(React.createElement(App));

// ‚ïê‚ïê‚ïê SERVICE WORKER REGISTRATION ‚ïê‚ïê‚ïê
let swRegistration = null;

if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    // Force SW update check (bypass browser cache of sw.js)
    navigator.serviceWorker.register('./sw.js', { updateViaCache: 'none' })
      .then(reg => {
        swRegistration = reg;
        reg.update();
        if (reg.waiting) {
          reg.waiting.postMessage({ type: 'SKIP_WAITING' });
        }
      })
      .catch(()=>{});
  });
}

// ‚ïê‚ïê‚ïê SYNC NOTIFICATIONS TO SERVICE WORKER ‚ïê‚ïê‚ïê
function syncNotificationsToSW() {
  if (!swRegistration || !swRegistration.active) return;
  try {
    const todos = JSON.parse(localStorage.getItem('td4-t') || '[]');
    const shTodos = JSON.parse(localStorage.getItem('td4-st') || '[]');
    const tags = JSON.parse(localStorage.getItem('td4-g') || '[]');
    const notified = JSON.parse(localStorage.getItem('td4-ni') || '[]');
    const now = Date.now();

    const notifications = [];
    [...todos, ...shTodos].forEach(todo => {
      if (!todo.notiOn) return;
      let alertTime, notiKey, lbl;
      if (todo.notiAt) {
        alertTime = new Date(todo.notiAt).getTime();
        notiKey = todo.id + '_at_' + todo.notiAt;
        lbl = 'ÏïåÎ¶º';
      } else {
        const dt = new Date(todo.datetime).getTime();
        const beforeMs = (todo.notiBefore || 30) * 60000;
        alertTime = dt - beforeMs;
        notiKey = todo.id + '_' + todo.notiBefore;
        lbl = todo.notiBefore === 60 ? '1ÏãúÍ∞Ñ Ï†Ñ' : '30Î∂Ñ Ï†Ñ';
      }
      if (alertTime > now - 15000 && !notified.includes(notiKey)) {
        const tg = tags.find(t => t.id === todo.tagId);
        notifications.push({
          todoId: todo.id,
          key: notiKey,
          title: lbl,
          body: todo.title + (tg ? ' [' + tg.name + ']' : ''),
          alertTime: alertTime,
          fired: false
        });
      }
    });

    swRegistration.active.postMessage({
      type: 'SYNC_NOTIFICATIONS',
      notifications: notifications
    });
  } catch (e) {}
}

// Sync every 30 seconds and on visibility change
setInterval(syncNotificationsToSW, 30000);
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'hidden') syncNotificationsToSW();
});
// Initial sync after short delay
setTimeout(syncNotificationsToSW, 3000);

// ‚ïê‚ïê‚ïê PWA INSTALL PROMPT ‚ïê‚ïê‚ïê
let deferredPrompt = null;
window.addEventListener('beforeinstallprompt', e => {
  e.preventDefault();
  deferredPrompt = e;
  // Show custom install button
  const btn = document.createElement('div');
  btn.id = 'pwa-install-bar';
  btn.innerHTML = '<div style="display:flex;align-items:center;justify-content:center;gap:10px;padding:12px 16px;background:linear-gradient(135deg,#C8963E,#D4A84A);color:#FFF;font-family:Noto Sans KR,sans-serif;font-size:13px;font-weight:600;cursor:pointer;position:fixed;bottom:0;left:0;right:0;z-index:999;box-shadow:0 -2px 12px rgba(0,0,0,0.15)"><span>üì± Ïï±ÏúºÎ°ú ÏÑ§ÏπòÌïòÎ©¥ ÏïåÎ¶ºÏùÑ Îçî Ïûò Î∞õÏùÑ Ïàò ÏûàÏñ¥Ïöî</span><span style="background:rgba(255,255,255,0.25);padding:4px 12px;border-radius:20px;font-size:12px">ÏÑ§Ïπò</span></div>';
  document.body.appendChild(btn);
  btn.addEventListener('click', async () => {
    if (!deferredPrompt) return;
    deferredPrompt.prompt();
    const result = await deferredPrompt.userChoice;
    deferredPrompt = null;
    btn.remove();
  });
});

window.addEventListener('appinstalled', () => {
  const bar = document.getElementById('pwa-install-bar');
  if (bar) bar.remove();
  deferredPrompt = null;
});
</script>
</body>
</html>
